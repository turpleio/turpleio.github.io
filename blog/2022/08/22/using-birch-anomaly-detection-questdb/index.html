<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">Using BIRCH for anomaly detection with QuestDB | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="Using BIRCH for anomaly detection with QuestDB | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="How to install BIRCH for anomaly detection with QuestDB"><meta data-react-helmet="true" name="twitter:description" content="How to install BIRCH for anomaly detection with QuestDB"><meta data-react-helmet="true" property="og:description" content="How to install BIRCH for anomaly detection with QuestDB"><meta data-react-helmet="true" name="twitter:title" content="Using BIRCH for anomaly detection with QuestDB | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Using BIRCH for anomaly detection with QuestDB | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" name="keywords" content="birch,anomaly detection,python"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/2022-08-22/banner.png"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/2022-08-22/banner.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">Using BIRCH for anomaly detection with QuestDB</h1><time datetime="2022-08-22T00:00:00.000Z" class="date_A31P">August 22, 2022 · 11 min read</time><div class="avatar margin-vert--md"><a href="https://www.linkedin.com/in/fortune-adekogbe-a81580176/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://dl.airtable.com/.attachments/b724b9a7673c042ba94578be8db94b6f/438d3a79/20210724_135234.jpg?userId=usrLQ2kaNUqxOmv9c" alt="Fortune Adekogbe"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://www.linkedin.com/in/fortune-adekogbe-a81580176/" target="_blank" rel="noopener noreferrer">Fortune Adekogbe</a></h4><small class="avatar__subtitle">Guest post</small></div></div></header><div class="markdown"><figure><img alt="detecting the black sheep" class="image_1-Fc" height="360" src="/img/blog/2022-08-22/banner.png" width="650"></figure><p>In this article, <a href="https://www.linkedin.com/in/fortune-adekogbe-a81580176/" target="_blank" rel="noopener noreferrer">Fortune Adekogbe</a> introduces how to use the BIRCH algorithm for visual clustering, which assists anomaly detection in QuestDB.</p><p>Balanced Iterative Reducing and Clustering using Hierarchies (BIRCH) refers to an unsupervised learning algorithm that is used to group data so that each group contains similar data points. It works well on large datasets because it minimizes the number of passes through the entire dataset, making the process more efficient.</p><p>BIRCH is also used in scikit-learn, the popular Python package that makes machine learning algorithms available for quick and easy use. Scikit-learn contains state-of-the-art implementations of all kinds of algorithms (probabilistic, tree-based, ensemble) that can help you solve supervised (regression, classification) and unsupervised (clustering, anomaly detection) learning-related problems. It offers a range of submodules to help with processing and transforming data before modeling, as well as understanding the results after modeling.</p><p>BIRCH with scikit-learn can be used to solve clustering and anomaly detection-related problems. In this tutorial, you will learn more about BIRCH. You will also learn how to set up and load data into QuestDB and how to implement BIRCH to solve an anomaly detection problem in Python.</p><p>For reference, you can check <a href="https://github.com/Fortune-Adekogbe/birch-anomaly-detection" target="_blank" rel="noopener noreferrer">the GitHub repository</a> for this tutorial.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-is-birch"></a>What is BIRCH?<a class="hash-link" href="#what-is-birch" title="Direct link to heading">#</a></h2><p>The BIRCH algorithm uses a data structure known as a tree to process data and generate clusters. </p><p>The algorithm first takes in a series of (<code>N</code>) data points, which are essentially real-valued vectors. These vectors could be the data directly or the result of a transformation of the original data after pre-processing. The desired number of clusters (<code>K</code>) and threshold are also parsed as optional parameters. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="planting-the-tree"></a>Planting the tree<a class="hash-link" href="#planting-the-tree" title="Direct link to heading">#</a></h3><p>The first part of the algorithm involves building the clustering feature tree. Each cluster feature, as the name implies, is a concise representation of the vectors in any given cluster and is a tuple of three values. In these tuples you have: the number of vectors in the cluster (<code>N&lt;sub&gt;J&lt;/sub&gt;</code>), the sum of all vectors in the cluster (<code>LS</code>), and the sum of the square of all vectors in the cluster (<code>SS</code>). These values help you compute the centroid and radius of the clusters.  </p><p>Taking in data point after data point, you can construct the tree by making sure that higher-level nodes are a summary of the clusters in the lower levels. This means the elements on the lowest level, or the leaf node, contain low diameter clusters. On the next level up, these low diameter clusters (which are summaries of data points) are also summarized into several cluster features. Each node from root to leaf holds several cluster features; this value can be specified as the branching factor. Ultimately, you have several low diameter clusters on the bottom level (leaf nodes) and their condensed representations on higher-level clusters.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="trivializing-the-clustering-process"></a>Trivializing the clustering process<a class="hash-link" href="#trivializing-the-clustering-process" title="Direct link to heading">#</a></h3><p>Next, for each cluster in each leaf node, you compute the centroid by dividing the second element in the cluster feature <code>LS</code> tuple by the first <code>N&lt;sub&gt;J&lt;/sub&gt;</code>. The resulting values are a low dimensional representation of the original dataset. This low dimensional data is then clustered using an agglomerative hierarchical clustering algorithm into K clusters (alternatively, the desired diameter of the clusters can be specified), and the centroid of these new clusters is computed. </p><p>Each data point in the original dataset is checked against these K centroids and gets assigned to the cluster of whichever centroid it is closest to. You can also label points that are too far from their closest cluster as outliers.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="applications-of-birch"></a>Applications of BIRCH<a class="hash-link" href="#applications-of-birch" title="Direct link to heading">#</a></h3><p>BIRCH, which is an unsupervised learning technique, is used to cluster data in groups of similar data points. Doing this allows you to better understand the data distribution and use it to make decisions. Clustering is used in customer segmentation, data labeling, and document analysis, among other use cases. BIRCH is especially useful in clustering because it allows you to efficiently group data points without any explicit knowledge about a target class.  </p><p>BIRCH is also useful in the field of anomaly detection. This involves the identification of data points that deviate from a given norm, do not satisfy some requirements, and are essentially undesired. When you have a lot of data points, you use anomaly detection to identify those that stand out. This is useful in identifying defective products, ensuring predictive maintenance of industrial equipment, and detecting cyber-intrusion and fraud.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementing-birch-and-questdb"></a>Implementing BIRCH and QuestDB<a class="hash-link" href="#implementing-birch-and-questdb" title="Direct link to heading">#</a></h2><p>To better understand BIRCH and how it can be used with QuestDB, you will solve a sample anomaly detection problem. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="setting-up-questdb"></a>Setting up QuestDB<a class="hash-link" href="#setting-up-questdb" title="Direct link to heading">#</a></h3><p>You have several options for installing QuestDB, including Docker and Homebrew. <a href="/docs">Check the documentation</a> for details.</p><p>Once QueestDB is installed, you can access the web console of the running service, by opening your browser and going to <a href="http://localhost:9000" target="_blank" rel="noopener noreferrer">localhost:9000</a>. You should see the below image:</p><figure><img alt="A screenshot of the QuestDB web console." class="image_Pw1y margin_Rc0b shadow_7z-4" height="650" src="/img/blog/2022-08-22/web_console.png" width="770"></figure><p>Now that QuestDB is set up, the next step is getting data into the database.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="importing-data"></a>Importing Data<a class="hash-link" href="#importing-data" title="Direct link to heading">#</a></h3><p>The sample data that will be used is the SKAB data created by <a href="https://www.skoltech.ru/en" target="_blank" rel="noopener noreferrer">Skoltech</a>. It contains eleven attributes that refer to various physical and chemical properties of a testbed. The data can be accessed and downloaded <a href="https://www.kaggle.com/datasets/caesarlupum/benckmark-anomaly-timeseries-skab" target="_blank" rel="noopener noreferrer">here</a>. </p><p>Once it’s downloaded, navigate to the upload page on the QuestDB web console as shown below and select the dataset file.</p><figure><img alt="A screenshot of the QuestDB web console upload section." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2022-08-22/upload.png" width="770"></figure><blockquote><p>Note: There are different ways to import CSV files into QuestDB. For more information, please see <a href="/docs/develop/insert-data">Insert data</a>.</p></blockquote><p>Go back to the home page and refresh the table list to see the data upload reflected. On this page, you can run SQL queries to explore the data.</p><figure><img alt="A screenshot of the QuestDB web console showing uploaded table." class="image_Pw1y margin_Rc0b shadow_7z-4" height="950" src="/img/blog/2022-08-22/alldata_skab.png" width="770"></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="setting-up-python-environment-and-installing-scikit-learn"></a>Setting up Python Environment and Installing Scikit-learn<a class="hash-link" href="#setting-up-python-environment-and-installing-scikit-learn" title="Direct link to heading">#</a></h3><p>Now that the data is set up on QuestDB, create a folder locally and open it in your preferred code editor or IDLE. As should be done with all Python projects, you create and activate a virtual environment named <code>.venv</code> by running the commands below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">python -m venv .venv</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">.venv\Scripts\activate.bat</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>With the environment set up, you can now install the required libraries. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">pip install requests numpy pandas sklearn matplotlib</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>You will be using the requests library to get the data from QuestDB. Then you will need the pandas library to handle and pre-process the data. The scikit-learn library <code>sklearn</code> is needed because it contains an implementation of the BIRCH algorithm and other relevant functions. </p><blockquote><p>Note: Any package used that isn’t installed here is either pre-installed with Python or installed as a dependency of the packages listed above.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="getting-data-from-questdb-via-python"></a>Getting data from QuestDB via Python<a class="hash-link" href="#getting-data-from-questdb-via-python" title="Direct link to heading">#</a></h3><p>Run the following code to get the data: </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> requests</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> pd</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> np</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> json</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">HOST </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;http://localhost:9000&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">execute_query</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">query_sql</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    query_params </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&#x27;query&#x27;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> query_sql</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;fmt&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;json&#x27;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">try</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        response </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">HOST </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;/exec&#x27;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> params</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">query_params</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        json_response </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        skab_df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">json_response</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;dataset&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> columns</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;name&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> json_response</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;columns&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> skab_df</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">except</span><span class="token plain"> KeyError</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">json_response</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;error&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">except</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">exceptions</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RequestException </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string-interpolation string" style="color:#f1fa8c">f&quot;Error: </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">skab_df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> execute_query</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;SELECT * FROM alldata_skab.csv WHERE anomaly IN (&#x27;0.0&#x27;, &#x27;1.0&#x27;);&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In the above code, you import <code>requests</code>, <code>pandas</code>, and <code>json</code> into the script and assign the console web address to a variable named <code>HOST</code> (in this case).</p><p>To get the data into a Python script, a function is created and the requests library is used to access a REST API made available by QuestDB. This is done by creating a function named <code>execute_query</code> that takes in a SQL query as a string and returns a pandas dataframe object. </p><p>In the <code>execute_query</code> function, first you define the request query parameters, which are the SQL query and the desired format <code>fmt</code> of the response. The <code>exec</code> endpoint is added to the <code>HOST</code> URL parsed into the <code>requests.get</code> function alongside the parameters. The text in the response from this request is loaded via the <code>json.loads</code> method as a Python dictionary. </p><p>This dictionary contains two keys that are significant here. The first is the <code>columns</code> and the second is the <code>dataset</code>. The corresponding values of these keys are used to instantiate a pandas dataframe called <code>skab_df</code>. This dataframe is then returned.</p><p>This is all brought together by calling the function and parsing an SQL query into it. This query selects all the data points with anomaly attributes of either <code>’0.0’</code> or <code>’1.0’</code> to avoid null values.</p><p>In case the request was not successful, a try-except statement is used to catch and communicate the error message.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pre-processing-the-data"></a>Pre-processing the data<a class="hash-link" href="#pre-processing-the-data" title="Direct link to heading">#</a></h3><p>Next run these commands: </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">process_data</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">tuple</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">del</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;changepoint&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&#x27;anomaly&#x27;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token string" style="color:#f1fa8c">&#x27;float&#x27;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&#x27;anomaly&#x27;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token string" style="color:#f1fa8c">&#x27;int&#x27;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    df</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">set_index</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&#x27;datetime&#x27;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> inplace</span><span class="token operator" style="color:#ff79c6">=</span><span class="token boolean" style="color:#bd93f9">True</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    anomaly </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;anomaly&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">del</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&#x27;anomaly&#x27;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> anomaly</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">skab_df</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> anomaly </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> process_data</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">skab_df</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">skab_df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ascontiguousarray</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">skab_df</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Even with the earlier mentioned SQL query, the data is not in pristine form for clustering. In the above code, to clean and process the data, you create a function named <code>process_data</code> that takes in the original dataframe and returns a tuple containing the cleaned version and the anomaly attribute.</p><p>You start by removing the <code>changepoint</code> attribute since you will be focusing on the <code>anomaly</code> attribute. Next, you change the data type of the <code>anomaly</code> attribute to <code>int</code> by first changing it to a float. This is because the strings in this case cannot be directly converted into integers. With that done, you set the <code>datetime</code> column as the index, assign the <code>anomaly</code> attribute to a new variable, and remove it from the dataframe.</p><p>The modified dataframe and the anomaly series are then returned as a tuple. To make <code>skab_df</code> <code>C-contiguous</code> and avoid an error, the <code>np.ascontiguousarray</code> method is used.</p><figure><img alt="Modified dataframe and anomaly series." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2022-08-22/modified_dataframe.png" width="770"></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="clustering-and-anomaly-detection"></a>Clustering and anomaly detection<a class="hash-link" href="#clustering-and-anomaly-detection" title="Direct link to heading">#</a></h3><p>Run the following commands: </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> np</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> matplotlib</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">pyplot </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> plt</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">decomposition </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> PCA</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cluster </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> Birch</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> confusion_matrix</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">birch_model </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> Birch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">n_clusters</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> threshold</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">1.5</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">birch_model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">skab_df</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">labels </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> birch_model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">labels_</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">get_labels</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">labels</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">list</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">list</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    l</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">unique</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">labels</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> return_counts</span><span class="token operator" style="color:#ff79c6">=</span><span class="token boolean" style="color:#bd93f9">True</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    mini </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">np</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">argmin</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> np</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i</span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain">mini </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> labels</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&#x27;int64&#x27;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">pred </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> get_labels</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">labels</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>With the processed data, you can now create clusters and detect anomalies. First you import the required modules from <code>sklearn</code> and <code>matplotlib</code>. You define the <code>Birch</code> model parsing in two arguments: the number of clusters as <code>2</code> and the radius threshold as <code>1.5</code>. After this, you fit the model to the data and get the cluster labels using the <code>.labels_</code> method.  </p><p>A function named <code>get_labels</code> is defined, which uses NumPy to get the cluster with the smaller number of data points and assign it the anomaly tag. The resulting modified labels are stored in a variable <code>pred</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">plot_anomaly_distribution</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">labels</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">list</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">None</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    X </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> PCA</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">n_components</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    plt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">scatter</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> X</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">labels</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cmap</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&#x27;rainbow&#x27;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> alpha</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">0.7</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> edgecolors</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&#x27;b&#x27;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    plt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;Anomaly Distribution on SKAB Data using BIRCH&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    plt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">show</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">cm </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> confusion_matrix</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">anomaly</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> pred</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string-interpolation string" style="color:#f1fa8c">f&quot;Anomalies detected: </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">cm</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation number" style="color:#50fa7b">1</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation number" style="color:#50fa7b">1</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation operator" style="color:#ff79c6">/</span><span class="token string-interpolation interpolation builtin" style="color:#bd93f9">sum</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">(</span><span class="token string-interpolation interpolation">cm</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation number" style="color:#50fa7b">1</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">)</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">#plot result</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">plot_anomaly_distribution</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">labels</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> skab_df</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>To better understand the results, a function is created to plot the anomaly distribution in 2D. Since the data is multivariate, principal component analysis (PCA) is used to transform the data and reduce its dimensionality to two. A scatter plot is then created and displayed using these reduced features:</p><figure><img alt="Modified dataframe and anomaly series." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2022-08-22/scatter_plot.png" width="770"></figure><p>In the plot above, red and blue circles represent the detected anomalous data points and the other data points respectively. </p><figure><img alt="Modified dataframe and anomaly series." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2022-08-22/confusion_matrix.png" width="770"></figure><p>A confusion matrix method is also used to assess the performance of the model. It is able to identify 39.9 percent of the anomalies:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>5248</mn><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>7917</mn><mo>+</mo><mn>5248</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.39857</mn></mrow><annotation encoding="application/x-tex">5248/(7917+5248) = 0.39857</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">5</span><span class="mord">2</span><span class="mord">4</span><span class="mord">8</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">7</span><span class="mord">9</span><span class="mord">1</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">5</span><span class="mord">2</span><span class="mord">4</span><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">3</span><span class="mord">9</span><span class="mord">8</span><span class="mord">5</span><span class="mord">7</span></span></span></span></span></div><p>To visualize this as the image shown above, run the following lines of code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> ConfusionMatrixDisplay</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">disp </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> ConfusionMatrixDisplay</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">confusion_matrix</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">cm</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">disp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">plt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">show</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>For improved performance, the data can be pre-processed further and the model parameters can be tuned.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>You should now have a better understanding of the BIRCH algorithm, how it works, and how to implement it for anomaly detection. You have also learned how to set up QuestDB for data storage and to connect it to Python via a REST API. </p><p>You can use this process to more efficiently analyze large datasets in order to optimize machine learning in your data-driven projects. </p><p>To check your work in this tutorial, consult the <a href="https://github.com/Fortune-Adekogbe/birch-anomaly-detection" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/birch">birch</a><a class="margin-horiz--sm" href="/blog/tags/anomaly-detection">anomaly detection</a><a class="margin-horiz--sm" href="/blog/tags/python">python</a><a class="margin-horiz--sm" href="/blog/tags/tutorial">tutorial</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2022/09/12/importing-300k-rows-with-io-uring"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Importing 300k rows/sec with io_uring</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/08/08/questdb-release-6.5"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">QuestDB 6.5 Release - CSV import »</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">문의하기</h3><p class="description_Bwvi">이메일을 입력하시면 소개자료를 보내드립니다.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">보내기</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>인프라관리부터 서비스운영까지 클라우드환경에 최적화된 클라우드 네이티브 플랫폼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright © 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.e53824dd.js" defer="defer"></script>
</body>
</html>