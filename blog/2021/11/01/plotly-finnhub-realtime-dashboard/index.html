<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">Real-time stock price dashboard using QuestDB, Python and Plotly | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="Real-time stock price dashboard using QuestDB, Python and Plotly | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="How to schedule tasks in Python, store stock market data in QuestDB, and create beautiful real-time dashboards using Plotly and Dash."><meta data-react-helmet="true" name="twitter:description" content="How to schedule tasks in Python, store stock market data in QuestDB, and create beautiful real-time dashboards using Plotly and Dash."><meta data-react-helmet="true" property="og:description" content="How to schedule tasks in Python, store stock market data in QuestDB, and create beautiful real-time dashboards using Plotly and Dash."><meta data-react-helmet="true" name="twitter:title" content="Real-time stock price dashboard using QuestDB, Python and Plotly | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Real-time stock price dashboard using QuestDB, Python and Plotly | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" name="keywords" content="timeseries,questdb,python,plotly,stock"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/shared/og-plotly.png"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/shared/og-plotly.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">Real-time stock price dashboard using QuestDB, Python and Plotly</h1><time datetime="2021-11-01T00:00:00.000Z" class="date_A31P">November 1, 2021 · 16 min read</time><div class="avatar margin-vert--md"><a href="https://github.com/gabor-boros" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/gabor-boros" alt="Gábor Boros"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/gabor-boros" target="_blank" rel="noopener noreferrer">Gábor Boros</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><figure><img alt="TimescaleDB logo, QuestDB logo, InfluxDB logo" class="image_1-Fc" height="467" src="/img/blog/2021-11-01/banner.png" width="650"></figure><p>This post comes from Gábor Boros, who has written an excellent tutorial that
shows how to build dashboards using Plotly and QuestDB that track and chart
stock prices in real-time. Thanks for the submission, Gábor!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="why-plotly-and-dash-are-useful-for-real-time-applications"></a>Why Plotly and Dash are useful for real-time applications<a class="hash-link" href="#why-plotly-and-dash-are-useful-for-real-time-applications" title="Direct link to heading">#</a></h2><p>If you&#x27;re working with large amounts of data, efficiently storing raw
information will be your first obstacle. The next challenge is to make sense of
the data utilizing analytics. One of the fastest ways to convey the state of
data is through charts and graphs.</p><p>In this tutorial, we will create a real-time streaming dashboard using QuestDB,
Celery, Redis, Plotly, and Dash. It will be a fun project with excellent charts
to quickly understand the state of a system with beautiful data visualizations.</p><p>Plotly defines itself as &quot;the front end for ML and data science models&quot;, which
describes it really well. Plotly has an &quot;app framework&quot; called Dash which we can
use to create web applications quickly and efficiently. Dash abstracts away the
boilerplate needed to set up a web server and several handlers for it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="project-overview"></a>Project overview<a class="hash-link" href="#project-overview" title="Direct link to heading">#</a></h2><p>The project will be built from two main components:</p><ul><li>a backend that periodically fetches user-defined stock data from
<a href="https://finnhub.io/" target="_blank" rel="noopener noreferrer">Finnhub</a>, and</li><li>a front-end that utilizes Plotly and Dash to visualize the gathered data on
interactive charts</li></ul><p>For this tutorial, you will need some experience in Python and basic SQL
knowledge. We will use Celery backed by Redis as the message broker and QuestDB
as storage to periodically fetch data.</p><p>Let&#x27;s see the prerequisites and jump right in!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="prerequisites"></a>Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h3><ul><li><a href="https://www.python.org/downloads/release/python-380/" target="_blank" rel="noopener noreferrer">Python 3.8</a></li><li><a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">Docker &amp; Docker Compose</a></li><li><a href="https://finnhub.io/" target="_blank" rel="noopener noreferrer">Finnhub</a> account and sandbox API key</li><li>Basic SQL skills</li></ul><p>The source code for this tutorial is available at the corresponding
<a href="https://github.com/gabor-boros/questdb-stock-market-dashboard" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="environment-setup"></a>Environment setup<a class="hash-link" href="#environment-setup" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="create-a-new-project"></a>Create a new project<a class="hash-link" href="#create-a-new-project" title="Direct link to heading">#</a></h3><p>First of all, we are going to create empty directories for our project root and
the Python module:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#8be9fd">mkdir</span><span class="token plain"> -p streaming-dashboard/app</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># streaming-dashboard</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># └── app</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="installing-questdb--redis"></a>Installing QuestDB &amp; Redis<a class="hash-link" href="#installing-questdb--redis" title="Direct link to heading">#</a></h3><p>To install the services required for our project, we are using Docker and Docker
Compose to avoid polluting our host machine. Within the project root, let&#x27;s
create a file, called <code>docker-compose.yml</code>. This file describes all the
necessary requirements the project will use; later on we will extend this file
with other services too.</p><div class="codeBlockContainer_J+bg"><div style="color:#f8f8f2;background-color:#262833" class="codeBlockTitle_oQzk">streaming-dashboard/docker-compose.yml</div><div class="codeBlockContent_csEI yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar codeBlockWithTitle_ZT05"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># docker-compose.yml</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">version</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;3&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">questdb_data</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;redis:latest&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;6379:6379&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">questdb</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;questdb/questdb:latest&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> questdb_data</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">/root/.questdb/db</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;9000:9000&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;8812:8812&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Here we go! When you run <code>docker-compose up</code>, QuestDB and Redis will fire up.
After starting the services, we can access QuestDB&#x27;s interactive console on
<a href="http://127.0.0.1:9000/" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9000</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="create-the-database-table"></a>Create the database table<a class="hash-link" href="#create-the-database-table" title="Direct link to heading">#</a></h3><p>We could create the database table later, but we will take this opportunity and
create the table now since we have already started QuestDB. Connect to QuestDB&#x27;s
interactive console, and run the following SQL statement:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">CREATE TABLE</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      quotes(stock_symbol SYMBOL CAPACITY 5 CACHE INDEX, -- we are in fact just checking 3</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             current_price DOUBLE,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             high_price DOUBLE,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             low_price DOUBLE,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             open_price DOUBLE,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             percent_change DOUBLE,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             tradets TIMESTAMP, -- timestamp of the trade</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">             ts TIMESTAMP)      -- time of insert in our table</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      timestamp(ts)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">PARTITION BY DAY;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>After executing the command, we will see a success message in the bottom left
corner, confirming that the table creation was successful and the table appears
on the right-hand side&#x27;s table list view.</p><figure><img alt="Creating a table using the SQL editor in QuestDB&#x27;s web console" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-01/create_table.png" width="770"></figure><p>Voilà! The table is ready for use.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="creating-workers-using-celery"></a>Creating workers using Celery<a class="hash-link" href="#creating-workers-using-celery" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="define-python-dependencies"></a>Define Python dependencies<a class="hash-link" href="#define-python-dependencies" title="Direct link to heading">#</a></h3><p>As mentioned, our project will have two parts. For now, let&#x27;s focus on the
routine jobs that will fetch the data from Finnhub. As is the case of every
standard Python project, we are using <code>requirements.txt</code> to define the
dependencies the project will use. Place the <code>requirements.txt</code> in your project
root with the content below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">finnhub</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">python</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">2.4</span><span class="token number" style="color:#50fa7b">.14</span><span class="token plain">  </span><span class="token comment" style="color:#6272a4"># The official Finnhub Python client</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">pydantic</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">dotenv</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">1.9</span><span class="token number" style="color:#50fa7b">.2</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4"># We will use Pydantic to create data models</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">celery</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">redis</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">5.2</span><span class="token number" style="color:#50fa7b">.7</span><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># Celery will be the periodic task executor</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">psycopg</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">pool</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">3.1</span><span class="token number" style="color:#50fa7b">.1</span><span class="token plain">  </span><span class="token comment" style="color:#6272a4"># We are using QuestDB&#x27;s PostgreSQL connector</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">dash</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">2.6</span><span class="token number" style="color:#50fa7b">.1</span><span class="token plain">             </span><span class="token comment" style="color:#6272a4"># Dash is used for building data apps</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">pandas</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">1.4</span><span class="token number" style="color:#50fa7b">.3</span><span class="token plain">           </span><span class="token comment" style="color:#6272a4"># Pandas will handle the data frames from QuestDB</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">plotly</span><span class="token operator" style="color:#ff79c6">==</span><span class="token number" style="color:#50fa7b">5.10</span><span class="token number" style="color:#50fa7b">.0</span><span class="token plain">          </span><span class="token comment" style="color:#6272a4"># Plotly will help us with beautiful charts</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We can split the requirements into two logical groups:</p><ol><li>requirements for fetching the data, and</li><li>requirements needed to visualize this data</li></ol><p>For the sake of simplicity, we did not create two separate requirements files,
though in a production environment we would do.</p><p>In order to let the application communicate with QuestDB utilizing the <code>psycopg</code>
client library, we need to install <code>libpq-dev</code> package on our system. To install
it, use your package manager; on Windows, you may need to install PostgreSQL on
your system.</p><p>Then, create a virtualenv and install the dependencies:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ virtualenv -p python3.8 virtualenv</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ </span><span class="token builtin class-name" style="color:#bd93f9">source</span><span class="token plain"> virtualenv/bin/activate</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ pip </span><span class="token function" style="color:#8be9fd">install</span><span class="token plain"> -r requirements.txt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="setting-up-the-db-connection"></a>Setting up the DB connection<a class="hash-link" href="#setting-up-the-db-connection" title="Direct link to heading">#</a></h3><p>Since the periodic tasks would need to store the fetched quotes, we need to
connect to QuestDB. Therefore, we create a new file in the <code>app</code> package, called
<code>db.py</code>. This file contains the PostgreSQL connection pool that will serve as the
base for our connections.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># app/db.py</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> psycopg_pool </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> ConnectionPool</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">settings </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> settings</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">pool </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> ConnectionPool</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">database_url</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    min_size</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    max_size</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">database_pool_size</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="define-the-worker-settings"></a>Define the worker settings<a class="hash-link" href="#define-the-worker-settings" title="Direct link to heading">#</a></h3><p>Before we jump right into the implementation, we must configure Celery. To
create a configuration used by both the workers and the dashboard, create a
<code>settings.py</code> file in the <code>app</code> package. We will use <code>pydantic</code>&#x27;s <code>BaseSettings</code>
to define the configuration. This helps us to read the settings from a <code>.env</code>
file, environment variable, and prefix them if needed.</p><p>Ensuring that we do not overwrite any other environment variables, we will set
the prefix to <code>SMD</code> that stands for &quot;stock market dashboard&quot;, our application.
Below you can see the settings file:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># app/settings.py</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> List</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> pydantic </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> BaseSettings</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">class</span><span class="token plain"> </span><span class="token class-name">Settings</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">BaseSettings</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#f1fa8c">&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    Settings of the application, used by workers and dashboard.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># Celery settings</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    celery_broker</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;redis://127.0.0.1:6379/0&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># Database settings</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    database_url</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;postgresql://admin:quest@127.0.0.1:8812/qdb&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    database_pool_size</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">int</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">3</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># Finnhub settings</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    api_key</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    frequency</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">int</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">5</span><span class="token plain">  </span><span class="token comment" style="color:#6272a4"># default stock data fetch frequency in seconds</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    symbols</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token builtin" style="color:#bd93f9">str</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">list</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># Dash/Plotly</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    debug</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">bool</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">True</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    graph_interval</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">int</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">10</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">class</span><span class="token plain"> </span><span class="token class-name">Config</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#f1fa8c">&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">        Meta configuration of the settings parser.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">        &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        env_file </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;.env&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4"># Prefix the environment variable not to mix up with other variables</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4"># used by the OS or other software.</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        env_prefix </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;SMD_&quot;</span><span class="token plain">  </span><span class="token comment" style="color:#6272a4"># SMD stands for Stock Market Dashboard</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">settings </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> Settings</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In the settings, you can notice we already defined the <code>celery_broker</code> and
<code>database_url</code> settings with unusual default values.</p><p>Some bits are missing at the moment. We still have to define the correct
settings and run the worker in a Docker container. To keep our environment
separated, we will use a <code>.env</code> file. One of the most significant advantages for
<code>pydantic</code> settings is that it can read environment variables from <code>.env</code> files.</p><p>Let&#x27;s create a <code>.env</code> file in the project root, next to <code>docker-compose.yml</code>, so
your project structure should look like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── app</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── __init__.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── db.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── settings.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── worker.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── .env</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── docker-compose.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Add the following content to the <code>.env</code> file:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><div tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">SMD_API_KEY </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&lt;YOUR SANDBOX API KEY&gt;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">SMD_FREQUENCY </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">10</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">SMD_SYMBOLS </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&quot;AAPL&quot;</span><span class="token plain">,</span><span class="token string" style="color:#f1fa8c">&quot;DOCN&quot;</span><span class="token plain">,</span><span class="token string" style="color:#f1fa8c">&quot;EBAY&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>As you may assume, you will need to get your API key for the sandbox environment
at this step. To retrieve the key, the only thing you have to do is sign up to
Finnhub, and your API key will appear on the dashboard after login.</p><figure><img alt="Two API keys from the Finnhub platform used in a demo application" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-01/finnhub_api_key.png" width="770"></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="create-the-periodic-task"></a>Create the periodic task<a class="hash-link" href="#create-the-periodic-task" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># app/worker.py</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> finnhub</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> celery </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> Celery</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">db </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> pool</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">settings </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> settings</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">client </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> finnhub</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">api_key</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">api_key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">celery_app </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> Celery</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">broker</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">celery_broker</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#f8f8f2">@celery_app</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">on_after_configure</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">connect</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">setup_periodic_tasks</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#f1fa8c">&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    Set up a periodic task for every symbol defined in the settings.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> symbol </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">symbols</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        sender</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">add_periodic_task</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">frequency</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> fetch</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">s</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#f8f8f2">@celery_app</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">task</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">fetch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#f1fa8c">&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    Fetch the stock info for a given symbol from Finnhub and load it into QuestDB.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    quote</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">dict</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">quote</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># https://finnhub.io/docs/api/quote</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># quote = {&#x27;c&#x27;: 148.96, &#x27;d&#x27;: -0.84, &#x27;dp&#x27;: -0.5607, &#x27;h&#x27;: 149.7, &#x27;l&#x27;: 147.8, &#x27;o&#x27;: 148.985, &#x27;pc&#x27;: 149.8, &#x27;t&#x27;: 1635796803}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># c: Current price</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># d: Change</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># dp: Percent change</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># h: High price of the day</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># l: Low price of the day</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># o: Open price of the day</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># pc: Previous close price</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># t: when it was traded</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    query </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#f1fa8c">f&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    INSERT INTO quotes(stock_symbol, current_price, high_price, low_price, open_price, percent_change, tradets, ts)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    VALUES(</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        &#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">symbol</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&#x27;,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;c&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;h&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;l&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;o&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;pc&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;t&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c"> * 1000000,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        systimestamp()</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    );</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">with</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">connection</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        conn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Going through the code above:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> finnhub</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> celery </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> Celery</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">db </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> pool</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">settings </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> settings</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In the first few lines, we import the requirements that are needed to fetch and
store the data.</p><p>After importing the requirements, we configure the Finnhub client and Celery to
use the Redis broker we defined in the application settings.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">client </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> finnhub</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">api_key</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">api_key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">celery_app </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> Celery</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">broker</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">celery_broker</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>To fetch the data periodically per stock symbol, we need to programmatically
create a periodic task for every symbol we defined in the settings.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#f8f8f2">@celery_app</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">on_after_configure</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">connect</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">setup_periodic_tasks</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#f1fa8c">&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    Set up a periodic task for every symbol defined in the settings.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> symbol </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">symbols</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        sender</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">add_periodic_task</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">frequency</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> fetch</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">s</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The snippet above will register a new periodic per stock symbol after Celery is
connected to the broker.</p><p>The last step is to define the <code>fetch</code> task that does the majority of the work.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#f8f8f2">@celery_app</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">task</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">fetch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#f1fa8c">&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    Fetch the stock info for a given symbol from Finnhub and load it into QuestDB.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token triple-quoted-string string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    quote</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">dict</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">quote</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># https://finnhub.io/docs/api/quote</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># quote = {&#x27;c&#x27;: 148.96, &#x27;d&#x27;: -0.84, &#x27;dp&#x27;: -0.5607, &#x27;h&#x27;: 149.7, &#x27;l&#x27;: 147.8, &#x27;o&#x27;: 148.985, &#x27;pc&#x27;: 149.8, &#x27;t&#x27;: 1635796803}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># c: Current price</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># d: Change</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># dp: Percent change</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># h: High price of the day</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># l: Low price of the day</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># o: Open price of the day</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># pc: Previous close price</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4"># t: when it was traded</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    query </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#f1fa8c">f&quot;&quot;&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    INSERT INTO quotes(stock_symbol, current_price, high_price, low_price, open_price, percent_change, tradets, ts)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    VALUES(</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        &#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">symbol</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&#x27;,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;c&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;h&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;l&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;o&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;pc&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">quote</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">[</span><span class="token string-interpolation interpolation string" style="color:#f1fa8c">&quot;t&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">]</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c"> * 1000000,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">        systimestamp()</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    );</span></div><div class="token-line" style="color:#f8f8f2"><span class="token string-interpolation string" style="color:#f1fa8c">    &quot;&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">with</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">connection</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        conn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Using the Finnhub <code>client</code>, we get a quote for the given symbol. After the quote
is retrieved successfully, we prepare a SQL query to insert the quote into the
database. At the end of the function, as the last step, we open a connection to
QuestDB and insert the new quote.</p><p>Congratulations! The worker is ready for use; let&#x27;s try it out!</p><p>Execute the command below in a new terminal window within the virtualenv, and
wait some seconds to let Celery kick in:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">python -m celery --app app.worker.celery_app worker --beat -l info -c </span><span class="token number" style="color:#50fa7b">1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Soon, you will see that the tasks are scheduled, and the database is slowly
filling.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="checking-in-on-what-weve-built-so-far"></a>Checking in on what we&#x27;ve built so far<a class="hash-link" href="#checking-in-on-what-weve-built-so-far" title="Direct link to heading">#</a></h3><p>Before proceeding to the visualization steps, let&#x27;s have a look at what we have
built so far:</p><ol><li>we created the project root</li><li>a <code>docker-compose.yml</code> file to manage related services</li><li><code>app/settings.py</code> that handles our application configuration</li><li><code>app/db.py</code> configuring the database pool, and</li><li>last but not least, <code>app/worker.py</code> that handles the hard work, fetches, and
stores the data.</li></ol><p>At this point, we should have the following project structure:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI txt"><div tabindex="0" class="prism-code language-txt codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── app</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── __init__.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── db.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── settings.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── worker.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── .env</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">└── docker-compose.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="visualizing-data-with-plotly-and-dash"></a>Visualizing data with Plotly and Dash<a class="hash-link" href="#visualizing-data-with-plotly-and-dash" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="getting-static-assets"></a>Getting static assets<a class="hash-link" href="#getting-static-assets" title="Direct link to heading">#</a></h3><p>This tutorial is not about writing the necessary style sheets or collecting
static assets, so you only need to copy-paste some code. As the first step,
create an <code>assets</code> directory next to the <code>app</code> package with the structure below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI txt"><div tabindex="0" class="prism-code language-txt codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── app</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── __init__.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── db.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── settings.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── worker.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── assets</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│── .env</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">└── docker-compose.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The <code>style.css</code> will define the styling for our application. As mentioned above,
Dash will save us from boilerplate code, so the <code>assets</code> directory will be used
by default in conjunction with the stylesheet in it.</p><p>Download the <code>style.css</code> file to the <code>assets</code> directory, this can be done using
<code>curl</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">curl </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">s </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">Lo </span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">assets</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">style</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">css https</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token operator" style="color:#ff79c6">//</span><span class="token plain">raw</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">githubusercontent</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">com</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">gabor</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">boros</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">questdb</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">stock</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">market</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">dashboard</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">main</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">assets</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">style</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">css</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="setting-up-the-application"></a>Setting up the application<a class="hash-link" href="#setting-up-the-application" title="Direct link to heading">#</a></h3><p>This is the most interesting part of the tutorial. We are going to visualize the
data we collect. Create a <code>main.py</code> file in the <code>app</code> package, and let&#x27;s begin
with the imports:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># app/main.py</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> datetime </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> timedelta</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> dash</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> pandas</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> dash </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> dcc</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> html</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> dash</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">dependencies </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> Input</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> Output</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> plotly </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> graph_objects</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">db </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> pool</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">settings </span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> settings</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>After having the imports in place, we are defining some helper functions and
constants.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">GRAPH_INTERVAL </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">graph_interval </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1000</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">TIME_DELTA </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">5</span><span class="token plain">  </span><span class="token comment" style="color:#6272a4"># last T hours of data are looked into as per insert time</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">COLORS </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;#1e88e5&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;#7cb342&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;#fbc02d&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;#ab47bc&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;#26a69a&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;#5d8aa8&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">utcnow</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">get_stock_data</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> end</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> stock_symbol</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">format_date</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dt</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">str</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> dt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">isoformat</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">timespec</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;microseconds&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;Z&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    query </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#f1fa8c">f&quot;SELECT * FROM quotes WHERE ts BETWEEN &#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">format_date</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">(</span><span class="token string-interpolation interpolation">start</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">)</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&#x27; AND &#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">format_date</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">(</span><span class="token string-interpolation interpolation">end</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">)</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&#x27;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> stock_symbol</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        query </span><span class="token operator" style="color:#ff79c6">+=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#f1fa8c">f&quot; AND stock_symbol = &#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">{</span><span class="token string-interpolation interpolation">stock_symbol</span><span class="token string-interpolation interpolation punctuation" style="color:#f8f8f2">}</span><span class="token string-interpolation string" style="color:#f1fa8c">&#x27; &quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">with</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">connection</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">as</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> pandas</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">read_sql_query</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In the first few lines, we define constants for setting a graph update frequency
(<code>GRAPH_INTERVAL</code>) and colors that will be used for coloring the graph
(<code>COLORS</code>).</p><p>After that, we define two helper functions, <code>now</code> and <code>get_stock_data</code>. While
<code>now</code> is responsible only for getting the current time in UTC (as Finnhub
returns the date in UTC too), the <code>get_stock_data</code> does more. It is the core of
our front-end application, it fetches the stock data from QuestDB that workers
inserted.</p><p>Define the initial data frame and the application:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> get_stock_data</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> timedelta</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hours</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">TIME_DELTA</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">app </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> dash</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Dash</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    __name__</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    title</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;Real-time stock market changes&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    assets_folder</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;../assets&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    meta_tags</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;name&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;viewport&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;content&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;width=device-width, initial-scale=1&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>As you can see above, the initial data frame (<code>df</code>) will contain the latest 5
hours of data we have. This is needed to pre-populate the application with some
data we have. The application definition <code>app</code> describes the application&#x27;s
title, asset folder, and some HTML meta tags used during rendering.</p><p>Create the application layout that will be rendered as HTML. We won&#x27;t write
HTML, we will use Dash&#x27;s helpers for that:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">layout </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">H4</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;Stock market changes&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__header__title&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">P</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token string" style="color:#f1fa8c">&quot;Continually query QuestDB and display live changes of the specified stocks.&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                            className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__header__subtitle&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__header__desc&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__header&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">P</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;Select a stock symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                dcc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Dropdown</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token builtin" style="color:#bd93f9">id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;stock-symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    searchable</span><span class="token operator" style="color:#ff79c6">=</span><span class="token boolean" style="color:#bd93f9">True</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    options</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;label&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> symbol</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;value&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> symbol</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> symbol </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> df</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&quot;stock_symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">unique</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__selector&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">H6</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;Current price changes&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;graph__title&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        dcc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token builtin" style="color:#bd93f9">id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;one-half column&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Div</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                            </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">html</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">H6</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;Percent changes&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;graph__title&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                        dcc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Graph</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token builtin" style="color:#bd93f9">id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph-percent-change&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;one-half column&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__content&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        dcc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Interval</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token builtin" style="color:#bd93f9">id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph-update&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            interval</span><span class="token operator" style="color:#ff79c6">=</span><span class="token builtin" style="color:#bd93f9">int</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">GRAPH_INTERVAL</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            n_intervals</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    className</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;app__container&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>This snippet is a bit longer, though it has only one interesting part,
<code>dcc.Interval</code>. The interval is used to set up periodic graph refresh.</p><p>We are nearly finished with our application, but the last steps are to define
two callbacks that will listen to input changes and the interval discussed
above. The first callback is for generating the graph data and rendering the
lines per stock symbol.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#f8f8f2">@app</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">callback</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Output</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;figure&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">Input</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;stock-symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;value&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> Input</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph-update&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;n_intervals&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">generate_stock_graph</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">selected_symbol</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    data </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    filtered_df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> get_stock_data</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> timedelta</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hours</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">TIME_DELTA</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> selected_symbol</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    groups </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> filtered_df</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">groupby</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">by</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;stock_symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> group</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> data_frame </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        data_frame </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> data_frame</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">sort_values</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">by</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&quot;ts&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        trace </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> graph_objects</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Scatter</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            x</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">data_frame</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ts</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            y</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">data_frame</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            marker</span><span class="token operator" style="color:#ff79c6">=</span><span class="token builtin" style="color:#bd93f9">dict</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">color</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">COLORS</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token builtin" style="color:#bd93f9">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            name</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">group</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        data</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    layout </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> graph_objects</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Layout</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        xaxis</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;title&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;Time&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        yaxis</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;title&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;Price&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        margin</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;l&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;b&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;t&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;r&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        hovermode</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;closest&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        plot_bgcolor</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;#282a36&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        paper_bgcolor</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;#282a36&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        font</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;color&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;#aaa&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    figure </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> graph_objects</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Figure</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> layout</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">layout</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> figure</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The other callback is very similar to the previous one; it will be responsible
for updating the percentage change representation of the stocks or a given
stock.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#f8f8f2">@app</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">.</span><span class="token decorator annotation punctuation" style="color:#f8f8f2">callback</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Output</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph-percent-change&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;figure&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Input</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;stock-symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;value&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Input</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;stock-graph-update&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;n_intervals&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">generate_stock_graph_percentage</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">selected_symbol</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    data </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    filtered_df </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> get_stock_data</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> timedelta</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hours</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">TIME_DELTA</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> selected_symbol</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    groups </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> filtered_df</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">groupby</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">by</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;stock_symbol&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> group</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> data_frame </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> groups</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        data_frame </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> data_frame</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">sort_values</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">by</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token string" style="color:#f1fa8c">&quot;ts&quot;</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        trace </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> graph_objects</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Scatter</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            x</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">data_frame</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ts</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            y</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">data_frame</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">percent_change</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            marker</span><span class="token operator" style="color:#ff79c6">=</span><span class="token builtin" style="color:#bd93f9">dict</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">color</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">COLORS</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token builtin" style="color:#bd93f9">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            name</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">group</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        data</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    layout </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> graph_objects</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Layout</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        xaxis</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;title&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;Time&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        yaxis</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;title&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;Percent change&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        margin</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;l&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;b&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;t&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;r&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">70</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        hovermode</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;closest&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        plot_bgcolor</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;#282a36&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        paper_bgcolor</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;#282a36&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        font</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;color&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;#aaa&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    figure </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> graph_objects</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Figure</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> layout</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">layout</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> figure</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The last step is to call <code>run_server</code> on the <code>app</code> object when the script is
called from the CLI.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># [...]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    app</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">run_server</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">host</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&quot;0.0.0.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> debug</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We are now ready to try our application with actual data. Make sure that the
Docker containers are started and execute <code>PYTHONPATH=. python app/main.py</code> from
the project root:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ </span><span class="token assign-left variable" style="color:#ff79c6">PYTHONPATH</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">. python app/main.py</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Dash is running on http://0.0.0.0:8050/</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"> * Tip: There are </span><span class="token variable" style="color:#ff79c6">`</span><span class="token variable" style="color:#ff79c6">.env</span><span class="token variable" style="color:#ff79c6">`</span><span class="token plain"> or </span><span class="token variable" style="color:#ff79c6">`</span><span class="token variable" style="color:#ff79c6">.flaskenv</span><span class="token variable" style="color:#ff79c6">`</span><span class="token plain"> files present. Do </span><span class="token string" style="color:#f1fa8c">&quot;pip install python-dotenv&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   to use them.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"> * Serving Flask app </span><span class="token string" style="color:#f1fa8c">&#x27;main&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">lazy loading</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"> * Environment: production</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   WARNING: This is a development server. Do not use it </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> a production deployment.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   Use a production WSGI server instead.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"> * Debug mode: off</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"> * Running on all addresses.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   WARNING: This is a development server. Do not use it </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> a production deployment.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"> * Running on http://192.168.0.14:8050/ </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Press CTRL+C to quit</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Navigate to <a href="http://127.0.0.1:8050/" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8050/</a>, to see the application in action.</p><figure><img alt="A chart built using Plotly showing real-time market data from multiple tickers" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-01/stock_market_plot.png" width="770"></figure><p>To select only one stock, in the dropdown field choose the desired stock symbol
and let the application refresh.</p><figure><img alt="A chart built using Plotly showing real-time market data from a single ticker" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-01/choosing_ticker_symbol.png" width="770"></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>In this tutorial, we&#x27;ve learned how to schedule tasks in Python, store data in
QuestDB, and create beautiful dashboards using Plotly and Dash. Although we
won&#x27;t start trading just right now; this tutorial demonstrated well how to
combine these separately powerful tools and software to create something bigger
and more useful. Thank you for your attention!</p><hr><p>If you like this content, we&#x27;d love to know your thoughts! Feel free to share
your feedback or come and say hello in the
<a href="https://" target="_blank" rel="noopener noreferrer">QuestDB Community Slack</a>.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/tutorial">tutorial</a><a class="margin-horiz--sm" href="/blog/tags/python">python</a><a class="margin-horiz--sm" href="/blog/tags/market-data">market data</a><a class="margin-horiz--sm" href="/blog/tags/plotly">plotly</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/11/03/interthread"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« How we built inter-thread messaging from scratch</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/10/04/geospatial-timeseries-demo"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Demo geospatial and timeseries queries on 250k unique devices »</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">문의하기</h3><p class="description_Bwvi">이메일을 입력하시면 소개자료를 보내드립니다.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">보내기</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>인프라관리부터 서비스운영까지 클라우드환경에 최적화된 클라우드 네이티브 플랫폼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright © 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.202cfa5e.js" defer="defer"></script>
</body>
</html>