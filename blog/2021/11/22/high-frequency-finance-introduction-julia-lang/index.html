<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">A tour of high-frequency finance via the Julia language and QuestDB | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="A tour of high-frequency finance via the Julia language and QuestDB | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="Dean Markwick describes high-frequency finance concepts such as trade prices, financial returns, time series autocorrelation, empirical price impact and others via the Julia programming language."><meta data-react-helmet="true" name="twitter:description" content="Dean Markwick describes high-frequency finance concepts such as trade prices, financial returns, time series autocorrelation, empirical price impact and others via the Julia programming language."><meta data-react-helmet="true" property="og:description" content="Dean Markwick describes high-frequency finance concepts such as trade prices, financial returns, time series autocorrelation, empirical price impact and others via the Julia programming language."><meta data-react-helmet="true" name="twitter:title" content="A tour of high-frequency finance via the Julia language and QuestDB | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;A tour of high-frequency finance via the Julia language and QuestDB | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" name="keywords" content="timeseries,julialang,trading,marketdata"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/shared/og-julia.png"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/shared/og-julia.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">A tour of high-frequency finance via the Julia language and QuestDB</h1><time datetime="2021-11-22T00:00:00.000Z" class="date_A31P">November 22, 2021 · 20 min read</time><div class="avatar margin-vert--md"><a href="https://github.com/dm13450" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/dm13450" alt="Dean Markwick"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/dm13450" target="_blank" rel="noopener noreferrer">Dean Markwick</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><figure><img alt="The QuestDB logo, and the Julia programming language logo." class="image_1-Fc" height="467" src="/img/blog/2021-11-22/banner.png" width="650"></figure><p>This post comes from Dean Markwick, who has written an excellent tutorial that
provides an introduction to high frequency time series using the Julia
programming language and covers commonly-used techniques for constructing
trading models of financial assets. Thanks for the submission, Dean!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="whats-the-difference-between-finance-and-high-frequency-finance"></a>What&#x27;s the difference between finance and high-frequency finance?<a class="hash-link" href="#whats-the-difference-between-finance-and-high-frequency-finance" title="Direct link to heading">#</a></h2><p>I like to think of this question as taking a microscope to finance data and
magnifying everything up to see the nitty-gritty. Most people start by
downloading daily stock prices from something like Yahoo or Google finance. For
some applications, this type of data is enough if you are looking at long-term
trends or say differences between countries, but a whole other world is lurking
underneath those four daily prices.</p><p>In the not-so-distant past, getting your hands on more granular data was either
expensive or out of reach to the hobbyist, but there has since been a revolution
thanks to crypto. Now, many crypto exchanges provide their data for free and
this combined with some excellent open-source (and free) tools allow you to
build your own little high-frequency research labs.</p><p>This tutorial will hold your hand and introduce you to the concepts of
high-frequency finance and what makes it different. If you are finance-curious
this is the tutorial for you and with Julia and QuestDB I will highlight some of
the basic concepts behind modern data-driven finance.</p><p>This tutorial is broken down into the following sections:</p><ol><li><strong>The dataset:</strong> what kind of data are we working with?</li><li><strong>Prices:</strong> what does a high-frequency price source look like?</li><li><strong>Returns:</strong> how do we prepare the data for analysis and how are the returns
distributed?</li><li><strong>Correlations:</strong> what does the correlation look like between returns?</li><li><strong>Trades:</strong> how can we measure price impact using high-frequency trades?</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="creating-a-dataset-of-crypto-trades-from-coinbase"></a>Creating a dataset of crypto trades from Coinbase<a class="hash-link" href="#creating-a-dataset-of-crypto-trades-from-coinbase" title="Direct link to heading">#</a></h2><p>I&#x27;ve written about hooking up to the Coinbase API and storing the results in
QuestDB. It&#x27;s a technical post and you can
<a href="/blog/2021/09/17/high-frequency-finance-julia-lang">read the tutorial here</a>.
By using the same process as highlighted in that post, I have stored Bitcoin-USD
exchange rate data and trade data from 09:00 on the 24th of July 2021 to 14:30
on the 25th of July 2021.</p><p>All the data comes from Coinbase, one of the largest crypto exchanges, and gives
a good picture of what the market looks like. We will be using both the price
data and the trade data to perform our analysis.</p><p>For convenience, these datasets are made available on S3 and can be loaded into
a running QuestDB instance using the REST API:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><div tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># Download the example data</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> https://s3.eu-west-1.amazonaws.com/questdb.io/datasets/hff-tutorial/prices.csv --output prices.csv</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> https://s3.eu-west-1.amazonaws.com/questdb.io/datasets/hff-tutorial/trades.csv --output trades.csv</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># Import prices</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> -F </span><span class="token assign-left variable" style="color:#ff79c6">schema</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&#x27;[{&quot;name&quot;:&quot;timestamp&quot;, &quot;type&quot;: &quot;TIMESTAMP&quot;, &quot;pattern&quot;: &quot;yyyy-MM-ddTHH:mm:ss.SSS&quot;}]&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     -F </span><span class="token assign-left variable" style="color:#ff79c6">data</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">@prices.csv </span><span class="token string" style="color:#f1fa8c">&#x27;http://localhost:9000/imp?&amp;timestamp=timestamp&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># Import trades</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> -F </span><span class="token assign-left variable" style="color:#ff79c6">schema</span><span class="token operator" style="color:#ff79c6">=</span><span class="token string" style="color:#f1fa8c">&#x27;[{&quot;name&quot;:&quot;timestamp&quot;, &quot;type&quot;: &quot;TIMESTAMP&quot;, &quot;pattern&quot;: &quot;yyyy-MM-ddTHH:mm:ss.SSS&quot;}]&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     -F </span><span class="token assign-left variable" style="color:#ff79c6">data</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">@trades.csv </span><span class="token string" style="color:#f1fa8c">&#x27;http://localhost:9000/imp?&amp;timestamp=timestamp&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="understanding-high-frequency-prices"></a>Understanding high frequency prices<a class="hash-link" href="#understanding-high-frequency-prices" title="Direct link to heading">#</a></h2><p>If we go to Yahoo finance and look at the
<a href="https://uk.finance.yahoo.com/quote/AAPL/history?p=AAPL" target="_blank" rel="noopener noreferrer">historical data of Apple</a>
you can see <strong>open</strong>, <strong>high</strong>, <strong>low</strong>, and <strong>close</strong> prices. Each represents a
different value of the stock price at a different time, and gives us an idea of
how the price moved throughout the day.</p><p>High-frequency finance is different from this as there is not one price, but two
different prices:</p><ul><li>The <strong>bid</strong> price that represents how much you will pay if you are buying.</li><li>The <strong>ask</strong> price, that represents how much you will receive if you are
selling.</li></ul><p>We can plot a small snapshot of the bid and ask prices to see how they change.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">ticks = minimum(exampleData.timestamp):Millisecond(10):maximum(exampleData.timestamp)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">tick_labels = Dates.format.(ticks, &quot;HH:MM:SS.sss&quot;)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">examplePlot = plot(exampleData.timestamp, exampleData.bid,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                   label = &quot;Bid&quot;, seriestype=:steppre,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                   markershape = :circle, markercolor = :auto,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                   xticks = (ticks, tick_labels), legend=:bottomleft)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">examplePlot = plot!(examplePlot, exampleData.timestamp, exampleData.ask,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    label = &quot;Ask&quot;, seriestype = :steppre,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                    markershape = :circle, markercolour = :auto)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><figure><img alt="Apple stock bid and ask prices plotted on a chart" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/example_bidask.png" width="650"></figure><p>In the space of 30 milliseconds, we can see 8 updates, each shown as a point on
this graph. There are a two things to note from this chart:</p><ol><li><p>There are irregular spacing between the updates because times at which the
prices update are random.</p></li><li><p>The <strong>bid</strong> or <strong>ask</strong> can change independently. Both the bid and ask can
change when they want and not always at the same time.</p></li></ol><p>So why does the Yahoo daily data only refer to one price? The Yahoo data is
ignoring that you buy and sell at different prices but instead reporting the
<em>mid-price</em>.</p><p>The <strong>mid-price</strong> is the average of the bid and ask and thus incorporates
changes in both the bid and ask price. At low-frequency levels (like Yahoo
Finance), the difference in bid and ask is so small it doesn&#x27;t make a
difference. But at a high-frequency level, you need to be aware of how it is
calculated and how changes based on the bid and ask price changes.</p><p>We can add the mid-price into the above plot and again note some interesting
results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">exampleData = @transform(exampleData, mid = (:ask .+ :bid) /2)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">plot!(examplePlot, exampleData.timestamp, exampleData.mid, label = &quot;Mid&quot;,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      seriestype = :steppre, linecolour = :auto)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><figure><img alt="Apple stock bid, ask, and mid price plotted on a chart" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/example_bidask_mid.png" width="650"></figure><p>In this short window of time, we now have three unique mid prices, but only two
actual prices you can trade at. At <code>08:50:54.052</code>, the mid-price drops because
of the drop in the bid price. The ask price remained the same for another 6
updates.</p><p>The mid-price responds to changes in both the bid and ask and can obscure what
is happening behind the data. The mid-price might change, but that doesn&#x27;t mean
both the price you buy and sell at has changed.</p><p>Low-frequency historical data (like Yahoo finance) is good for a general sign of
the stock price, but ultimately, the underlying data is different. There is a
whole world of interaction behind those <strong>high</strong>, <strong>low</strong>, <strong>open</strong>, and
<strong>close</strong> prices. Hopefully, this has piqued your interest and you can see why
we need to the specific term <em>high-frequency finance</em> to study this new type of
data.</p><p>Now, I&#x27;m making a song and dance how the mid-price doesn&#x27;t exist and there isn&#x27;t
one singular price at each time, but we find in most cases the mid-price is good
enough for the type of analysis we are about to do. Now by using our original
table <code>coinbase_bbo</code> we need to add in the mid-price. We need to create a new
table with this calculated variable.</p><div class="codeBlockContainer_J+bg"><div style="color:#f8f8f2;background-color:#262833" class="codeBlockTitle_oQzk">Creating a mid price table in QuestDB</div><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar codeBlockWithTitle_ZT05"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">execute(conn,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">&quot;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">CREATE TABLE mid_table</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">AS(</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    SELECT timestamp, ask, asksize, bid, bidsize,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    (ask + bid) / 2 as mid,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    (asksize * ask + bidsize * bid) /(asksize + bidsize) as wmid</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    FROM coinbase_bbo)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>This is still the same number of rows though, as we want to aggregate the
mid-price to one-second intervals by taking the average value in that bucket. We
are losing the &#x27;irregularity&#x27; of high-frequency data, but as we saw in the
example graph, 1 second is still a high enough fidelity to see some interesting
things.</p><p>This is where we use the <code>SAMPLE BY</code> function of QuestDB. This allows you to
choose a period of time and aggregate the data into a bucket of that size. In
our case <code>1s</code> - so 1 second. We calculate the average mid-price over one second
and call that column <code>avg_mid</code>.</p><div class="codeBlockContainer_J+bg"><div style="color:#f8f8f2;background-color:#262833" class="codeBlockTitle_oQzk">Sample by one second aggregates</div><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar codeBlockWithTitle_ZT05"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">bbo = execute(conn,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    &quot;SELECT timestamp,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    avg(mid) as mid_avg FROM mid_table</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    SAMPLE BY 1s&quot;) |&gt; DataFrame</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">dropmissing!(bbo);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><figure><img alt="Plot showing high-frequency mid-price of Apple stock over 18 hours" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/example_mid_all.png" width="650"></figure><p>Here we have plotted the high-frequency mid-price over our entire dataset.
Distinctly different from the historical Yahoo finance data as we have roughly
100,000 rows covering around 18 hours. It is this mid-price at every second that
we will use to continue our exploration of high-frequency finance.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="introduction-to-financial-returns"></a>Introduction to financial returns<a class="hash-link" href="#introduction-to-financial-returns" title="Direct link to heading">#</a></h2><p>So we have our aggregated price but we need to perform another transformation
before we can continue our analysis. When we look at our mid-price plot we see
that it goes through different levels.</p><p>Early on the price is below $34,000 before increasing to
$34,750; we need to know
what time of day it is to understand what level the price is. This means that it
is not stationary, so to overcome this issue, we need to transform the mid-price
into something stationary (or at least <em>more</em> stationary) which is where the
concept of returns arrives.</p><p>The return over each period is the percentage change</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><msub><mi>p</mi><mi>t</mi></msub><mo>−</mo><msub><mi>p</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><msub><mi>p</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mfrac><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">r_t = \frac{p_{t} - p_{t-1}}{p_{t-1}},</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.154661em;vertical-align:-0.894331em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.26033em"><span style="top:-2.3139999999999996em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.894331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></span></div><p>which we translate into Julia code as:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">returns = [(bbo.mid_avg[i] - bbo.mid_avg[i-1]) / bbo.mid_avg[i-1] for i in 2:nrow(bbo)]</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">bbo = @transform(bbo, returns = [NaN; returns])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>As each row represents one second, this is the one-second return time series.
When we plot the first 10 minutes of 1-second returns we see that it is more
stable than the mid-price.</p><figure><img alt="Plot showing high-frequency returns of Apple stock" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/returns.png" width="650"></figure><p>Unlike the price, there is no obvious level at which the returns are hovering.
The average is around zero and with periods of positive and negative returns.
Now it is more conventional to work in <em>log-returns</em> which is the logarithm of
the above formula, which we write as a simple equation:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>log</mi><mo>⁡</mo><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">\log r_t = \log (p_t) - \log({p_{t-1}}),</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span></div><p>Again, when translated to Julia code is even simpler:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">bbo = @transform(bbo, logreturns = [NaN; diff(log.(:mid_avg))])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>It is conventional to work in log-returns as you can add them across time
periods to arrive at the total return. With simple returns, you have to multiply
each period. But, at such small time frames (in our case one second intervals)
small return values the log-returns are similar to the simple returns, so in
truth it doesn&#x27;t matter much. The distribution of log-returns has a reassuringly
nice distribution:</p><figure><img alt="Plot showing log-returns returns of Apple stock showing the fat tail phenomemon" class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/returnHist.png" width="650"></figure><p>We can immediately pull out some key features.</p><ul><li><p>The center of the distribution is zero, or close enough.</p></li><li><p>The average looks constant throughout the day and indicates some degree of
stationarity in the log-returns.</p></li><li><p>Large values occur but they are rare.</p></li></ul><p>This is the <strong>fat tail</strong> phenomenon where the tails of a probability
distribution is larger than you expect and thus extreme values happen more
regularly than typical probability distributions would describe. Most of the
values are between <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>±</mo></mrow><annotation encoding="application/x-tex">\pm</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em"></span><span class="mord">±</span></span></span></span></span> 0.0005, but values of 0.001 (so twice as large) did
happen.</p><p>These large tails are a defining feature of finance and not restricted to
high-frequency data. There are many examples where an extreme event has rippled
through the financial system,
<a href="https://en.wikipedia.org/wiki/Black_Monday_(1987)" target="_blank" rel="noopener noreferrer">Black Monday (19/10/1987)</a>
saw the Dow Jones Industrial Average fall by 22%, before that the largest ever
decrease was in 1929 at 12%, so quite the difference in returns.</p><p>We can quantify this heavy tail behaviour with some statistics. The <strong>kurtosis</strong>
of a distribution describes the tail behaviour, with a value less than 3
indicating &#x27;thin tails&#x27; and thus fewer outliers or large events than the normal
distribution. A kurtosis value of greater than 3 indicates &#x27;fat tails&#x27; and as
you guessed, more likely to generate outliers. 3 is the magic number as this is
the kurtosis of the normal distribution, so the excess kurtosis is the kurtosis
minus three.</p><p>Let&#x27;s calculate the mean, standard deviation, and excess kurtosis on our log
returns. In Julia, we use the <code>mean</code>, <code>std</code>, and <code>kurtosis</code> function from the
<code>Statistics</code> library.</p><table><thead><tr><th>Statistic</th><th>Value</th></tr></thead><tbody><tr><td>Mean</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup></mrow><annotation encoding="application/x-tex">7 \times 10 ^{-8}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span></span></td></tr><tr><td>Standard Deviation</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>5</mn></mrow></msup></mrow><annotation encoding="application/x-tex">7 \times 10 ^{-5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></span></td></tr><tr><td>Excess Kurtosis</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>15</mn></mrow><annotation encoding="application/x-tex">15</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span><span class="mord">5</span></span></span></span></span></td></tr></tbody></table><p>With a large excess kurtosis of 15, as we expected, this is proof that these
log-returns are heavy-tailed. Large events are more likely to happen than we
would think.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="correlation-and-time-series-autocorrelation"></a>Correlation and time series autocorrelation<a class="hash-link" href="#correlation-and-time-series-autocorrelation" title="Direct link to heading">#</a></h2><p>So far, we&#x27;ve transformed the prices into returns so that we are looking at a
stationary time series. We investigated what the distribution of this time
series looked like and found that its average was close to zero and it had a
large excess kurtosis and thus is fat-tailed.</p><p>Now we want to look at the correlation between these returns and see what we can
learn from this type of analysis. When we talk about correlation we mean
<em>autocorrelation</em> which is the correlation between each value and values further
on in the time series.</p><p>We calculate the correlation between every value and the next value to arrive at
the &#x27;lag 1 correlation&#x27;, we then calculate the correlation between every value
and the second next value to give us the &#x27;lag 2 correlation&#x27;. We can keep on
going for as many lags as we like to produce an autocorrelation plot.</p><p>Actually calculating the autocorrelation is hidden behind the <code>autocor</code> function
in Julia:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">acf = autocor(bbo.logreturns[2:end])</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">plot(acf[2:end], seriestype=:scatter, label = &quot;Autocorrelation&quot;,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     xlabel=&quot;Lag&quot;, ylabel = &quot;Correlation&quot;)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">hline!(return_acf, [-1, 1] .* 1/sqrt(nrow(bbo) - 1),</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       label = &quot;Confidence&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><figure><img alt="Plotting time series autocorrelation and confidence over lag." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/return_acf.png" width="650"></figure><p>Here we have calculated the autocorrelation plot on the Bitcoin log-returns and
at the smaller lags, there is some statistical significance. At lag 1, the value
of about 0.35 shows that a large return is likely followed by another large
return of the same sign, so positive returns follow positive returns and
likewise for negative.</p><p>There is a slight negative correlation at lags 3, 4, and 5 which indicates that
after the initial log-return there is some indication of mean reversion, i.e.
returns of the opposite sign. All very interesting and shows that there is some
slight predictability in the return pattern and after every log-return, we have
a reasonable idea of what the next few log-returns might look like.</p><p>Once we go beyond 10 lags though there is no statistical significance, which
suggests that each log-return has a short lifespan and disrupts the market for
less than 10 seconds.</p><p>We can also look at the autocorrelation on the absolute returns, so by stripping
out the sign of the returns is there a change in the correlation structure?</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">acf = autocor(abs.(bbo.logreturns[2:end]))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><figure><img alt="Plotting absolute time series autocorrelation and confidence over lag." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/return_abs_acf.png" width="650"></figure><p>Now things take an interesting turn. All lags are significant and more so that
they are positive. This indicates that large values follow large values of
either sign, so a large positive log-return is likely to be followed by a
similar large log-return of either positive or negative. This effect slowly
decays and lasts for a long time.</p><p>When we take logs of both the axis we see the following straight line</p><figure><img alt="Plotting log of correlation and confidence over log of lag." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/return_abs_acf_log.png" width="650"></figure><p>which indicates that the autocorrelation of the absolute returns follows a power
law;</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Autocorrelation</mtext><mo>∝</mo><mfrac><mn>1</mn><msup><mtext>Lag</mtext><mi>γ</mi></msup></mfrac><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">\text{Autocorrelation} \propto \frac{1}{\text{Lag} ^\gamma},</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mord text"><span class="mord">Autocorrelation</span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.20188em;vertical-align:-0.8804400000000001em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">Lag</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.737622em"><span style="top:-3.1362300000000003em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05556em">γ</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></span></div><p>and power-law distributions are fat-tailed. So what we discovered about the
distribution of the returns is also true for the autocorrelation, outliers are
expected. Furthermore, this shows that there is long-term memory over time, the
notion that large returns lead to other large returns persists in the market for
a long time.</p><p>Here it is 50 lags (so 50 seconds) but the power-law indicates that it will
continue for a long time. This all points to the presence of <em>regimes</em> where
there are periods of large returns and likewise, periods of small returns. This
gives a semblance of predictability, at least at the high-frequency level but
also shows how similar sizes of returns are grouped.</p><p>This is where we can start to think about volatility, or how the variation of
returns changes. This correlation of absolute returns shows that the underlying
volatility (or variation) in returns is not stationary.</p><p>The study of volatility of returns is a whole theme in itself and we will look
at calculating volatility at a later date. This is where we come to a close with
looking at high-frequency prices and move onto high-frequency trades.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="analyzing-crypto-trades-and-using-empirical-price-impact"></a>Analyzing crypto trades and using empirical price impact<a class="hash-link" href="#analyzing-crypto-trades-and-using-empirical-price-impact" title="Direct link to heading">#</a></h2><p>When people buy or sell some Bitcoin at Coinbase it is recorded and broadcasted,
and I&#x27;ve shown you how to store this data in the previous tutorial. This data is
useful for looking at irregularly-spaced events as each trade occurs at a random
time. This satisfies our condition for the high-frequency data classification.</p><p>Trades also happen at an extraordinary rate; in our sample, we have over 200k
trades in the same period of the tick data above (18 hours). We are interested
in the price of each trade, whether it was a buy or sell, and finally what time
it happened. This is easy to extract from our QuestDB database:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">@time trades = execute(conn,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">&quot;SELECT timestamp, price, size, side FROM coinbase_trades&quot;) |&gt; DataFrame</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">dropmissing!(trades);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Recorded trades represent the actual price at which some Bitcoin has changed
hands and is more tangible than our previous dataset which was <em>indications</em>
where people might buy or sell Bitcoin. If you are buying or selling Bitcoin,
you want to make sure you get the best possible price.</p><p>This is quite an open-ended problem that is fraught with difficulty in deciding
what means &#x27;best&#x27;. A simple method of judging though is comparing the price you
paid with the price of the next trade. But why stop at the next trade, you can
look at the next <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span> trades to understand how the price evolved after each
trade.</p><p>This leads us to calculate the <strong>empirical price impact</strong> function, which
averages the impact at each lag to build up an empirical picture of price
evolution over time. As an equation, we are taking an average over the different
lags of the trades data frame.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>l</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>ϵ</mi><mi>k</mi></msub><mo stretchy="false">(</mo><msub><mi>p</mi><mrow><mi>k</mi><mo>+</mo><mi>l</mi></mrow></msub><mo>−</mo><msub><mi>p</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(l) = - \frac{1}{n} \sum _{k=1} ^n \epsilon _k (p_{k+l} - p_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.9535100000000005em;vertical-align:-1.302113em"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em"><span style="top:-1.8478869999999998em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0500049999999996em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.300005em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.302113em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div><p>As this is an empirical measure, we are also going to classify the size of the
trades into <strong>small</strong>, <strong>medium</strong>, and <strong>large</strong> using the quantiles of the
trade size. We will see how the price impact functions change based on trade
size. Ultimately, we expect larger trades to have a greater price impact and
this to reflect in the price impact function.</p><p>This all comes down to supply and demand; a larger trade disrupts the balance of
supply and demand more than the smaller trades and thus its effects will be felt
for longer. To calculate this price impact in Julia we first add a log price to
the trades dataframe:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">trades = @transform(trades, logprice = log.(:price))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We now calculate the boundaries for our trade size classification.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">sizeF = cut(trades.size, quantile(unique(trades.size), 0:(1/3):1), extend = true, labels = [&quot;Small&quot;, &quot;Medium&quot;, &quot;Large&quot;])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><ul><li><strong>Small trades:</strong> &lt; 0.0028 which is about $95</li><li><strong>Medium trades:</strong> &gt; 0.0028 but &lt; 0.014</li><li><strong>Large trades:</strong> &gt; 0.014, about $480</li></ul><p>And now we can calculate the log returns between the trades at different lags.
We are going to look at a maximum of 2500 lags.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">r_diffs = [-1 .* trades.side .* (lag(trades.logprice, k) - trades.logprice) for k in 1:2500]</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">lagframe = DataFrame(hcat(r_diffs...), :auto)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">lagframe[!, :SizeGroup] = sizeF</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">dropmissing!(lagframe);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Before finally converting it from a wide format to a long format using <code>stack</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">lagFrameTidy = stack(lagframe, 1:2500);</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">gdata = groupby(lagFrameTidy, [:SizeGroup, :variable])</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">sdata = combine(gdata, :value =&gt; mean, :value =&gt; std, :value =&gt; length)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">sdata[!, :lag] = parse.(Int64, chop.(sdata.variable, head = 1, tail = 0))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We plot the log-return against the lag and again, we see a power law:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI julia"><div tabindex="0" class="prism-code language-julia codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">plot(sdata.lag, sdata.value_mean,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     group = sdata.SizeGroup,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     ribbon = 1.96 .* sdata.value_std ./ sqrt.(sdata.value_length),</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     xlabel = &quot;Lag&quot;, ylabel = &quot;Impact&quot;, legend=:bottomright)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><figure><img alt="Plotting log-return against lag to reveal a power-law." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/impact.png" width="650"></figure><p>Importantly, we can see the confirmation of our hypothesis, larger trades have a
greater impact on future trades and likewise, smaller trades have the least
impact.</p><p>We&#x27;ve added the standard error on the calculation of the impact and glad to see
it grow over time, as there is more variation at larger lags. If we zoom into 20
lags we can see this price impact effect even clearer:</p><figure><img alt="Plotting log-return against lag to reveal a power-law with a standard error." class="image_Pw1y margin_Rc0b shadow_7z-4" height="591" src="/img/blog/2021-11-22/impact_sub.png" width="650"></figure><p>The first price difference is similar for all three trade types, around
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>5</mn></mrow></msup></mrow><annotation encoding="application/x-tex">1 \times 10^{-5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></span>, but 5 trades later, the price difference is starkly
different, the large trade has had much more market impact. The large trades
have caused the price to move that much more.</p><p>This is all empirical evidence, we have taken the data presented to us and
managed to prove that trading large amounts is more likely to move the price
than a smaller trade amount. Again, as this is high-frequency the average
timescales are small, the average time difference between trades is 500ms and
the median is 154ms but very relevant for anyone making lots of trades, knowing
that the larger ones will be pushing the price more.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-we-learned-about-high-frequency-finance"></a>What we learned about high-frequency finance<a class="hash-link" href="#what-we-learned-about-high-frequency-finance" title="Direct link to heading">#</a></h2><p>That concludes our whistle-stop tour of different aspects of high-frequency
finance. Hopefully, I have convinced you why this type of data is different from
your typical daily data and how there are all sorts of interesting phenomena
underneath the surface.</p><p>I&#x27;ve highlighted the two prices, the <strong>bid</strong> and the <strong>ask</strong>, plus how we
combine them to form the <strong>mid-price</strong>. We&#x27;ve then seen how this mid-price is
not stationary and instead converted it to <strong>returns</strong> and then log-returns
which is a stationary time series.</p><p>The <strong>log-returns</strong> are distributed with a mean close to zero but an excess
kurtosis of 16, which showed the distribution is very heavy-tailed. Extreme
returns, both positive and negative will happen much more frequently than
typically expected.</p><p>We took a look at the <strong>correlations</strong> in this log-returns time series to
understand how the different changes integrate through the returns. We found a
positive correlation at short lags that flipped to a negative correlation after
roughly 5 seconds. The correlation was no longer statistically significant at
larger larges.</p><p>The <strong>autocorrelation</strong> of the absolute returns show strong correlations at all
lags and it decayed like a power law. This was another example of heavy tails in
high-frequency finance with more consequences. The fact that the correlations
persist in the absolute returns for a long time shows how the log-returns go
through periods of regimes. These regimes are periods where large moves, both
positive and negative, are common and likewise, other regimes where small
returns happen. Despite the log-returns appearing stationary, we now know that
the underlying volatility is not stationary.</p><p>We then turned our analysis to high-frequency trades. These are now irregularly
spaced and represent the tangible exchange of Bitcoin for US dollars. Here we
examined the <strong>price impact</strong> of each trade by comparing the traded price to
future trade prices, which gives an idea of how each trade affects the price of
future trades. We created three categories of trades, small, medium, and large
based on the size of the trade and calculated the empirical impact function. We
found that large trades cause the most impact, as expected and that it is a
sizeable difference to the other two categories.</p><p>Overall, there are many facets to high-frequency finance with different ways to
approach analyzing the data. Open-source tools like QuestDB provide an easy way
to store this information and help you focus on the analysis rather than
worrying about data.</p><hr><p>If you like this content, check out the
<a href="/blog/2021/09/17/high-frequency-finance-julia-lang">previous post on Julia and QuestDB</a>
and <a href="https://dm13450.github.io/about/" target="_blank" rel="noopener noreferrer">Dean&#x27;s personal blog</a>. We&#x27;d love to know
your thoughts on this content, so feel free to share your feedback or simply
come and say hello in the <a href="https://" target="_blank" rel="noopener noreferrer">QuestDB Community Slack</a>.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/tutorial">tutorial</a><a class="margin-horiz--sm" href="/blog/tags/julialang">julialang</a><a class="margin-horiz--sm" href="/blog/tags/market-data">market data</a><a class="margin-horiz--sm" href="/blog/tags/crypto">crypto</a><a class="margin-horiz--sm" href="/blog/tags/trading">trading</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/11/29/questdb-versus-influxdb"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Comparing InfluxDB and QuestDB databases</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/11/09/miguel-arregui-working-at-questdb"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Why I joined QuestDB as a core database engineer »</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">문의하기</h3><p class="description_Bwvi">이메일을 입력하시면 소개자료를 보내드립니다.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">보내기</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>인프라관리부터 서비스운영까지 클라우드환경에 최적화된 클라우드 네이티브 플랫폼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright © 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.185a1183.js" defer="defer"></script>
</body>
</html>