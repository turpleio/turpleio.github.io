<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">Stream heart rate data into QuestDB via Google IoT Core | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="Stream heart rate data into QuestDB via Google IoT Core | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="An end-to-end demo of a simple IoT system to stream and visualize heart rate data in Grafana via Google Cloud Platform"><meta data-react-helmet="true" name="twitter:description" content="An end-to-end demo of a simple IoT system to stream and visualize heart rate data in Grafana via Google Cloud Platform"><meta data-react-helmet="true" property="og:description" content="An end-to-end demo of a simple IoT system to stream and visualize heart rate data in Grafana via Google Cloud Platform"><meta data-react-helmet="true" name="twitter:title" content="Stream heart rate data into QuestDB via Google IoT Core | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Stream heart rate data into QuestDB via Google IoT Core | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" name="keywords" content="timeseries,google,streaming,iot,grafana"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/shared/og-iot.png"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/shared/og-iot.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">Stream heart rate data into QuestDB via Google IoT Core</h1><time datetime="2021-02-05T00:00:00.000Z" class="date_A31P">February 5, 2021 Â· 10 min read</time><div class="avatar margin-vert--md"><a href="https://github.com/Yitaek" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/Yitaek" alt="Yitaek Hwang"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/Yitaek" target="_blank" rel="noopener noreferrer">Yitaek Hwang</a></h4><small class="avatar__subtitle">Guest</small></div></div></header><div class="markdown"><figure><img alt="Raspberry Pi devices on a workbench used in an IoT project" class="image_1-Fc image--title_Z46g" height="433" src="/img/blog/2021-02-05-2/banner.jpg" width="650"><figcaption class="caption_VLGg">Photo by <a href="https://unsplash.com/@_louisreed" target="_blank" rel="noopener noreferrer">Louis Reed</a> via <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a></figcaption></figure><p>This submission comes from one of our community contributors
<a href="https://github.com/Yitaek" target="_blank" rel="noopener noreferrer">Yitaek Hwang</a> who has put together a nice guide for
streaming fitness data into QuestDB with Google Cloud Platform.</p><p>Thanks for your contribution, Yitaek!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="background"></a>Background<a class="hash-link" href="#background" title="Direct link to heading">#</a></h2><p>Thanks to the growing popularity of fitness trackers and smartwatches, more
people are tracking their biometrics data closely and integrating IoT into their
everyday lives. In my search for a DIY heart rate tracker, I found an excellent
walkthrough from Brandon Freitag and
<a href="https://medium.com/u/87b2115d4438" target="_blank" rel="noopener noreferrer">Gabe Weiss</a>, using Google Cloud services to
stream data from a Raspberry Pi with a heart rate sensor to BigQuery via IoT
Core and Cloud Dataflow.</p><figure><img alt="A diagram with Raspberry Pi sending data to Google Cloud Platform services" class="image_Pw1y margin_Rc0b shadow_7z-4 title_f-p+" height="138" src="/img/blog/2021-02-05-2/gcp-diagram.png" width="650"><figcaption class="caption_-tGK">Example stack with Google Cloud Platform services</figcaption></figure><p>Although Cloud Dataflow supports streaming inserts to BigQuery, I wanted to take
this opportunity to try out a new time-series database I came across called
QuestDB. QuestDB is a fast open-source time-series database with Postgres and
Influx line protocol compatibility. The <a href="https://" target="_blank" rel="noopener noreferrer">live demo</a> on the website
queries the NYC taxi rides dataset with over 1.6 billion rows in milliseconds,
so I was excited to give this database a try. To round out the end-to-end demo,
I used Grafana to pull and visualize data from QuestDB.</p><figure><img alt="A diagram showing a Raspberry Pi sending data to QuestDB via Google Cloud Platform services" class="image_Pw1y margin_Rc0b shadow_7z-4 title_f-p+" height="284" src="/img/blog/2021-02-05-2/quest-diagram.png" width="650"><figcaption class="caption_-tGK">The stack used here with QuestDB replacing Dataflow and adding Grafana for visualization</figcaption></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="prerequisites"></a>Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h2><ul><li><a href="https://nodejs.org/en/download/" target="_blank" rel="noopener noreferrer">NodeJS v14+</a></li><li><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener noreferrer">Docker</a></li><li><a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer">A Google Cloud Account</a></li><li><a href="https://cloud.google.com/sdk/docs/install" target="_blank" rel="noopener noreferrer">gcloud sdk</a></li><li><strong>Optional </strong><a href="https://www.arrow.com/en/research-and-events/articles/codelabs-using-iot-core-to-stream-heart-rate-data" target="_blank" rel="noopener noreferrer">Raspberry Pi kit</a></li></ul><p>In this tutorial, we will use a Debian image and a Python script to send
simulated sensor data through IoT Core. If you wish to send real sensor data
from a Raspberry Pi, the kit listed above contains everything you need along
with
<a href="https://codelabs.developers.google.com/codelabs/iotcore-heartrate#6" target="_blank" rel="noopener noreferrer">install instructions</a>.
If you have a Raspberry Pi without the kit, you can directly swap it out for the
VM instance below and run the Python script provided or add your own inputs.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="google-cloud-setup"></a>Google Cloud Setup<a class="hash-link" href="#google-cloud-setup" title="Direct link to heading">#</a></h2><p>In order to use Cloud IoT Core and Cloud Pub/Sub, you need to first create a
Google Cloud Platform account and a new project (mine is called
<code>questdb-iot-demo</code> ). Navigate to</p><p><strong>APIs &amp; Services -&gt; Enable APIs and Services -&gt; Search for APIs &amp; Services</strong></p><p>and enable the following APIs:</p><ul><li><strong>IoT Core</strong></li><li><strong>Pub/Sub</strong></li><li><strong>Compute Engine</strong></li></ul><figure><img alt="A screenshot of enabling APIs in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4" height="142" src="/img/blog/2021-02-05-2/enable-apis.png" width="650"></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="iot-core"></a>IoT Core<a class="hash-link" href="#iot-core" title="Direct link to heading">#</a></h3><p>IoT Core is Google&#x27;s fully-managed IoT service to help securely connect and
manage IoT devices. In this demo, we will create a registry called <code>heartrate</code>
and send MQTT data. Click on <strong>Create Registry</strong> and set the Registry ID and
Region based on the geographic region closest to you (for me it was
<code>us-central1</code>):</p><figure><img alt="A screenshot of creating an IoT Core Device Registry in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4" height="310" src="/img/blog/2021-02-05-2/create-registry.png" width="500"></figure><p>Next, we need to configure a Pub/Sub topic to publish device data to. Under
&quot;Select a Cloud Pub/Sub topic&quot;, click on <strong>Create a Topic</strong> and give it the
Topic ID <code>heartratedata</code>:</p><figure><img alt="A screenshot of creating a Pub/Sub topic in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4" height="267" src="/img/blog/2021-02-05-2/create-topic.png" width="650"></figure><p>Once the registry properties and Cloud Pub/Sub topics are configured, click on
<strong>Create</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="compute-engine"></a>Compute Engine<a class="hash-link" href="#compute-engine" title="Direct link to heading">#</a></h3><p>Now it&#x27;s time to add our simulated device. In order for our device to
communicate with IoT Core, we need to add a public key. Head over to <strong>Compute
Engine -&gt; Create</strong>.</p><figure><img alt="A screenshot of creating a VM instance in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4" height="293" src="/img/blog/2021-02-05-2/create-vm-instance.png" width="650"></figure><p>The default options (<code>e2-medium</code>, Debian 10 image, <code>us-central1</code>) will work for
our simulator. Make sure to match the region with the IoT Core registry region
if you chose something other than <code>us-central1</code>. Once the VM is ready, click on
the <strong>SSH</strong> button under &quot;Connect&quot; and install the project code with the
following commands:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># Install git</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">sudo</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">apt-get</span><span class="token plain"> update </span><span class="token function" style="color:#8be9fd">sudo</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">apt-get</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">install</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">git</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># Clone project code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">git</span><span class="token plain"> clone https://github.com/googlecodelabs/iotcore-heartrate </span><span class="token operator" style="color:#ff79c6">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:#bd93f9">cd</span><span class="token plain"> iotcore-heartrate</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># Install all the core packages</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">chmod</span><span class="token plain"> +x initialsoftware.sh ./initialsoftware.sh</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># Generate the keys</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">chmod</span><span class="token plain"> +x generate_keys.sh ./generate_keys.sh</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># View and copy the keys</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">cat</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">..</span><span class="token plain">/.ssh/ec_public.pem</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pubsub"></a>Pub/Sub<a class="hash-link" href="#pubsub" title="Direct link to heading">#</a></h3><p>Finally, we need to create a subscription to our Pub/Sub topic to pull messages
and insert into QuestDB. Head over to &quot;Pub/Sub&quot; and click on our <code>heartratedata</code>
topic. Give the subscription the name <code>questdb</code> and click <strong>Create</strong>.</p><figure><img alt="A screenshot of creating a Pub/Sub subscription in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4" height="82" src="/img/blog/2021-02-05-2/heartrate-topic.png" width="650"></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="iot-device-setup"></a>IoT Device Setup<a class="hash-link" href="#iot-device-setup" title="Direct link to heading">#</a></h2><p>Once you have the <code>ec_public.pem</code> key, head back to the IoT Core Registry. Under
&quot;Devices&quot;, click on <strong>Create a Device</strong>. For Device ID, enter
<code>raspberryHeartRate</code> and expand the <strong>Communication, Cloud Logging,
Authentication</strong> dropdown:</p><figure><img alt="A screenshot of adding a device to IoT Core in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4" height="330" src="/img/blog/2021-02-05-2/device-metadata.png" width="500"></figure><p>Under Authentication, change the <strong>Public key format</strong> to <code>ES256</code>, paste in the
key from our VM or Raspberry Pi and click &quot;Create&quot;:</p><figure><img alt="A screenshot of adding a public key to IoT Core in Google Cloud Platform" class="image_Pw1y margin_Rc0b shadow_7z-4 title_f-p+" height="362" src="/img/blog/2021-02-05-2/authentication.png" width="500"><figcaption class="caption_-tGK">Adding a public key to IoT Core to secure device-to-cloud communication</figcaption></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="questdb-setup"></a>QuestDB Setup<a class="hash-link" href="#questdb-setup" title="Direct link to heading">#</a></h2><p>At this point, we have everything on Google Cloud to send data to our Pub/Sub
topic. Now we need to write some code to take those messages and insert them
into QuestDB. Let&#x27;s start by starting up QuestDB via Docker.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">docker run --name questdb-heartrate -p </span><span class="token number" style="color:#50fa7b">9000</span><span class="token plain">:9000 -p </span><span class="token number" style="color:#50fa7b">8812</span><span class="token plain">:8812 questdb/questdb</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The above command pulls the latest QuestDB image (v5.0.6) and maps port <code>9000</code>
for the console UI and port <code>8812</code> for Postgres connections. By giving the
container the name <code>questdb-heartrate</code> we can refer to the container later on
after it has been stopped and the heart rate data is persisted:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># bring the container up</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">docker start questdb-heartrate</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># shut the container down</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">docker stop questdb-heartrate</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Open up the QuestDB console at (<a href="http://127.0.0.1:9000/" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9000/</a>) and create our
<code>heart_rate</code> table:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">CREATE TABLE heart_rate(sensorID STRING, uniqueID STRING, timecollected</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  TIMESTAMP, heartrate DOUBLE) timestamp(timecollected);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><strong>Note:</strong> If you don&#x27;t see the <code>heart_rate</code> table populated on the tables and
schema explorer panel, click on the refresh icon above the tables.)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pubsub-to-questdb"></a>Pub/Sub to QuestDB<a class="hash-link" href="#pubsub-to-questdb" title="Direct link to heading">#</a></h2><p>Since there&#x27;s no native integration for Pub/Sub, we will need to write a simple
program to listen to new Pub/Sub messages and insert the data into QuestDB. I&#x27;m
using NodeJS v14.15.4, but you can use similar client libraries for Pub/Sub and
Postgres to achieve the same.</p><p>First, configure the <code>gcloud</code> SDK to authenticate with your GCP project without
having to download a service account (see
<a href="https://medium.com/dev-genius/simple-gcp-authentication-with-service-accounts-6b877c2e2649" target="_blank" rel="noopener noreferrer">Simple GCP Authentication with Service Accounts</a>
for more details).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># Set default profile</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">gcloud auth application-default login</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Next, create a new NodeJS workspace and install
<a href="https://www.npmjs.com/package/@google-cloud/pubsub" target="_blank" rel="noopener noreferrer">@google-cloud/pubsub</a> and
<a href="https://www.npmjs.com/package/pg" target="_blank" rel="noopener noreferrer">pg</a> packages. You can use the code below to
listen to Pub/Sub and stream to QuestDB:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><div tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4">// Modified from https://github.com/googleapis/nodejs-pubsub/blob/master/samples/listenWithCustomAttributes.js</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token maybe-class-name">PubSub</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">require</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;@google-cloud/pubsub&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> </span><span class="token maybe-class-name">Client</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">require</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;pg&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// Default connection settings https://questdb.io/docs/reference/configuration/#postgres-wire-protocol</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> client </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">new</span><span class="token plain"> </span><span class="token class-name">Client</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  user</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;admin&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  host</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  database</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;qdb&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  password</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;quest&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  port</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;8812&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">async</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">function</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">subscriptionName </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;questdb&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> timeout </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">60</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> pubSubClient </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">new</span><span class="token plain"> </span><span class="token class-name">PubSub</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#ff79c6">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">connect</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">async</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">function</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">listenForMessages</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> subscription </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> pubSubClient</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">subscription</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">subscriptionName</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// Create an event handler to handle messages</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#8be9fd">messageHandler</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">message</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#ff79c6">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// Parse Pub/Sub message into JSON</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> data </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token keyword module" style="color:#ff79c6">from</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;base64&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">toString</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;utf-8&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> parsedMessage </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">parse</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// Get each field and transform time into ts format</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> sensorID</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> uniqueID</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> timecollected</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> heartrate </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> parsedMessage</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// Using timestamp in microseconds: https://questdb.io/docs/reference/sql/datatypes/</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> ts </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">parse</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">timecollected</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1000</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> text </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token string" style="color:#f1fa8c">&quot;INSERT INTO heart_rate(sensorID, uniqueID, timecollected, heartrate) VALUES($1, $2, $3, $4)&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> values </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">sensorID</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> uniqueID</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ts</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> heartrate</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> res </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#ff79c6">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">query</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> values</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      message</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">ack</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// Listen for new messages until timeout is hit</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    subscription</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">on</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;message&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> messageHandler</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">setTimeout</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#ff79c6">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#ff79c6">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      subscription</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">removeListener</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;message&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> messageHandler</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;done&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#ff79c6">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">end</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> timeout </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1000</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#8be9fd">listenForMessages</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">process</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">on</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;unhandledRejection&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token parameter">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#ff79c6">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">message</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  process</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">exitCode</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#8be9fd">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="sending-data"></a>Sending Data<a class="hash-link" href="#sending-data" title="Direct link to heading">#</a></h2><p>Finally, we are ready to send the simulated data. Switch back to the Compute
Engine and ssh into the VM again. Issue the command below to send the data to
our IoT Core device:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">python3 heartrateSimulator.py --project_id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">questdb-iot-demo </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  --registry_id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">heartrate --device_id</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">raspberryHeartRate </span><span class="token punctuation" style="color:#f8f8f2">\</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  --private_key_file</span><span class="token operator" style="color:#ff79c6">=</span><span class="token punctuation" style="color:#f8f8f2">..</span><span class="token plain">/.ssh/ec_private.pem</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>If successful, you should see some logs like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">..</span><span class="token plain">. Publishing message </span><span class="token comment" style="color:#6272a4">#544: &#x27;{&quot;sensorID&quot;: &quot;heartrate.raspZero&quot;, &quot;heartrate&quot;:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token number" style="color:#50fa7b">72.56881801680139</span><span class="token plain">, </span><span class="token string" style="color:#f1fa8c">&quot;uniqueID&quot;</span><span class="token builtin class-name" style="color:#bd93f9">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token string" style="color:#f1fa8c">&quot;c1ca9656-671f-4fa7-8c03-12fdfb4f422f-heartrate.raspZero&quot;</span><span class="token plain">, </span><span class="token string" style="color:#f1fa8c">&quot;timecollected&quot;</span><span class="token builtin class-name" style="color:#bd93f9">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token string" style="color:#f1fa8c">&quot;2018-07-07 20:54:50&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token string" style="color:#f1fa8c">&#x27;Publishing message #545: &#x27;</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;sensorID&quot;</span><span class="token builtin class-name" style="color:#bd93f9">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token string" style="color:#f1fa8c">&quot;heartrate.raspZero&quot;</span><span class="token plain">, </span><span class="token string" style="color:#f1fa8c">&quot;heartrate&quot;</span><span class="token builtin class-name" style="color:#bd93f9">:</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">72.8324264524384</span><span class="token plain">, </span><span class="token string" style="color:#f1fa8c">&quot;uniqueID&quot;</span><span class="token builtin class-name" style="color:#bd93f9">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token string" style="color:#f1fa8c">&quot;8d6337b7-204f-4209-88c0-46a79d1911bb-heartrate.raspZero&quot;</span><span class="token plain">, </span><span class="token string" style="color:#f1fa8c">&quot;timecollected&quot;</span><span class="token builtin class-name" style="color:#bd93f9">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token string" style="color:#f1fa8c">&quot;2018-07-07 20:54:59&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">&#x27; Finished.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now run our NodeJS code and we should see data populated in QuestDB:</p><figure><img alt="A screenshot of the QuestDB Web Console returning query results on sensor data" class="image_Pw1y margin_Rc0b shadow_7z-4 title_f-p+" height="353" src="/img/blog/2021-02-05-2/select-from-heartrate.png" width="650"><figcaption class="caption_-tGK">Querying heart rate data in QuestDB</figcaption></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="visualizing-data-with-grafana"></a>Visualizing Data with Grafana<a class="hash-link" href="#visualizing-data-with-grafana" title="Direct link to heading">#</a></h2><p>Although QuestDB console provides some default visualizations out of the box, to
simulate a scenario of combining all the metrics, we&#x27;ll set up a Postgres data
source and visualize our heart rate data. To start Grafana from Docker, run the
following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">docker run -p </span><span class="token number" style="color:#50fa7b">3000</span><span class="token plain">:3000 grafana/grafana</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Navigate to <a href="http://localhost:3000/login" target="_blank" rel="noopener noreferrer">http://localhost:3000/login</a> using the
default credentials (<code>admin</code>:<code>admin</code>). Under <strong>Configuration -&gt; Data Sources</strong>,
search for Postgres:</p><figure><img alt="A screenshot of adding QuestDB as a data source in Grafana" class="image_Pw1y margin_Rc0b shadow_7z-4" height="377" src="/img/blog/2021-02-05-2/add-postgres.png" width="650"></figure><p>Provide the following login credentials (password: <code>quest</code>), ensure SSL is
disabled and click <strong>Save and Test</strong>:</p><figure><img alt="A screenshot of authenticating QuestDB within Grafana using Postgres" class="image_Pw1y margin_Rc0b shadow_7z-4" height="263" src="/img/blog/2021-02-05-2/postgres-credentials.png" width="650"></figure><p>Finally, let&#x27;s create a dashboard. Add a panel to the Grafana dashboard and add
the following SQL query:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT timecollected AS &quot;time&quot;,</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       heartrate</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">FROM heart_rate</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">ORDER BY time;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>If all is working as expected, we can now see the sample heart rate data:</p><figure><img alt="A screenshot of a chart in Grafana showing sensor data plotted over time" class="image_Pw1y margin_Rc0b shadow_7z-4 title_f-p+" height="261" src="/img/blog/2021-02-05-2/chart-heartrate.png" width="650"><figcaption class="caption_-tGK">Sensor data visualized in Grafana</figcaption></figure><p>If we run the same query on QuestDB, we have the option to visualize the same
data points there for comparison using the <strong>Chart</strong> feature:</p><figure><img alt="A screenshot of a chart in QuestDB showing sensor data plotted over time" class="image_Pw1y margin_Rc0b shadow_7z-4 title_f-p+" height="220" src="/img/blog/2021-02-05-2/heart-rate-graph.png" width="650"><figcaption class="caption_-tGK">Sensor data visualized in QuestDB</figcaption></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>At this point, we have an end-to-end system of a device securely sending data
via IoT Core and streaming data into QuestDB. We can extend this example to
multiple devices by adding them under IoT Core and scaling our server to using
pooled connections to more efficiently add data to QuestDB. At scale, we can
also look at aggregates instead of raw data points, (e.g.
<code>avg(heartrate) as avg_hr from heart_rate SAMPLE BY 1d</code>)</p><p>If you like this content, we&#x27;d love to know your thoughts! Feel free to share
your feedback or just come and say hello in the
<a href="https://" target="_blank" rel="noopener noreferrer">QuestDB Community Slack</a>.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/tutorial">tutorial</a><a class="margin-horiz--sm" href="/blog/tags/streaming">streaming</a><a class="margin-horiz--sm" href="/blog/tags/iot">iot</a><a class="margin-horiz--sm" href="/blog/tags/grafana">grafana</a><a class="margin-horiz--sm" href="/blog/tags/raspberrypi">raspberrypi</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/02/05/questdb-release-5-0-6-postgres-wire"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« QuestDB 5.0.6 Release Highlights, January 2021</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/01/18/low-code-bitcoin-ticker-workflow-with-time-series-database"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">A low-code bitcoin ticker built with QuestDB and n8n.io Â»</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">ë¬¸ìíê¸°</h3><p class="description_Bwvi">ì´ë©ì¼ì ìë ¥íìë©´ ìê°ìë£ë¥¼ ë³´ë´ëë¦½ëë¤.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">ë³´ë´ê¸°</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>ì¸íë¼ê´ë¦¬ë¶í° ìë¹ì¤ì´ìê¹ì§ í´ë¼ì°ëíê²½ì ìµì íë í´ë¼ì°ë ë¤ì´í°ë¸ íë«í¼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright Â© 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.a0cde2ea.js" defer="defer"></script>
<script src="/gitplechat.js"></script>
</body>
</html>