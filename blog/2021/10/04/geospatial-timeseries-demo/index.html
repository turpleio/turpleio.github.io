<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">Demo geospatial and timeseries queries on 250k unique devices | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="Demo geospatial and timeseries queries on 250k unique devices | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="We now support geospatial data in our time series database by adding geohashes to our type system along with language features to support common operations using this type."><meta data-react-helmet="true" name="twitter:description" content="We now support geospatial data in our time series database by adding geohashes to our type system along with language features to support common operations using this type."><meta data-react-helmet="true" property="og:description" content="We now support geospatial data in our time series database by adding geohashes to our type system along with language features to support common operations using this type."><meta data-react-helmet="true" name="twitter:title" content="Demo geospatial and timeseries queries on 250k unique devices | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Demo geospatial and timeseries queries on 250k unique devices | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" name="keywords" content="geospatial,timeseries,database,geodata,postgis"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/2021-10-04/banner.png"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/2021-10-04/banner.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">Demo geospatial and timeseries queries on 250k unique devices</h1><time datetime="2021-10-04T00:00:00.000Z" class="date_A31P">October 4, 2021 · 11 min read</time><div class="avatar margin-vert--md"><a href="https://github.com/bluestreak01" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/bluestreak01" alt="Vlad Ilyushchenko"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/bluestreak01" target="_blank" rel="noopener noreferrer">Vlad Ilyushchenko</a></h4><small class="avatar__subtitle">QuestDB Team</small></div></div></header><div class="markdown"><p>The last significant features we shipped dealt with out-of-order data ingestion,
and we focused our efforts on hitting the highest write-throughput that we could
achieve for that release. Our latest feature highlight adds space as a new
dimension that our database can manage and allows users to work with data sets
that have spatial and time components.</p><p>We shipped an initial implementation with software release version 6.0.5, and
we&#x27;ve updated <a href="https://demo.questdb.io/" target="_blank" rel="noopener noreferrer">our demo instance</a> so anyone can test
these features out. To help with running queries on this sort of data, we&#x27;ve
included an example data set which simulates 250,000 moving objects, and we&#x27;ve
provided examples in the SQL editor to demo common types of queries.</p><p>This blog post is mainly for people who work with geospatial data struggling
with performance, are looking for new tooling, or need to track changes in
geodata over time. This post should also be interesting for those who want to
read about how we added geospatial support to our time series database from a
technical perspective.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-are-geohashes"></a>What are geohashes?<a class="hash-link" href="#what-are-geohashes" title="Direct link to heading">#</a></h2><p>Geohashes work by dividing the Earth into 32 separate grids, and each grid is
assigned an alphanumeric character. We can increase the precision by
sub-dividing each grid into 32 again and adding a new alphanumeric character.
The result is a base32 alphanumeric string that we call a geohash, with greater
precision obtained with longer-length strings.</p><figure><img alt="An illustration showing two maps with different geohash precision levels applied" class="image_Pw1y margin_Rc0b shadow_7z-4" height="598" src="/img/blog/2021-09-13/geohashes.png" width="650"></figure><p>To support geospatial data, we added a new <code>geohash</code> type which would allow
special handling of geohashes. We&#x27;ll take a look at the syntax we introduced in
the <a href="#questdb-geohash-syntax-and-storage">language additions section below</a>, but
first, let&#x27;s get an idea of what a geohash represents in terms of geographic
area, we can take a few examples and compare the resulting grid size:</p><table><thead><tr><th>Type</th><th>Example</th><th>Area (precision)</th></tr></thead><tbody><tr><td><code>geohash(1c)</code></td><td><code>u</code></td><td>5,000km × 5,000km</td></tr><tr><td><code>geohash(3c)</code></td><td><code>u33</code></td><td>156km × 156km</td></tr><tr><td><code>geohash(6c)</code></td><td><code>u33d8b</code></td><td>1.22km × 0.61km</td></tr><tr><td><code>geohash(12c)</code></td><td><code>u33d8b121234</code></td><td>37.2mm × 18.6mm</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="mapping-geohashes"></a>Mapping geohashes<a class="hash-link" href="#mapping-geohashes" title="Direct link to heading">#</a></h3><p>To place geohashes on a map, we need to know the bounding coordinates of the
corners of each grid. There&#x27;s a very helpful script by Chris Veness that allows
users to input latitude and longitude coordinates and
<a href="https://www.movable-type.co.uk/scripts/geohash.html" target="_blank" rel="noopener noreferrer">maps the equivalent geohash</a>.
In this case, the precision of the returned geohash is based on the decimal
places of the lat/long coordinates.</p><p>The inverse calculation from geohash to latitude and longitude follows a similar
logic but instead requires creating a bounding box comprising four corners of
the grid. To calculate the geohash bounding box and place it on a map, we can
use a function similar to this example:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><div tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4"># calculates the lat long bounds of a geohash</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">def</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">bounds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">geohash</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  base32 </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;0123456789bcdefghjkmnpqrstuvwxyz&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  evenBit </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">True</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  latMin </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">  </span><span class="token operator" style="color:#ff79c6">-</span><span class="token number" style="color:#50fa7b">90</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  latMax </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">  </span><span class="token number" style="color:#50fa7b">90</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  lonMin </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token number" style="color:#50fa7b">180</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  lonMax </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">180</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> char </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> geohash</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    idx </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> base32</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">index</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">char</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> n </span><span class="token keyword" style="color:#ff79c6">in</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">range</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#50fa7b">4</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      bitN </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> idx </span><span class="token operator" style="color:#ff79c6">&gt;&gt;</span><span class="token plain"> n </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> evenBit</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4"># longitude</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        lonMid </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">lonMin</span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain">lonMax</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">2</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bitN </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          lonMin </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> lonMid</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          lonMax </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> lonMid</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4"># latitude</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        latMid </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">latMin</span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain">latMax</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">2</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bitN </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          latMin </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> latMid</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          latMax </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> latMid</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      evenBit </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">not</span><span class="token plain"> evenBit</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  bounds </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&#x27;sw&#x27;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">latMin</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> lonMin</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;ne&#x27;</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">latMax</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> lonMax</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> bounds</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&#x27;u09tvw0r2&#x27;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4"># {&#x27;sw&#x27;: (48.85744571685791, 2.3514175415039062), &#x27;ne&#x27;: (48.85748863220215, 2.3514604568481445)}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Once we have the coordinates in latitude and longitude, we can use standard
mapping tools to visualize geohashes by creating bounding boxes like the
following example, which uses <a href="https://plotly.com/" target="_blank" rel="noopener noreferrer">plotly</a> via Python:</p><figure><img alt="An example geohash plotted on a map using plotly via Python" class="image_Pw1y margin_Rc0b shadow_7z-4" height="598" src="/img/blog/2021-10-04/plotly.png" width="650"></figure><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="questdb-geohash-syntax-and-storage"></a>QuestDB geohash syntax and storage<a class="hash-link" href="#questdb-geohash-syntax-and-storage" title="Direct link to heading">#</a></h2><p>The syntax we chose for column definitions follows the format
<code>geohash(&lt;precision&gt;)</code> where precision can be between one and twelve characters
or directly binary values. Precision is specified as <code>n{units}</code> where <code>units</code>
may be either <code>c</code> for char or <code>b</code> for bits (<code>c</code> being shorthand for 5 x <code>b</code>).
For example, the geohash <code>u33d8b</code> is represented by six characters, so we can
store this in a <code>geohash(6c)</code> column.</p><p>We decided against using strings to represent geohash values as this is
inefficient for both storage and value comparison, so we chose to add geohash
literals. The literal syntax that we use has the format of a single <code>#</code> hash
prefixing the geohash value for chars and two <code>##</code> hashes for binary:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">-- Create two geohash columns with different precision</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">CREATE TABLE geo_data (g5c geohash(5c), g29b geohash(29b));</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">-- Inserting geohash literals</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">INSERT INTO geo_data VALUES(#u33d8, ##10101111100101111111101101101)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">-- Querying by geohash</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT * FROM geo_data WHERE g5c = #u33d8;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In terms of storage for geohash values internally, we use four different
categories based on how much storage each geohash would require. We break
geohashes down into the following types internally:</p><ul><li>Up to 7-bit geohashes are stored as 1 <code>byte</code></li><li>8-bit to 15-bit geohashes are stored in 2 <code>bytes</code></li><li>16-bit to 31-bit geohashes are stored in 4 <code>bytes</code></li><li>32-bit to 60-bit geohashes are stored in 8 <code>bytes</code></li></ul><p>There may be cases where you need the control over storage provided by binary
values but would prefer to work with character-formatted geohashes. We can do
this by including a suffix in the format <code>/{bits}</code> where <code>bits</code> is the number of
bits from 1-60. This way, you can choose specific binary column precision for
storage, but the values passed around use char notation with lower precision:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">-- insert a 5-bit geohash into a 4 bit column</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">INSERT INTO my_geo_data VALUES(#a/4)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">-- insert a 20-bit geohash into an 18 bit column</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">INSERT INTO my_geo_data VALUES(#u33d/18)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="optimizing-for-common-usage-patterns"></a>Optimizing for common usage patterns<a class="hash-link" href="#optimizing-for-common-usage-patterns" title="Direct link to heading">#</a></h2><p>Adding space as a dimension was one side of the problem, but we considered that
many use cases would track moving objects, and common usage patterns would
likely require more than optimized storage and ingestion only. Tracking moving
objects, for instance, is a different problem than stationary entities with a
fixed location (like a lookup table). We wanted to enable users to have
performant query execution on the change of location of an entity over time.
Optimizing these kinds of queries has two obvious solutions:</p><ol><li>perform a geohash lookup first, then search these results by time, or</li><li>search the data by time range, then perform a geohash search within the
results</li></ol><p>We benchmarked these scenarios and chose a time-based search first, followed by
geohash lookup for performance reasons, as we avoid scanning all non-indexed
rows first. Because timestamp columns are already indexed, we leverage
high-performance time-based search and filter the resulting (smaller) data sets.
The most significant performance penalty that we incur is lifting data from the
disk in the first place, so we try to avoid this.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="functions-and-operators"></a>Functions and operators<a class="hash-link" href="#functions-and-operators" title="Direct link to heading">#</a></h3><p>We focused on internal optimizations for the <code>first()</code> and <code>last()</code> functions
used in aggregate queries to make them execute faster. The optimization is
currently restricted to <code>SAMPLE BY</code> queries, and the functions need to be called
on symbol types with an index. The result is that there is a faster execution
time when you would like to retrieve the first or last-known value for a given
object (<code>symbol</code>) within an aggregate bucket.</p><p>To illustrate why this is useful, one example on our demo instance uses
<code>SAMPLE BY 15m</code> to split the results into 15-minute aggregate buckets. When we
use the <code>last(lat)</code> function here, we avoid lifting all data from the disk for
the <code>lat</code> column, but instead read the row ID based on the timestamp index and
instead pick the last value within our aggregate bucket:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT time, last(lat) lat, last(lon) lon, geo6 FROM pos</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">WHERE id = &#x27;YWPCEGICTJSGGBRIJCQVLJ&#x27;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">SAMPLE BY 15m;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In order to take a snapshot of moving objects within a certain area, we
introduced a <code>within</code> operator which evaluates if a comma-separated list of
geohashes is equal to or within another geohash. This operator works on
<code>LATEST BY</code> queries on indexed columns, the <code>device_id</code> column in this snippet,
for example:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT * FROM pos LATEST BY id</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">WHERE geo6 within(#ezz, #u33d8);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The implementation of <code>within</code> was designed to be used with additional
time-based filtering, so that we can efficiently sample data sets in terms of
time and space. The query performance of slicing time and space in this way
should be fast enough to power real-time mapping tools which make use of UI
sliders to jog through slices of time:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI questdb-sql"><div tabindex="0" class="prism-code language-questdb-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT * FROM pos LATEST BY id</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">WHERE geo6 within(#wtq)</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">AND time &lt; &#x27;2021-09-19T00:00:00.000000Z&#x27;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We wanted high-performance prefix-based searches that can execute across
hundreds of thousands of unique values for this operator. To perform this in a
non-naive way, have a &#x27;map-reduce&#x27; approach which splits keys into groups and
performs operations upon such groups in parallel. For <code>within</code>, a task
processing queue slices a range of geohashes, and our worker pool performs
prefix matching:</p><div class="codeBlockContainer_J+bg"><div style="color:#f8f8f2;background-color:#262833" class="codeBlockTitle_oQzk">Vanilla C++ implementation</div><div class="codeBlockContent_csEI cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_rtdJ thin-scrollbar codeBlockWithTitle_ZT05"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">template</span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token keyword" style="color:#ff79c6">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">void</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">filter_with_prefix_generic_vanilla</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">hashes</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">rows</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> rows_count</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">prefixes</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> prefixes_count</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">out_filtered_count</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// input index</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> o </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// output index</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> rows_count</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T current_hash </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> hashes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token function" style="color:#8be9fd">to_local_row_id</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rows</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">bool</span><span class="token plain"> hit </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">false</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">size_t j </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> sz </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> prefixes_count</span><span class="token operator" style="color:#ff79c6">/</span><span class="token number" style="color:#50fa7b">2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> j </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> sz</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">++</span><span class="token plain">j</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T hash </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">static_cast</span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">prefixes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">2</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">j</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T mask </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">static_cast</span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">prefixes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">2</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">j</span><span class="token operator" style="color:#ff79c6">+</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            hit </span><span class="token operator" style="color:#ff79c6">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">current_hash </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hit</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            rows</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">o</span><span class="token operator" style="color:#ff79c6">++</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">out_filtered_count </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#f8f8f2">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We use SIMD across most of our subsystems and use this method for any bulk data
processing. The prefix matching illustrated above has vectorized equivalent so
that we can perform this search operation massively in parallel:</p><div class="codeBlockContainer_J+bg"><div style="color:#f8f8f2;background-color:#262833" class="codeBlockTitle_oQzk">SIMD execution of prefix matching</div><div class="codeBlockContent_csEI cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_rtdJ thin-scrollbar codeBlockWithTitle_ZT05"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">template</span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token keyword" style="color:#ff79c6">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">typename</span><span class="token plain"> </span><span class="token class-name">TVec</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">typename</span><span class="token plain"> </span><span class="token class-name">TVecB</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">void</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">filter_with_prefix_generic</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">hashes</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">rows</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> rows_count</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">prefixes</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> prefixes_count</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">out_filtered_count</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// input index</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> o </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// output index</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">int</span><span class="token plain"> step </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token class-name">TVec</span><span class="token operator" style="color:#ff79c6">::</span><span class="token function" style="color:#8be9fd">size</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">int64_t</span><span class="token plain"> limit </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> rows_count </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> step </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">+=</span><span class="token plain"> step</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token function" style="color:#8be9fd">MM_PREFETCH_T0</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rows </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">64</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        TVec current_hashes_vec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#ff79c6">int</span><span class="token plain"> j </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> j </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> </span><span class="token class-name">TVec</span><span class="token operator" style="color:#ff79c6">::</span><span class="token function" style="color:#8be9fd">size</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">++</span><span class="token plain">j</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            current_hashes_vec</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">insert</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">j</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> hashes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token function" style="color:#8be9fd">to_local_row_id</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rows</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> j</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        TVecB </span><span class="token function" style="color:#8be9fd">hit_mask</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token boolean" style="color:#bd93f9">false</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">size_t j </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> size </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> prefixes_count </span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> j </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> size</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">++</span><span class="token plain">j</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T hash </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">static_cast</span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">prefixes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">2</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> j</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// narrow cast for int/short/byte cases</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> T mask </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">static_cast</span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">prefixes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">2</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> j </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            TVec </span><span class="token function" style="color:#8be9fd">target_hash</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hash</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// broadcast hash</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            TVec </span><span class="token function" style="color:#8be9fd">target_mask</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">mask</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// broadcast mask</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            hit_mask </span><span class="token operator" style="color:#ff79c6">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">current_hashes_vec </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain"> target_mask</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> target_hash</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">uint64_t</span><span class="token plain"> bits </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">to_bits</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hit_mask</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bits </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">while</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bits</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#ff79c6">auto</span><span class="token plain"> idx </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">bit_scan_forward</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bits</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                rows</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">o</span><span class="token operator" style="color:#ff79c6">++</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> idx</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                bits </span><span class="token operator" style="color:#ff79c6">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">~</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#50fa7b">1ull</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&lt;&lt;</span><span class="token plain"> idx</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// for loop same as previous example...</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">out_filtered_count </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>One of the benefits of SIMD-based data processing is that we do not have to rely
on external indexes. This follows our original ethos of not introducing
additional data structures until absolutely necessary.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-we-learned"></a>What we learned<a class="hash-link" href="#what-we-learned" title="Direct link to heading">#</a></h2><p>As we began working with geospatial data sets, we found that there tends to be a
lot of data noise in specific scenarios. Specifically, we saw noisy data when
objects send location updates but are not moving for a particular time. Our
initial implementation does not solve this completely, but we are looking at
ways to add mechanisms that discard similar entries within certain bounds to
eliminate duplication of records.</p><p>When adding our test data set with 250k objects, we estimated the number of
unique symbols that QuestDB could easily handle was 100k or less before
encountering performance issues. The example data set we are currently using
shows that we can store and query up to 250k unique symbol values or more.</p><p>Adding support for geospatial data was a great challenge for us, and we think we
found novel approaches for the storage model and optimizations for common usage
patterns that yielded surprisingly good performance results. We&#x27;re happy to
share our findings, and we&#x27;re eagerly awaiting feedback on these features, which
you can try directly on our live demo or via our latest releases.</p><hr><p>If you have have feedback or questions about this article, feel free ask in our
<a href="https://slack.questdb.io/" target="_blank" rel="noopener noreferrer">Slack Community</a> or browse the
<a href="https://github.com/questdb/questdb" target="_blank" rel="noopener noreferrer">project on GitHub</a> where we welcome
contributions of all kinds.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/demo">demo</a><a class="margin-horiz--sm" href="/blog/tags/release">release</a><a class="margin-horiz--sm" href="/blog/tags/engineering">engineering</a><a class="margin-horiz--sm" href="/blog/tags/geospatial">geospatial</a><a class="margin-horiz--sm" href="/blog/tags/postgis">postgis</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/11/01/plotly-finnhub-realtime-dashboard"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Real-time stock price dashboard using QuestDB, Python and Plotly</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/10/01/hacktoberfest-questdb"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Join Hacktoberfest 2021 and contribute to QuestDB! »</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">문의하기</h3><p class="description_Bwvi">이메일을 입력하시면 소개자료를 보내드립니다.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">보내기</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>인프라관리부터 서비스운영까지 클라우드환경에 최적화된 클라우드 네이티브 플랫폼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright © 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.3e047ba9.js" defer="defer"></script>
</body>
</html>