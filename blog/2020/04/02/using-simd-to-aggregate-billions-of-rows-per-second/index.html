<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">Aggregating billions of rows per second with SIMD | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="Aggregating billions of rows per second with SIMD | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="How SIMD instructions make aggregations faster in QuestDB, including benchmark results and a comparison with Postgres."><meta data-react-helmet="true" name="twitter:description" content="How SIMD instructions make aggregations faster in QuestDB, including benchmark results and a comparison with Postgres."><meta data-react-helmet="true" property="og:description" content="How SIMD instructions make aggregations faster in QuestDB, including benchmark results and a comparison with Postgres."><meta data-react-helmet="true" name="twitter:title" content="Aggregating billions of rows per second with SIMD | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Aggregating billions of rows per second with SIMD | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" name="keywords" content="performance,simd,parallelization,cpu,questdb"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/2020-04-02/banner.png"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/2020-04-02/banner.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">Aggregating billions of rows per second with SIMD</h1><time datetime="2020-04-02T00:00:00.000Z" class="date_A31P">April 2, 2020 Â· 7 min read</time><div class="avatar margin-vert--md"><a href="https://github.com/TheTanc" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/TheTanc" alt="Tancrede Collard"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/TheTanc" target="_blank" rel="noopener noreferrer">Tancrede Collard</a></h4><small class="avatar__subtitle">QuestDB Team</small></div></div></header><div class="markdown"><figure><img alt="QuestDB release 4.2 banner" class="image_1-Fc" height="143" src="/img/blog/2020-04-02/banner.png" width="650"></figure><p><a href="https://en.wikipedia.org/wiki/SIMD" target="_blank" rel="noopener noreferrer">SIMD instructions</a> are specific CPU
instruction sets for arithmetic calculations that use synthetic parallelization.
This approach allows us to perform the same calculations and operations on
numerous data points simultaneously. This post describes how SIMD works with
typical operation performance and describes additional optimizations we managed
to achieve.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-are-simd-operations"></a>What are SIMD operations?<a class="hash-link" href="#what-are-simd-operations" title="Direct link to heading">#</a></h2><p>Instead of spreading the work across CPU cores, SIMD performs vector operations
on multiple items using a <strong>single</strong> CPU instruction. In practice, if you were
to add 8 numbers together, SIMD does that in 1 operation instead of 8. We get
compounded performance improvements by combining SIMD with actual
parallelisation and spanning the work across CPUs.</p><p>QuestDB 4.2 introduces SIMD instructions, which made our aggregations faster by
100x! QuestDB is available open source (Apache 2.0) . If you like what we do,
please consider <a href="https://" target="_blank" rel="noopener noreferrer">starring our repo</a> following us on GitHub and
starring our project.</p><p>As of now, SIMD operations are available for non-keyed aggregation queries, such
as <code>select sum(value) from table</code>. In future releases, we will extend these to
keyed aggregations, for example <code>select key, sum(value) from table</code> (note the
intentional omission of <code>GROUP BY</code>). This will also result in ultrafast
aggregation for time bucketed queries using <code>SAMPLE BY</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-much-faster-is-simd"></a>How much faster is SIMD?<a class="hash-link" href="#how-much-faster-is-simd" title="Direct link to heading">#</a></h2><p>We ran performance tests using 2 different CPUs: the
<a href="https://ark.intel.com/content/www/us/en/ark/products/134899/intel-core-i7-8850h-processor-9m-cache-up-to-4-30-ghz.html" target="_blank" rel="noopener noreferrer">Intel 8850H</a>
and the
<a href="https://www.amd.com/en/products/cpu/amd-ryzen-9-3900x" target="_blank" rel="noopener noreferrer">AMD Ryzen 3900X</a>. Both
were running on 4 threads.</p><table><thead><tr><th>Test</th><th>Query</th></tr></thead><tbody><tr><td>sum of 1Bn doubles <br> no nulls</td><td>create table zz as (select rnd_double() d from long_sequence(1000000000)); <br> select sum(d) from zz;</td></tr><tr><td>sum of 1Bn ints</td><td>create table zz as (select rnd_int() i from long_sequence(1000000000)); <br> select sum(i) from zz;</td></tr><tr><td>sum of 1Bn longs</td><td>create table zz as (select rnd_long() l from long_sequence(1000000000));<br>select sum(l) from zz;</td></tr><tr><td>max of 1Bn doubles</td><td>create table zz as (select rnd_double() d from long_sequence(1000000000));<br>select max(d) from zz;</td></tr><tr><td>max of 1Bn longs</td><td>create table zz as (select rnd_long() l from long_sequence(1000000000));<br>select max(l) from zz;</td></tr></tbody></table><p><img alt="Intel 8850H benchmark" src="/assets/images/benchmark8850h-80849f4bc8104dfa9761795ec62b284d.png"></p><p><img alt="AMD 3900X benchmark" src="/assets/images/benchmark3900x-ebfc53da30cc1b3fb28267640318e0f4.png"></p><p>The dataset producing the results shown above does not contain NULL values.
Interestingly, when introducing nulls, QuestDB sum() query time is unchanged.
This can be tested by creating the table as follows.</p><table><thead><tr><th>Test</th><th>Query</th></tr></thead><tbody><tr><td>sum of 1Bn doubles <br>(nulls)</td><td>create table zz as (select rnd_double(5) d from long_sequence(1000000000));<br>select sum(d) from zz;</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-can-we-improve-upon-simd-performance"></a>How can we improve upon SIMD performance?<a class="hash-link" href="#how-can-we-improve-upon-simd-performance" title="Direct link to heading">#</a></h3><p>Our approach is currently slightly more complicated as we convert each 32-bit
integer to a 64-bit long to avoid overflow. By removing this overhead and more,
there is scope left to make our implementation faster in the future.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="benchmarking-questdb-versus-postgres-performance"></a>Benchmarking QuestDB versus Postgres performance<a class="hash-link" href="#benchmarking-questdb-versus-postgres-performance" title="Direct link to heading">#</a></h2><p>The execution times outlined above become more interesting once put into
context. This is how QuestDB compares to Postgres when doing a sum of 1 billion
numbers from a given table <code>select sum(d) from 1G_double_nonNull</code>.</p><p><img alt="Benchmark results for QuestDB vs PostgreSQL" src="/assets/images/benchmarkPostgres-123156ab6707851d179aced29fdb6d7a.png"></p><p>We found that our performance figures are constrained by the available memory
channels. Both the 8850H and the 3900X have 2 memory channels, and throwing more
than 4 cores at the query above does not improve the performance. On the other
hand, if the CPU has more memory channels, then performance scales almost
linearly.</p><p>To get an idea of the impact of memory channels, we spun off a m5.metal instance
on AWS. This instance has two 24-core Intel 8275CL with 6 memory channels each.
Here are the results compared to the 2-channel 3900X:</p><table><thead><tr><th>cpu cores</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr></thead><tbody><tr><td>8275CL</td><td>910</td><td>605</td><td>380</td><td>240</td><td>193</td><td>176</td><td>156</td><td>148</td><td>140</td><td>136</td><td>133</td><td>141</td></tr><tr><td>3900X</td><td>621</td><td>502</td><td>381</td><td>260</td><td>260</td><td>260</td><td>260</td><td>260</td><td>260</td><td>260</td><td>260</td><td>260</td></tr></tbody></table><p>We plot those results below on the left. On the right-hand side, we normalise
the results for each CPU and plot the performance improvement of going from 1 to
more cores.</p><p><img alt="Charts showing the execution time for the Intel 8275CL and AMD 3900X when using a various number of cores" src="/assets/images/memoryChannelAnalysis-f808e7d8d8017faf6c8bc8ca37136434.png"></p><p>Interestingly, the 2-channel 3900X, is much faster on 1 core than the 8275CL.
But it does not scale well and hits a performance ceiling at 4 cores. This is
because it only has 2 memory channels that are already saturated. The 6-channel
8275CL allows QuestDB to scale almost linearly as we add more CPU cores and hits
a performance ceiling at around 12 cores.</p><p>Unfortunately AWS CPUs are hyperthreaded. We could unpack even more performance
if CPU were fully isolated to run the computations.</p><p>We did not get our hands on CPUs with more memory channels for this test, but if
you have easy access to 8 or 12-channel servers and would like to benchmark
QuestDB, we&#x27;d love to hear the results. You can
<a href="/docs/">download QuestDB</a> and leave a
<a href="https:///issues/146" target="_blank" rel="noopener noreferrer">comment on github</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-we-will-improve-time-series-data-performance"></a>How we will improve time series data performance<a class="hash-link" href="#how-we-will-improve-time-series-data-performance" title="Direct link to heading">#</a></h2><p>In further releases, we will roll out this functionality to other parts of our
SQL implementation. QuestDB implements SIMD in a generic fashion, which will
allow us to continue adding SIMD to about everything our SQL engine does, such
as keyed aggregations, indexing etc. We will also keep improving QuestDB&#x27;s
performance. Through some further work on assembly, we estimate that we can gain
another 15% speed on these operations. In the meantime, if you want to know
exactly how we have achieved this, all of our code is
<a href="https://" target="_blank" rel="noopener noreferrer">open source</a>!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="about-the-release-questdb-42"></a>About the release: QuestDB 4.2<a class="hash-link" href="#about-the-release-questdb-42" title="Direct link to heading">#</a></h2><p>We have implemented SIMD-based vector execution of queries, such as
<code>select sum(value) from table</code>. This is ~100x faster than non-vector based
execution. This is just the beginning as we will introduce vectors to more
operations going forward. Try our first implementation in this release - stay
tuned for more features in the upcoming releases!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="important"></a>Important<a class="hash-link" href="#important" title="Direct link to heading">#</a></h3><p>Metadata file format has been changed to include a new flag for columns of type
symbol. It is necessary to convert existing tables to new format. Running the
following SQL: <code>repair table myTable</code> will update the table metadata.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-is-new"></a>What is new?<a class="hash-link" href="#what-is-new" title="Direct link to heading">#</a></h3><ul><li>Java: vectorized sum(), avg(), min(), max() for DOUBLE, LONG, INT</li><li>Java: select distinct symbol optimisation</li><li>FreeBSD support</li><li>Automatically restore data consistency and recover from partial data loss.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-we-fixed"></a>What we fixed<a class="hash-link" href="#what-we-fixed" title="Direct link to heading">#</a></h3><ul><li>SQL: NPE when parsing SQL text with malformed table name expression , for
example &#x27;)&#x27;, or &#x27;, blah&#x27;</li><li>SQL: parsing &#x27;fill&#x27; clause in sub-query context was causing unexpected syntax
error (#115)</li><li>SQL: possible internal error when ordering result of group-by or sample-by</li><li>Data Import: Ignore byte order marks (BOM) in table names created from an
imported CSV (#114)</li><li>SQL: &#x27;timestamp&#x27; propagation thru group-by code had issues. sum() was tripping
over null values. Added last() aggregate function. (#113)</li><li>LOG: make service log names consistent on windows (#106)</li><li>SQL: deal with the following syntax &#x27;select * from select ( select a from
....)&#x27;</li><li>SQL: allow the following syntax &#x27;case cast(x as int) when 1 then ...&#x27;</li><li>fix(griffin): syntax check for &quot;case&quot;-&#x27;)&#x27; overlap, e.g. &quot;a + (case when .. )
end&quot;</li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/benchmark">benchmark</a><a class="margin-horiz--sm" href="/blog/tags/performance">performance</a><a class="margin-horiz--sm" href="/blog/tags/simd">simd</a><a class="margin-horiz--sm" href="/blog/tags/release">release</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2020/05/12/interesting-things-we-learned-about-sums"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Things we learned about sums</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2019/12/19/lineprot"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Speeding up InfluxDB line protocol Â»</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">ë¬¸ìíê¸°</h3><p class="description_Bwvi">ì´ë©ì¼ì ìë ¥íìë©´ ìê°ìë£ë¥¼ ë³´ë´ëë¦½ëë¤.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">ë³´ë´ê¸°</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>ì¸íë¼ê´ë¦¬ë¶í° ìë¹ì¤ì´ìê¹ì§ í´ë¼ì°ëíê²½ì ìµì íë í´ë¼ì°ë ë¤ì´í°ë¸ íë«í¼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright Â© 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.3e047ba9.js" defer="defer"></script>
</body>
</html>