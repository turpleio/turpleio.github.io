<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="turpleio">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Turple: Cloud Native Platform" href="/opensearch.xml">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Turple: Cloud Native Platform Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Turple: Cloud Native Platform Blog Atom Feed"><title data-react-helmet="true">Community contribution from Alex Pelagenko improving our HTTP server | Turple: Cloud Native Platform</title><meta data-react-helmet="true" property="og:title" content="Community contribution from Alex Pelagenko improving our HTTP server | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="description" content="One of QuestDB’s major contributors, Alex Pelagenko, shares his experience on improving QuestDB’s HTTP server."><meta data-react-helmet="true" name="twitter:description" content="One of QuestDB’s major contributors, Alex Pelagenko, shares his experience on improving QuestDB’s HTTP server."><meta data-react-helmet="true" property="og:description" content="One of QuestDB’s major contributors, Alex Pelagenko, shares his experience on improving QuestDB’s HTTP server."><meta data-react-helmet="true" name="twitter:title" content="Community contribution from Alex Pelagenko improving our HTTP server | Turple: Cloud Native Platform"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Community contribution from Alex Pelagenko improving our HTTP server | Turple: Cloud Native Platform&quot;"><meta data-react-helmet="true" property="og:image" content="https://turpleio.github.io/img/blog/2020-11-16/banner.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://turpleio.github.io/img/blog/2020-11-16/banner.jpg"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/assets/css/styles.4f6557e4.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Turple: Cloud Native Platform">
<meta itemprop="description" content="Turple is a cloud native platform which can help you build and operate your services on cloud.">
<meta itemprop="url" content="https://turpleio.github.io">
<meta itemprop="logo" content="https://turpleio.github.io/img/favicon.png">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">QuestDB</a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="wrapper_DIJ0 blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_q+wC thin-scrollbar"><h3 class="sidebarItemTitle_9G5K">Recent posts</h3><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/19/merry-questmas-gifts-2023">Merry Questmas! Here are your gifts for 2023...</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/12/13/using-prometheus-loki-grafana-monitor-questdb-kubernetes">Using Prometheus, Loki, and Grafana to monitor QuestDB in Kubernetes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/30/full-table-scan-are-fast">Listen to Your CPU - Full-table Scans Are Fast</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/25/questdb-6.6.1-dynamic-commits">QuestDB 6.6.1 - Dynamic Commits</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/23/sql-extensions-time-series-data-questdb-part-ii">SQL Extensions for Time Series Data in QuestDB - Part II</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="title_KBQu">Community contribution from Alex Pelagenko improving our HTTP server</h1><time datetime="2020-11-16T00:00:00.000Z" class="date_A31P">November 16, 2020 · 3 min read</time><div class="avatar margin-vert--md"><a href="https://github.com/ideoma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/ideoma" alt="Alex Pelagenko"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/ideoma" target="_blank" rel="noopener noreferrer">Alex Pelagenko</a></h4><small class="avatar__subtitle">QuestDB Contributor</small></div></div></header><div class="markdown"><figure><img alt="Close-up on a dark computer keyboard." class="image_1-Fc image--title_Z46g" height="391" src="/img/blog/2020-11-26/banner.jpg" width="650"><figcaption class="caption_VLGg"> Photo by<a href="https://unsplash.com/photos/1osIUArK5oA" target="_blank" rel="noopener noreferrer">Florian Krumm</a> on<a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a> </figcaption></figure><p>I have recently made a sizable contribution to QuestDB’s code and wanted to
share my experience and feedback while it is still fresh in my head. I am not a
complete outsider for the project and know Vlad personally but other than that
it was voluntary to add a few lines of code to a project I like.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-http-server-for-questdb"></a>The HTTP server for QuestDB<a class="hash-link" href="#the-http-server-for-questdb" title="Direct link to heading">#</a></h2><p>QuestDB has a custom HTTP stack that uses non-blocking socket IO via a thin
layer of JNI OS abstraction. Non-blocking IO is handled via two state machines.
One for inbound traffic, which includes a series of parsing state machines. The
other for outbound traffic. We focus on the outbound traffic state machine,
which has to deal with two types of interruptions: slow socket on one side and
data availability on the other. While slow socket interruption was already dealt
with, the data availability interruption had been handled in a very trivial
manner. When data was unavailable, the HTTP stack would report an immediate
error and trigger a send-to-socket state machine.</p><p>Data availability interruptions are due to QuestDB’s single writer model. A
table will be locked while the HTTP server is dealing with a CSV import request.
A request to alter the locked table will bounce back with an error. Why is this
interesting? It is a difficult problem of coordination amongst threads while at
the same time keeping the whole stack non-blocking.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-i-added-queuing-to-questdbs-http-stack"></a>How I added queuing to QuestDB&#x27;s HTTP stack<a class="hash-link" href="#how-i-added-queuing-to-questdbs-http-stack" title="Direct link to heading">#</a></h2><p>The first hurdle was to understand the stack, which is hard to follow at first
glance. Control is passed around via both conditional statements and exception
mechanisms. The thread messaging stack is also unusual. The API is
non-blocking - the thread must find another task if the outbound queue is full
or the inbound queue is empty.</p><p>Instead of rejecting requests due to data availability errors, I added a queuing
system that catches the state of these requests in a priority queue. This queue
is then processed by idle threads (idle because of IO interruptions) and retried
at exponentially increasing intervals. For example the first retry will happen
in 2ms then in 4ms, 8ms, 16ms … 512ms, 1s, 1s, 1s. The retry interval is a
configuration parameter. Following this addition, operations are queued on the
server, meaning that the user does not have to deal with errors or attempt to do
this operation again. This piece of code processes priority queue:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><div tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">private boolean sendToOutQueue() {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  boolean useful = false;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   final long now = clock.getTicks();</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   while (nextRerun.size() &gt; 0) {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       Retry next = nextRerun.peek();</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       if (next.getAttemptDetails().nextRunTimestamp &lt;= now) {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">           useful = true;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">           Retry retry = nextRerun.poll();</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">           if (!sendToOutQueue(retry)) {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">               nextRerun.add(retry);</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">               return true;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">           }</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       }</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       else {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">           // All reruns are in the future.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">           return useful;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">       }</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   }</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   return useful;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>QuestDB’s team was very patient explaining the different bits of the HTTP stack
and guiding me to figure out how best to solve the multi writing problem. They
were also careful not to dampen my enthusiasm with the pull request feedback.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/community">community</a><a class="margin-horiz--sm" href="/blog/tags/engineering">engineering</a><a class="margin-horiz--sm" href="/blog/tags/architecture">architecture</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2020/11/26/why-timeseries-data"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« What is time-series data, and why are we building a time-series database (TSDB)?</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2020/10/20/authentication-for-influx-line-protocol"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Authentication for InfluxDB line protocol »</div></a></div></nav></div></main></div></div><div class="root_0lLS"><div class="cards_xeZk"><div class="root_R798 skinPrimary_JHOH"><svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="38" fill="#1E1F27"></circle><path d="M56.99 18.792a.817.817 0 00-.117-.303c-.01-.02-.02-.05-.03-.069-.01-.02-.029-.029-.048-.049a.912.912 0 00-.137-.136l-.117-.088c-.02-.01-.03-.03-.05-.04-.029-.01-.068-.029-.107-.039a.85.85 0 00-.146-.049 1.075 1.075 0 00-.176-.019h-.147a1.15 1.15 0 00-.196.049c-.029.01-.068.01-.097.02L12.59 36.67a.979.979 0 00-.509 1.29c.098.216.264.401.48.5l16.07 7.556v15.025c0 .537.44.977.978.977a.964.964 0 00.831-.469l6.794-11.046 10.499 5.533a.974.974 0 001.408-.655l7.84-36.2v-.058c.01-.058.01-.107.019-.156 0-.059 0-.117-.01-.176zM29.413 44.208L15.376 37.6l36.326-15.68-22.289 22.288zm1.174 13.363V47.004l4.917 2.59-4.917 7.977zm16.92-3.87l-9.237-4.86-1.662-1.026-.068.118-5.289-2.786 23.1-23.12L47.508 53.7z" fill="#fff"></path></svg><h3 class="title_BHe0">문의하기</h3><p class="description_Bwvi">이메일을 입력하시면 소개자료를 보내드립니다.</p><div class="content_gAr2"><form class="root_teCd"><div><div class="inputs_0wQ8"><input type="email" class="input_cjQx input_a6pP" name="email" required="" pattern="^[a-zA-Z0-9.!#$%&amp;&#x27;*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$" placeholder="Email address" title="Email address should be valid"><button class="submit_poRs button_f7Ff button--tertiary_vtfp button--uppercase_ESEN" type="submit">보내기</button></div></div></form></div></div></div></div></div><footer class="root_JnvJ"><div class="content_-gfC center_S24y"><img alt="QuestDB logo" class="logo_JrwJ" src="/img/navbar/tp_brand.png" width="108" height="27"><div class="tagline_T1tH"><p>인프라관리부터 서비스운영까지 클라우드환경에 최적화된 클라우드 네이티브 플랫폼</p></div><div class="links_1SgP"></div></div><div class="border_PW0V"><div class="bottom_wPs3 center_S24y">Copyright © 2023 Gitple. All rights are reserved.</div></div></footer></div>
<script src="/assets/js/main.185a1183.js" defer="defer"></script>
</body>
</html>