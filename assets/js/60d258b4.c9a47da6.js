"use strict";(self.webpackChunkquestdb_io=self.webpackChunkquestdb_io||[]).push([[5276],{3905:function(e,t,a){a.d(t,{Zo:function(){return l},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),c=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},l=function(e){var t=c(e.components);return n.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=c(a),m=r,h=d["".concat(p,".").concat(m)]||d[m]||u[m]||i;return a?n.createElement(h,o(o({ref:t},l),{},{components:a})):n.createElement(h,o({ref:t},l))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=d;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},9435:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return u}});var n=a(3117),r=a(102),i=(a(7294),a(3905)),o=["components"],s={title:"Backup and restore",sidebar_label:"Backup and restore",description:"Details and resources which describe how to perform database backup and restore operations for a QuestDB instance using point-in-time backups and filesystem images."},p={unversionedId:"operations/backup",id:"operations/backup",isDocsHomePage:!1,title:"Backup and restore",description:"Details and resources which describe how to perform database backup and restore operations for a QuestDB instance using point-in-time backups and filesystem images.",source:"@site/docs/operations/backup.md",sourceDirName:"operations",slug:"/operations/backup",permalink:"/docs/operations/backup",editUrl:"https://github.com/turpleio/homepage/edit/main/docs/operations/backup.md",version:"current",sidebar_label:"Backup and restore",frontMatter:{title:"Backup and restore",sidebar_label:"Backup and restore",description:"Details and resources which describe how to perform database backup and restore operations for a QuestDB instance using point-in-time backups and filesystem images."},sidebar:"docs",previous:{title:"Health monitoring",permalink:"/docs/operations/health-monitoring"},next:{title:"Updating data",permalink:"/docs/operations/updating-data"}},c=[{value:"Limitations",id:"limitations",children:[]},{value:"Creating a point-in-time backup",id:"creating-a-point-in-time-backup",children:[]},{value:"Creating a filesystem backup (disk snapshot)",id:"creating-a-filesystem-backup-disk-snapshot",children:[]},{value:"Restoring from a backup",id:"restoring-from-a-backup",children:[]},{value:"Examples",id:"examples",children:[]}],l={toc:c};function u(e){var t=e.components,a=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},l,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This document provides practical details of using the point-in-time backup\nfunctionality in QuestDB along with filesystem backup as means to prevent data\nloss. Alongside backup details, this document describes how to restore from\nbackups and hints for performing filesystem backups on common cloud providers."),(0,i.kt)("p",null,"QuestDB provides two strategies for creating backups:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Point-in-time")," (PIT) backup"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Filesystem")," backup")),(0,i.kt)("h2",{id:"limitations"},"Limitations"),(0,i.kt)("p",null,"QuestDB officially supports the following filesystems:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"EXT4"),(0,i.kt)("li",{parentName:"ul"},"APFS"),(0,i.kt)("li",{parentName:"ul"},"NTFS"),(0,i.kt)("li",{parentName:"ul"},"OVERLAYFS (used by Docker)")),(0,i.kt)("p",null,"Other file systems supporting\n",(0,i.kt)("a",{parentName:"p",href:"https://man7.org/linux/man-pages/man2/mmap.2.html"},"mmap")," feature may work with\nQuestDB but they should not be used in production, as QuestDB does not run tests\non them."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"A backup includes the contents of the database up to the point of executing a\nbackup. Any data inserted while a backup is underway is not stored as part of\nthe backup.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Users can't use NFS or a similar distributed filesystem directly with QuestDB,\nbut users may copy a backup to such a filesystem after a backup has been made."))))),(0,i.kt)("h2",{id:"creating-a-point-in-time-backup"},"Creating a point-in-time backup"),(0,i.kt)("p",null,"When creating a point-in-time (PIT) backup in QuestDB, you can specify that the\nwhole database or specific tables should be backed up. This process will create\na backup in a directory specified by the user in the ",(0,i.kt)("inlineCode",{parentName:"p"},"cairo.sql.backup.root"),"\n",(0,i.kt)("a",{parentName:"p",href:"/docs/reference/configuration"},"configuration key"),". For more details on passing\nconfiguration in this manner, see the\n",(0,i.kt)("a",{parentName:"p",href:"/docs/concept/root-directory-structure#serverconf"},"server configuration"),"\ndocumentation."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/path/to/server.conf"',title:'"/path/to/server.conf"'},"cairo.sql.backup.root=/path/to/backup/dir\n")),(0,i.kt)("p",null,"A backup can then be triggered via ",(0,i.kt)("a",{parentName:"p",href:"/docs/reference/sql/backup"},"SQL command")," and\nthe backup is complete as soon as the SQL query has finished executing:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-questdb-sql"},"-- backup whole database\nBACKUP database;\n-- backup a specific table\nBACKUP table my_table;\n")),(0,i.kt)("p",null,"Note that calling ",(0,i.kt)("inlineCode",{parentName:"p"},"BACKUP TABLE <table_name>")," will only copy table data and\nmetadata to the destination folder. This form of backup will not copy entire\ndatabase configuration files required to perform a complete database restore."),(0,i.kt)("p",null,"Alternatively, the ",(0,i.kt)("a",{parentName:"p",href:"/docs/reference/api/rest#exec---execute-queries"},"REST API"),"\ncan be used to execute the SQL for a database backup:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Backing up a database via curl"',title:'"Backing',up:!0,a:!0,database:!0,via:!0,'curl"':!0},'curl -G --data-urlencode "query=BACKUP database;" \\\n  http://localhost:9000/exec\n')),(0,i.kt)("h2",{id:"creating-a-filesystem-backup-disk-snapshot"},"Creating a filesystem backup (disk snapshot)"),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"To run a reliable filesystem backup without database downtime, you should use\n",(0,i.kt)("inlineCode",{parentName:"p"},"SNAPSHOT PREPARE"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"SNAPSHOT COMPLETE"),"\n",(0,i.kt)("a",{parentName:"p",href:"/docs/reference/sql/snapshot"},"SQL statements"),"."))),(0,i.kt)("p",null,"The most common ways to perform cloud-native filesystem snapshots are described\nin the following resources, which rely on similar steps but have minor\ndifferences in terminology and services:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html"},"AWS")," -\ncreating EBS snapshots"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal"},"Azure")," -\ncreating snapshots of a virtual hard disk"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://cloud.google.com/compute/docs/disks/create-snapshots"},"GCP")," - working\nwith persistent disk snapshots")),(0,i.kt)("h2",{id:"restoring-from-a-backup"},"Restoring from a backup"),(0,i.kt)("p",null,"In order to restore a backup, the QuestDB executable must be provided with the\ndirectory location of an existing backup as the ",(0,i.kt)("strong",{parentName:"p"},"root directory"),". This can\ndone via the ",(0,i.kt)("inlineCode",{parentName:"p"},"-d")," flag as ",(0,i.kt)("inlineCode",{parentName:"p"},"-d /path/to/backup")," when starting up QuestDB."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"java -p /path/to/questdb-<version>.jar \\\n     -m io.questdb/io.questdb.ServerMain \\\n     -d /path/to/backup_directory\n")),(0,i.kt)("p",null,"Users who are starting QuestDB via ",(0,i.kt)("inlineCode",{parentName:"p"},"systemd")," or the official AWS AMI may refer\nto the\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/questdb/questdb/blob/master/pkg/ami/marketplace/assets/systemd.service#L21"},"systemd file"),"\nfor reference. To verify that database information has been successfully\nimported, check logs via ",(0,i.kt)("inlineCode",{parentName:"p"},"journalctl -u questdb")," which will contain a list\nexisting tables."),(0,i.kt)("p",null,"Docker instances may have a backup directory mounted to the root directory as\nfollows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'docker run \\\n -p 9000:9000  -p 9009:9009 \\\n -p 8812:8812 -p 9003:9003 \\\n -v "/path/to/backup_directory:/root/.questdb/" questdb/questdb\n')),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The database backup must contain database metadata files and directories (",(0,i.kt)("inlineCode",{parentName:"p"},"db"),",\n",(0,i.kt)("inlineCode",{parentName:"p"},"config")," etc.). The contents of these directories is described in more detail in\nthe ",(0,i.kt)("a",{parentName:"p",href:"/docs/concept/root-directory-structure"},"root directory")," documentation."))),(0,i.kt)("h2",{id:"examples"},"Examples"),(0,i.kt)("p",null,"The following example sets up a cronjob which triggers a daily backup via REST\nAPI:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# this will add crontab record that will run trigger at backup every-day at 01:00 AM\n# copy paste this into server terminal\ncrontab -l | { cat; echo \"0 1 * * * /usr/bin/curl --silent -G --data-urlencode 'query=BACKUP database;' http://localhost:9000/exec &>/dev/null\"; } | crontab -\n")),(0,i.kt)("p",null,"This example shows how to compress a backup using the ",(0,i.kt)("inlineCode",{parentName:"p"},"tar")," utility. An archive\nfile ",(0,i.kt)("inlineCode",{parentName:"p"},"questdb_backup.tar.gz")," will be created in the directory that the command\nis run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"tar -zcvf questdb_backup.tar.gz /path/to/backup\n")),(0,i.kt)("p",null,"The backup file can be expanded using the same utility:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"tar -xf questdb_backup.tar.gz\n")))}u.isMDXComponent=!0}}]);