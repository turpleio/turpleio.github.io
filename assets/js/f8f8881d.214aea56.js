"use strict";(self.webpackChunkquestdb_io=self.webpackChunkquestdb_io||[]).push([[9070],{3905:function(a,e,t){t.d(e,{Zo:function(){return o},kt:function(){return N}});var n=t(67294);function s(a,e,t){return e in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}function r(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(a);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),t.push.apply(t,n)}return t}function m(a){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?r(Object(t),!0).forEach((function(e){s(a,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(t,e))}))}return a}function p(a,e){if(null==a)return{};var t,n,s=function(a,e){if(null==a)return{};var t,n,s={},r=Object.keys(a);for(n=0;n<r.length;n++)t=r[n],e.indexOf(t)>=0||(s[t]=a[t]);return s}(a,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);for(n=0;n<r.length;n++)t=r[n],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(a,t)&&(s[t]=a[t])}return s}var i=n.createContext({}),l=function(a){var e=n.useContext(i),t=e;return a&&(t="function"==typeof a?a(e):m(m({},e),a)),t},o=function(a){var e=l(a.components);return n.createElement(i.Provider,{value:e},a.children)},c={inlineCode:"code",wrapper:function(a){var e=a.children;return n.createElement(n.Fragment,{},e)}},h=n.forwardRef((function(a,e){var t=a.components,s=a.mdxType,r=a.originalType,i=a.parentName,o=p(a,["components","mdxType","originalType","parentName"]),h=l(t),N=s,k=h["".concat(i,".").concat(N)]||h[N]||c[N]||r;return t?n.createElement(k,m(m({ref:e},o),{},{components:t})):n.createElement(k,m({ref:e},o))}));function N(a,e){var t=arguments,s=e&&e.mdxType;if("string"==typeof a||s){var r=t.length,m=new Array(r);m[0]=h;var p={};for(var i in e)hasOwnProperty.call(e,i)&&(p[i]=e[i]);p.originalType=a,p.mdxType="string"==typeof a?a:s,m[1]=p;for(var l=2;l<r;l++)m[l]=t[l];return n.createElement.apply(null,m)}return n.createElement.apply(null,t)}h.displayName="MDXCreateElement"},86951:function(a,e,t){t.r(e),t.d(e,{frontMatter:function(){return l},metadata:function(){return o},toc:function(){return c},default:function(){return N}});var n=t(83117),s=t(80102),r=(t(67294),t(3905)),m=t(46092),p=t(72525),i=["components"],l={title:"A tour of high-frequency finance via the Julia language and QuestDB",author:"Dean Markwick",author_url:"https://github.com/dm13450",author_image_url:"https://avatars.githubusercontent.com/dm13450",description:"Dean Markwick describes high-frequency finance concepts such as trade prices, financial returns, time series autocorrelation, empirical price impact and others via the Julia programming language.",keywords:["timeseries","julialang","trading","marketdata"],tags:["tutorial","julialang","market data","crypto","trading"],image:"/img/blog/shared/og-julia.png"},o={permalink:"/blog/2021/11/22/high-frequency-finance-introduction-julia-lang",source:"@site/blog/2021-11-22-high-frequency-finance-introduction-julia-lang.mdx",title:"A tour of high-frequency finance via the Julia language and QuestDB",description:"Dean Markwick describes high-frequency finance concepts such as trade prices, financial returns, time series autocorrelation, empirical price impact and others via the Julia programming language.",date:"2021-11-22T00:00:00.000Z",formattedDate:"November 22, 2021",tags:[{label:"tutorial",permalink:"/blog/tags/tutorial"},{label:"julialang",permalink:"/blog/tags/julialang"},{label:"market data",permalink:"/blog/tags/market-data"},{label:"crypto",permalink:"/blog/tags/crypto"},{label:"trading",permalink:"/blog/tags/trading"}],readingTime:19.945,truncated:!1,prevItem:{title:"Comparing InfluxDB and QuestDB databases",permalink:"/blog/2021/11/29/questdb-versus-influxdb"},nextItem:{title:"Why I joined QuestDB as a core database engineer",permalink:"/blog/2021/11/09/miguel-arregui-working-at-questdb"}},c=[{value:"What&#39;s the difference between finance and high-frequency finance?",id:"whats-the-difference-between-finance-and-high-frequency-finance",children:[]},{value:"Creating a dataset of crypto trades from Coinbase",id:"creating-a-dataset-of-crypto-trades-from-coinbase",children:[]},{value:"Understanding high frequency prices",id:"understanding-high-frequency-prices",children:[]},{value:"Introduction to financial returns",id:"introduction-to-financial-returns",children:[]},{value:"Correlation and time series autocorrelation",id:"correlation-and-time-series-autocorrelation",children:[]},{value:"Analyzing crypto trades and using empirical price impact",id:"analyzing-crypto-trades-and-using-empirical-price-impact",children:[]},{value:"What we learned about high-frequency finance",id:"what-we-learned-about-high-frequency-finance",children:[]}],h={toc:c};function N(a){var e=a.components,t=(0,s.Z)(a,i);return(0,r.kt)("wrapper",(0,n.Z)({},h,t,{components:e,mdxType:"MDXLayout"}),(0,r.kt)(m.Z,{alt:"The QuestDB logo, and the Julia programming language logo.",height:467,src:"/img/blog/2021-11-22/banner.png",width:650,mdxType:"Banner"}),(0,r.kt)("p",null,"This post comes from Dean Markwick, who has written an excellent tutorial that\nprovides an introduction to high frequency time series using the Julia\nprogramming language and covers commonly-used techniques for constructing\ntrading models of financial assets. Thanks for the submission, Dean!"),(0,r.kt)("h2",{id:"whats-the-difference-between-finance-and-high-frequency-finance"},"What's the difference between finance and high-frequency finance?"),(0,r.kt)("p",null,"I like to think of this question as taking a microscope to finance data and\nmagnifying everything up to see the nitty-gritty. Most people start by\ndownloading daily stock prices from something like Yahoo or Google finance. For\nsome applications, this type of data is enough if you are looking at long-term\ntrends or say differences between countries, but a whole other world is lurking\nunderneath those four daily prices."),(0,r.kt)("p",null,"In the not-so-distant past, getting your hands on more granular data was either\nexpensive or out of reach to the hobbyist, but there has since been a revolution\nthanks to crypto. Now, many crypto exchanges provide their data for free and\nthis combined with some excellent open-source (and free) tools allow you to\nbuild your own little high-frequency research labs."),(0,r.kt)("p",null,"This tutorial will hold your hand and introduce you to the concepts of\nhigh-frequency finance and what makes it different. If you are finance-curious\nthis is the tutorial for you and with Julia and QuestDB I will highlight some of\nthe basic concepts behind modern data-driven finance."),(0,r.kt)("p",null,"This tutorial is broken down into the following sections:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"The dataset:")," what kind of data are we working with?"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Prices:")," what does a high-frequency price source look like?"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Returns:")," how do we prepare the data for analysis and how are the returns\ndistributed?"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Correlations:")," what does the correlation look like between returns?"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Trades:")," how can we measure price impact using high-frequency trades?")),(0,r.kt)("h2",{id:"creating-a-dataset-of-crypto-trades-from-coinbase"},"Creating a dataset of crypto trades from Coinbase"),(0,r.kt)("p",null,"I've written about hooking up to the Coinbase API and storing the results in\nQuestDB. It's a technical post and you can\n",(0,r.kt)("a",{parentName:"p",href:"/blog/2021/09/17/high-frequency-finance-julia-lang"},"read the tutorial here"),".\nBy using the same process as highlighted in that post, I have stored Bitcoin-USD\nexchange rate data and trade data from 09:00 on the 24th of July 2021 to 14:30\non the 25th of July 2021."),(0,r.kt)("p",null,"All the data comes from Coinbase, one of the largest crypto exchanges, and gives\na good picture of what the market looks like. We will be using both the price\ndata and the trade data to perform our analysis."),(0,r.kt)("p",null,"For convenience, these datasets are made available on S3 and can be loaded into\na running QuestDB instance using the REST API:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Download the example data\ncurl https://s3.eu-west-1.amazonaws.com/questdb.io/datasets/hff-tutorial/prices.csv --output prices.csv\ncurl https://s3.eu-west-1.amazonaws.com/questdb.io/datasets/hff-tutorial/trades.csv --output trades.csv\n\n# Import prices\ncurl -F schema=\'[{"name":"timestamp", "type": "TIMESTAMP", "pattern": "yyyy-MM-ddTHH:mm:ss.SSS"}]\' \\\n     -F data=@prices.csv \'http://localhost:9000/imp?&timestamp=timestamp\'\n# Import trades\ncurl -F schema=\'[{"name":"timestamp", "type": "TIMESTAMP", "pattern": "yyyy-MM-ddTHH:mm:ss.SSS"}]\' \\\n     -F data=@trades.csv \'http://localhost:9000/imp?&timestamp=timestamp\'\n')),(0,r.kt)("h2",{id:"understanding-high-frequency-prices"},"Understanding high frequency prices"),(0,r.kt)("p",null,"If we go to Yahoo finance and look at the\n",(0,r.kt)("a",{parentName:"p",href:"https://uk.finance.yahoo.com/quote/AAPL/history?p=AAPL"},"historical data of Apple"),"\nyou can see ",(0,r.kt)("strong",{parentName:"p"},"open"),", ",(0,r.kt)("strong",{parentName:"p"},"high"),", ",(0,r.kt)("strong",{parentName:"p"},"low"),", and ",(0,r.kt)("strong",{parentName:"p"},"close")," prices. Each represents a\ndifferent value of the stock price at a different time, and gives us an idea of\nhow the price moved throughout the day."),(0,r.kt)("p",null,"High-frequency finance is different from this as there is not one price, but two\ndifferent prices:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("strong",{parentName:"li"},"bid")," price that represents how much you will pay if you are buying."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("strong",{parentName:"li"},"ask")," price, that represents how much you will receive if you are\nselling.")),(0,r.kt)("p",null,"We can plot a small snapshot of the bid and ask prices to see how they change."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},'ticks = minimum(exampleData.timestamp):Millisecond(10):maximum(exampleData.timestamp)\ntick_labels = Dates.format.(ticks, "HH:MM:SS.sss")\n\nexamplePlot = plot(exampleData.timestamp, exampleData.bid,\n                   label = "Bid", seriestype=:steppre,\n                   markershape = :circle, markercolor = :auto,\n                   xticks = (ticks, tick_labels), legend=:bottomleft)\nexamplePlot = plot!(examplePlot, exampleData.timestamp, exampleData.ask,\n                    label = "Ask", seriestype = :steppre,\n                    markershape = :circle, markercolour = :auto)\n')),(0,r.kt)(p.Z,{alt:"Apple stock bid and ask prices plotted on a chart",height:591,src:"/img/blog/2021-11-22/example_bidask.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"In the space of 30 milliseconds, we can see 8 updates, each shown as a point on\nthis graph. There are a two things to note from this chart:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"There are irregular spacing between the updates because times at which the\nprices update are random.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"bid")," or ",(0,r.kt)("strong",{parentName:"p"},"ask")," can change independently. Both the bid and ask can\nchange when they want and not always at the same time."))),(0,r.kt)("p",null,"So why does the Yahoo daily data only refer to one price? The Yahoo data is\nignoring that you buy and sell at different prices but instead reporting the\n",(0,r.kt)("em",{parentName:"p"},"mid-price"),"."),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"mid-price")," is the average of the bid and ask and thus incorporates\nchanges in both the bid and ask price. At low-frequency levels (like Yahoo\nFinance), the difference in bid and ask is so small it doesn't make a\ndifference. But at a high-frequency level, you need to be aware of how it is\ncalculated and how changes based on the bid and ask price changes."),(0,r.kt)("p",null,"We can add the mid-price into the above plot and again note some interesting\nresults."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},'exampleData = @transform(exampleData, mid = (:ask .+ :bid) /2)\n\nplot!(examplePlot, exampleData.timestamp, exampleData.mid, label = "Mid",\n      seriestype = :steppre, linecolour = :auto)\n')),(0,r.kt)(p.Z,{alt:"Apple stock bid, ask, and mid price plotted on a chart",height:591,src:"/img/blog/2021-11-22/example_bidask_mid.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"In this short window of time, we now have three unique mid prices, but only two\nactual prices you can trade at. At ",(0,r.kt)("inlineCode",{parentName:"p"},"08:50:54.052"),", the mid-price drops because\nof the drop in the bid price. The ask price remained the same for another 6\nupdates."),(0,r.kt)("p",null,"The mid-price responds to changes in both the bid and ask and can obscure what\nis happening behind the data. The mid-price might change, but that doesn't mean\nboth the price you buy and sell at has changed."),(0,r.kt)("p",null,"Low-frequency historical data (like Yahoo finance) is good for a general sign of\nthe stock price, but ultimately, the underlying data is different. There is a\nwhole world of interaction behind those ",(0,r.kt)("strong",{parentName:"p"},"high"),", ",(0,r.kt)("strong",{parentName:"p"},"low"),", ",(0,r.kt)("strong",{parentName:"p"},"open"),", and\n",(0,r.kt)("strong",{parentName:"p"},"close")," prices. Hopefully, this has piqued your interest and you can see why\nwe need to the specific term ",(0,r.kt)("em",{parentName:"p"},"high-frequency finance")," to study this new type of\ndata."),(0,r.kt)("p",null,"Now, I'm making a song and dance how the mid-price doesn't exist and there isn't\none singular price at each time, but we find in most cases the mid-price is good\nenough for the type of analysis we are about to do. Now by using our original\ntable ",(0,r.kt)("inlineCode",{parentName:"p"},"coinbase_bbo")," we need to add in the mid-price. We need to create a new\ntable with this calculated variable."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia",metastring:'title="Creating a mid price table in QuestDB"',title:'"Creating',a:!0,mid:!0,price:!0,table:!0,in:!0,'QuestDB"':!0},'execute(conn,\n"\nCREATE TABLE mid_table\nAS(\n    SELECT timestamp, ask, asksize, bid, bidsize,\n    (ask + bid) / 2 as mid,\n    (asksize * ask + bidsize * bid) /(asksize + bidsize) as wmid\n    FROM coinbase_bbo)\n")\n')),(0,r.kt)("p",null,"This is still the same number of rows though, as we want to aggregate the\nmid-price to one-second intervals by taking the average value in that bucket. We\nare losing the 'irregularity' of high-frequency data, but as we saw in the\nexample graph, 1 second is still a high enough fidelity to see some interesting\nthings."),(0,r.kt)("p",null,"This is where we use the ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE BY")," function of QuestDB. This allows you to\nchoose a period of time and aggregate the data into a bucket of that size. In\nour case ",(0,r.kt)("inlineCode",{parentName:"p"},"1s")," - so 1 second. We calculate the average mid-price over one second\nand call that column ",(0,r.kt)("inlineCode",{parentName:"p"},"avg_mid"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia",metastring:'title="Sample by one second aggregates"',title:'"Sample',by:!0,one:!0,second:!0,'aggregates"':!0},'bbo = execute(conn,\n    "SELECT timestamp,\n    avg(mid) as mid_avg FROM mid_table\n    SAMPLE BY 1s") |> DataFrame\ndropmissing!(bbo);\n')),(0,r.kt)(p.Z,{alt:"Plot showing high-frequency mid-price of Apple stock over 18 hours",height:591,src:"/img/blog/2021-11-22/example_mid_all.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"Here we have plotted the high-frequency mid-price over our entire dataset.\nDistinctly different from the historical Yahoo finance data as we have roughly\n100,000 rows covering around 18 hours. It is this mid-price at every second that\nwe will use to continue our exploration of high-frequency finance."),(0,r.kt)("h2",{id:"introduction-to-financial-returns"},"Introduction to financial returns"),(0,r.kt)("p",null,"So we have our aggregated price but we need to perform another transformation\nbefore we can continue our analysis. When we look at our mid-price plot we see\nthat it goes through different levels."),(0,r.kt)("p",null,"Early on the price is below $34,000 before increasing to\n$34,750; we need to know\nwhat time of day it is to understand what level the price is. This means that it\nis not stationary, so to overcome this issue, we need to transform the mid-price\ninto something stationary (or at least ",(0,r.kt)("em",{parentName:"p"},"more")," stationary) which is where the\nconcept of returns arrives."),(0,r.kt)("p",null,"The return over each period is the percentage change"),(0,r.kt)("div",{className:"math math-display"},(0,r.kt)("span",{parentName:"div",className:"katex-display"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"r"),(0,r.kt)("mi",{parentName:"msub"},"t")),(0,r.kt)("mo",{parentName:"mrow"},"="),(0,r.kt)("mfrac",{parentName:"mrow"},(0,r.kt)("mrow",{parentName:"mfrac"},(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mi",{parentName:"msub"},"t")),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mrow",{parentName:"msub"},(0,r.kt)("mi",{parentName:"mrow"},"t"),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mn",{parentName:"mrow"},"1")))),(0,r.kt)("msub",{parentName:"mfrac"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mrow",{parentName:"msub"},(0,r.kt)("mi",{parentName:"mrow"},"t"),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mn",{parentName:"mrow"},"1")))),(0,r.kt)("mo",{parentName:"mrow",separator:"true"},",")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"r_t = \\frac{p_{t} - p_{t-1}}{p_{t-1}},")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.58056em",verticalAlign:"-0.15em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.2805559999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"-0.02778em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.15em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,r.kt)("span",{parentName:"span",className:"mrel"},"="),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"2.154661em",verticalAlign:"-0.894331em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mopen nulldelimiter"}),(0,r.kt)("span",{parentName:"span",className:"mfrac"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"1.26033em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.3139999999999996em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.301108em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t"),(0,r.kt)("span",{parentName:"span",className:"mbin mtight"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"1"))))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.208331em"}},(0,r.kt)("span",{parentName:"span"})))))))),(0,r.kt)("span",{parentName:"span",style:{top:"-3.23em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"frac-line",style:{borderBottomWidth:"0.04em"}})),(0,r.kt)("span",{parentName:"span",style:{top:"-3.677em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.2805559999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t"))))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.15em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.301108em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t"),(0,r.kt)("span",{parentName:"span",className:"mbin mtight"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"1"))))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.208331em"}},(0,r.kt)("span",{parentName:"span"}))))))))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.894331em"}},(0,r.kt)("span",{parentName:"span"}))))),(0,r.kt)("span",{parentName:"span",className:"mclose nulldelimiter"})),(0,r.kt)("span",{parentName:"span",className:"mpunct"},",")))))),(0,r.kt)("p",null,"which we translate into Julia code as:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},"returns = [(bbo.mid_avg[i] - bbo.mid_avg[i-1]) / bbo.mid_avg[i-1] for i in 2:nrow(bbo)]\nbbo = @transform(bbo, returns = [NaN; returns])\n")),(0,r.kt)("p",null,"As each row represents one second, this is the one-second return time series.\nWhen we plot the first 10 minutes of 1-second returns we see that it is more\nstable than the mid-price."),(0,r.kt)(p.Z,{alt:"Plot showing high-frequency returns of Apple stock",height:591,src:"/img/blog/2021-11-22/returns.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"Unlike the price, there is no obvious level at which the returns are hovering.\nThe average is around zero and with periods of positive and negative returns.\nNow it is more conventional to work in ",(0,r.kt)("em",{parentName:"p"},"log-returns")," which is the logarithm of\nthe above formula, which we write as a simple equation:"),(0,r.kt)("div",{className:"math math-display"},(0,r.kt)("span",{parentName:"div",className:"katex-display"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mi",{parentName:"mrow"},"log"),(0,r.kt)("mo",{parentName:"mrow"},"\u2061"),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"r"),(0,r.kt)("mi",{parentName:"msub"},"t")),(0,r.kt)("mo",{parentName:"mrow"},"="),(0,r.kt)("mi",{parentName:"mrow"},"log"),(0,r.kt)("mo",{parentName:"mrow"},"\u2061"),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mi",{parentName:"msub"},"t")),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mi",{parentName:"mrow"},"log"),(0,r.kt)("mo",{parentName:"mrow"},"\u2061"),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mrow",{parentName:"msub"},(0,r.kt)("mi",{parentName:"mrow"},"t"),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mn",{parentName:"mrow"},"1"))),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,r.kt)("mo",{parentName:"mrow",separator:"true"},",")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\log r_t = \\log (p_t) - \\log({p_{t-1}}),")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8888799999999999em",verticalAlign:"-0.19444em"}}),(0,r.kt)("span",{parentName:"span",className:"mop"},"lo",(0,r.kt)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.16666666666666666em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.2805559999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"-0.02778em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.15em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,r.kt)("span",{parentName:"span",className:"mrel"},"="),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,r.kt)("span",{parentName:"span",className:"mop"},"lo",(0,r.kt)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,r.kt)("span",{parentName:"span",className:"mopen"},"("),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.2805559999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.15em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mclose"},")"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,r.kt)("span",{parentName:"span",className:"mop"},"lo",(0,r.kt)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,r.kt)("span",{parentName:"span",className:"mopen"},"("),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.301108em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"t"),(0,r.kt)("span",{parentName:"span",className:"mbin mtight"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"1"))))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.208331em"}},(0,r.kt)("span",{parentName:"span"}))))))),(0,r.kt)("span",{parentName:"span",className:"mclose"},")"),(0,r.kt)("span",{parentName:"span",className:"mpunct"},",")))))),(0,r.kt)("p",null,"Again, when translated to Julia code is even simpler:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},"bbo = @transform(bbo, logreturns = [NaN; diff(log.(:mid_avg))])\n")),(0,r.kt)("p",null,"It is conventional to work in log-returns as you can add them across time\nperiods to arrive at the total return. With simple returns, you have to multiply\neach period. But, at such small time frames (in our case one second intervals)\nsmall return values the log-returns are similar to the simple returns, so in\ntruth it doesn't matter much. The distribution of log-returns has a reassuringly\nnice distribution:"),(0,r.kt)(p.Z,{alt:"Plot showing log-returns returns of Apple stock showing the fat tail phenomemon",height:591,src:"/img/blog/2021-11-22/returnHist.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"We can immediately pull out some key features."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The center of the distribution is zero, or close enough.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The average looks constant throughout the day and indicates some degree of\nstationarity in the log-returns.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Large values occur but they are rare."))),(0,r.kt)("p",null,"This is the ",(0,r.kt)("strong",{parentName:"p"},"fat tail")," phenomenon where the tails of a probability\ndistribution is larger than you expect and thus extreme values happen more\nregularly than typical probability distributions would describe. Most of the\nvalues are between ",(0,r.kt)("span",{parentName:"p",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mo",{parentName:"mrow"},"\xb1")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\pm")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.66666em",verticalAlign:"-0.08333em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"\xb1")))))," 0.0005, but values of 0.001 (so twice as large) did\nhappen."),(0,r.kt)("p",null,"These large tails are a defining feature of finance and not restricted to\nhigh-frequency data. There are many examples where an extreme event has rippled\nthrough the financial system,\n",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Black_Monday_(1987)"},"Black Monday (19/10/1987)"),"\nsaw the Dow Jones Industrial Average fall by 22%, before that the largest ever\ndecrease was in 1929 at 12%, so quite the difference in returns."),(0,r.kt)("p",null,"We can quantify this heavy tail behaviour with some statistics. The ",(0,r.kt)("strong",{parentName:"p"},"kurtosis"),"\nof a distribution describes the tail behaviour, with a value less than 3\nindicating 'thin tails' and thus fewer outliers or large events than the normal\ndistribution. A kurtosis value of greater than 3 indicates 'fat tails' and as\nyou guessed, more likely to generate outliers. 3 is the magic number as this is\nthe kurtosis of the normal distribution, so the excess kurtosis is the kurtosis\nminus three."),(0,r.kt)("p",null,"Let's calculate the mean, standard deviation, and excess kurtosis on our log\nreturns. In Julia, we use the ",(0,r.kt)("inlineCode",{parentName:"p"},"mean"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"std"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"kurtosis")," function from the\n",(0,r.kt)("inlineCode",{parentName:"p"},"Statistics")," library."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Statistic"),(0,r.kt)("th",{parentName:"tr",align:null},"Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Mean"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("span",{parentName:"td",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mn",{parentName:"mrow"},"7"),(0,r.kt)("mo",{parentName:"mrow"},"\xd7"),(0,r.kt)("mn",{parentName:"mrow"},"1"),(0,r.kt)("msup",{parentName:"mrow"},(0,r.kt)("mn",{parentName:"msup"},"0"),(0,r.kt)("mrow",{parentName:"msup"},(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mn",{parentName:"mrow"},"8")))),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"7 \\times 10 ^{-8}")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.72777em",verticalAlign:"-0.08333em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8141079999999999em",verticalAlign:"0em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"1"),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},"0"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.8141079999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"8"))))))))))))))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Standard Deviation"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("span",{parentName:"td",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mn",{parentName:"mrow"},"7"),(0,r.kt)("mo",{parentName:"mrow"},"\xd7"),(0,r.kt)("mn",{parentName:"mrow"},"1"),(0,r.kt)("msup",{parentName:"mrow"},(0,r.kt)("mn",{parentName:"msup"},"0"),(0,r.kt)("mrow",{parentName:"msup"},(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mn",{parentName:"mrow"},"5")))),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"7 \\times 10 ^{-5}")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.72777em",verticalAlign:"-0.08333em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8141079999999999em",verticalAlign:"0em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"1"),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},"0"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.8141079999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"5"))))))))))))))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Excess Kurtosis"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("span",{parentName:"td",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mn",{parentName:"mrow"},"15")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"15")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.64444em",verticalAlign:"0em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"1"),(0,r.kt)("span",{parentName:"span",className:"mord"},"5"))))))))),(0,r.kt)("p",null,"With a large excess kurtosis of 15, as we expected, this is proof that these\nlog-returns are heavy-tailed. Large events are more likely to happen than we\nwould think."),(0,r.kt)("h2",{id:"correlation-and-time-series-autocorrelation"},"Correlation and time series autocorrelation"),(0,r.kt)("p",null,"So far, we've transformed the prices into returns so that we are looking at a\nstationary time series. We investigated what the distribution of this time\nseries looked like and found that its average was close to zero and it had a\nlarge excess kurtosis and thus is fat-tailed."),(0,r.kt)("p",null,"Now we want to look at the correlation between these returns and see what we can\nlearn from this type of analysis. When we talk about correlation we mean\n",(0,r.kt)("em",{parentName:"p"},"autocorrelation")," which is the correlation between each value and values further\non in the time series."),(0,r.kt)("p",null,"We calculate the correlation between every value and the next value to arrive at\nthe 'lag 1 correlation', we then calculate the correlation between every value\nand the second next value to give us the 'lag 2 correlation'. We can keep on\ngoing for as many lags as we like to produce an autocorrelation plot."),(0,r.kt)("p",null,"Actually calculating the autocorrelation is hidden behind the ",(0,r.kt)("inlineCode",{parentName:"p"},"autocor")," function\nin Julia:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},'acf = autocor(bbo.logreturns[2:end])\n\nplot(acf[2:end], seriestype=:scatter, label = "Autocorrelation",\n     xlabel="Lag", ylabel = "Correlation")\nhline!(return_acf, [-1, 1] .* 1/sqrt(nrow(bbo) - 1),\n       label = "Confidence")\n')),(0,r.kt)(p.Z,{alt:"Plotting time series autocorrelation and confidence over lag.",height:591,src:"/img/blog/2021-11-22/return_acf.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"Here we have calculated the autocorrelation plot on the Bitcoin log-returns and\nat the smaller lags, there is some statistical significance. At lag 1, the value\nof about 0.35 shows that a large return is likely followed by another large\nreturn of the same sign, so positive returns follow positive returns and\nlikewise for negative."),(0,r.kt)("p",null,"There is a slight negative correlation at lags 3, 4, and 5 which indicates that\nafter the initial log-return there is some indication of mean reversion, i.e.\nreturns of the opposite sign. All very interesting and shows that there is some\nslight predictability in the return pattern and after every log-return, we have\na reasonable idea of what the next few log-returns might look like."),(0,r.kt)("p",null,"Once we go beyond 10 lags though there is no statistical significance, which\nsuggests that each log-return has a short lifespan and disrupts the market for\nless than 10 seconds."),(0,r.kt)("p",null,"We can also look at the autocorrelation on the absolute returns, so by stripping\nout the sign of the returns is there a change in the correlation structure?"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},"acf = autocor(abs.(bbo.logreturns[2:end]))\n")),(0,r.kt)(p.Z,{alt:"Plotting absolute time series autocorrelation and confidence over lag.",height:591,src:"/img/blog/2021-11-22/return_abs_acf.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"Now things take an interesting turn. All lags are significant and more so that\nthey are positive. This indicates that large values follow large values of\neither sign, so a large positive log-return is likely to be followed by a\nsimilar large log-return of either positive or negative. This effect slowly\ndecays and lasts for a long time."),(0,r.kt)("p",null,"When we take logs of both the axis we see the following straight line"),(0,r.kt)(p.Z,{alt:"Plotting log of correlation and confidence over log of lag.",height:591,src:"/img/blog/2021-11-22/return_abs_acf_log.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"which indicates that the autocorrelation of the absolute returns follows a power\nlaw;"),(0,r.kt)("div",{className:"math math-display"},(0,r.kt)("span",{parentName:"div",className:"katex-display"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mtext",{parentName:"mrow"},"Autocorrelation"),(0,r.kt)("mo",{parentName:"mrow"},"\u221d"),(0,r.kt)("mfrac",{parentName:"mrow"},(0,r.kt)("mn",{parentName:"mfrac"},"1"),(0,r.kt)("msup",{parentName:"mfrac"},(0,r.kt)("mtext",{parentName:"msup"},"Lag"),(0,r.kt)("mi",{parentName:"msup"},"\u03b3"))),(0,r.kt)("mo",{parentName:"mrow",separator:"true"},",")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\text{Autocorrelation} \\propto \\frac{1}{\\text{Lag} ^\\gamma},")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.69444em",verticalAlign:"0em"}}),(0,r.kt)("span",{parentName:"span",className:"mord text"},(0,r.kt)("span",{parentName:"span",className:"mord"},"Autocorrelation")),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,r.kt)("span",{parentName:"span",className:"mrel"},"\u221d"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"2.20188em",verticalAlign:"-0.8804400000000001em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mopen nulldelimiter"}),(0,r.kt)("span",{parentName:"span",className:"mfrac"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"1.32144em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.314em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord text"},(0,r.kt)("span",{parentName:"span",className:"mord"},"Lag")),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.737622em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-3.1362300000000003em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.05556em"}},"\u03b3")))))))))),(0,r.kt)("span",{parentName:"span",style:{top:"-3.23em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"frac-line",style:{borderBottomWidth:"0.04em"}})),(0,r.kt)("span",{parentName:"span",style:{top:"-3.677em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},"1")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.8804400000000001em"}},(0,r.kt)("span",{parentName:"span"}))))),(0,r.kt)("span",{parentName:"span",className:"mclose nulldelimiter"})),(0,r.kt)("span",{parentName:"span",className:"mpunct"},",")))))),(0,r.kt)("p",null,"and power-law distributions are fat-tailed. So what we discovered about the\ndistribution of the returns is also true for the autocorrelation, outliers are\nexpected. Furthermore, this shows that there is long-term memory over time, the\nnotion that large returns lead to other large returns persists in the market for\na long time."),(0,r.kt)("p",null,"Here it is 50 lags (so 50 seconds) but the power-law indicates that it will\ncontinue for a long time. This all points to the presence of ",(0,r.kt)("em",{parentName:"p"},"regimes")," where\nthere are periods of large returns and likewise, periods of small returns. This\ngives a semblance of predictability, at least at the high-frequency level but\nalso shows how similar sizes of returns are grouped."),(0,r.kt)("p",null,"This is where we can start to think about volatility, or how the variation of\nreturns changes. This correlation of absolute returns shows that the underlying\nvolatility (or variation) in returns is not stationary."),(0,r.kt)("p",null,"The study of volatility of returns is a whole theme in itself and we will look\nat calculating volatility at a later date. This is where we come to a close with\nlooking at high-frequency prices and move onto high-frequency trades."),(0,r.kt)("h2",{id:"analyzing-crypto-trades-and-using-empirical-price-impact"},"Analyzing crypto trades and using empirical price impact"),(0,r.kt)("p",null,"When people buy or sell some Bitcoin at Coinbase it is recorded and broadcasted,\nand I've shown you how to store this data in the previous tutorial. This data is\nuseful for looking at irregularly-spaced events as each trade occurs at a random\ntime. This satisfies our condition for the high-frequency data classification."),(0,r.kt)("p",null,"Trades also happen at an extraordinary rate; in our sample, we have over 200k\ntrades in the same period of the tick data above (18 hours). We are interested\nin the price of each trade, whether it was a buy or sell, and finally what time\nit happened. This is easy to extract from our QuestDB database:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},'@time trades = execute(conn,\n"SELECT timestamp, price, size, side FROM coinbase_trades") |> DataFrame\ndropmissing!(trades);\n')),(0,r.kt)("p",null,"Recorded trades represent the actual price at which some Bitcoin has changed\nhands and is more tangible than our previous dataset which was ",(0,r.kt)("em",{parentName:"p"},"indications"),"\nwhere people might buy or sell Bitcoin. If you are buying or selling Bitcoin,\nyou want to make sure you get the best possible price."),(0,r.kt)("p",null,"This is quite an open-ended problem that is fraught with difficulty in deciding\nwhat means 'best'. A simple method of judging though is comparing the price you\npaid with the price of the next trade. But why stop at the next trade, you can\nlook at the next ",(0,r.kt)("span",{parentName:"p",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mi",{parentName:"mrow"},"l")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"l")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.69444em",verticalAlign:"0em"}}),(0,r.kt)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.01968em"}},"l")))))," trades to understand how the price evolved after each\ntrade."),(0,r.kt)("p",null,"This leads us to calculate the ",(0,r.kt)("strong",{parentName:"p"},"empirical price impact")," function, which\naverages the impact at each lag to build up an empirical picture of price\nevolution over time. As an equation, we are taking an average over the different\nlags of the trades data frame."),(0,r.kt)("div",{className:"math math-display"},(0,r.kt)("span",{parentName:"div",className:"katex-display"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mi",{parentName:"mrow"},"R"),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,r.kt)("mi",{parentName:"mrow"},"l"),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,r.kt)("mo",{parentName:"mrow"},"="),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mfrac",{parentName:"mrow"},(0,r.kt)("mn",{parentName:"mfrac"},"1"),(0,r.kt)("mi",{parentName:"mfrac"},"n")),(0,r.kt)("munderover",{parentName:"mrow"},(0,r.kt)("mo",{parentName:"munderover"},"\u2211"),(0,r.kt)("mrow",{parentName:"munderover"},(0,r.kt)("mi",{parentName:"mrow"},"k"),(0,r.kt)("mo",{parentName:"mrow"},"="),(0,r.kt)("mn",{parentName:"mrow"},"1")),(0,r.kt)("mi",{parentName:"munderover"},"n")),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"\u03f5"),(0,r.kt)("mi",{parentName:"msub"},"k")),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mrow",{parentName:"msub"},(0,r.kt)("mi",{parentName:"mrow"},"k"),(0,r.kt)("mo",{parentName:"mrow"},"+"),(0,r.kt)("mi",{parentName:"mrow"},"l"))),(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("msub",{parentName:"mrow"},(0,r.kt)("mi",{parentName:"msub"},"p"),(0,r.kt)("mi",{parentName:"msub"},"k")),(0,r.kt)("mo",{parentName:"mrow",stretchy:"false"},")")),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"R(l) = - \\frac{1}{n} \\sum _{k=1} ^n \\epsilon _k (p_{k+l} - p_k)")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,r.kt)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.00773em"}},"R"),(0,r.kt)("span",{parentName:"span",className:"mopen"},"("),(0,r.kt)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.01968em"}},"l"),(0,r.kt)("span",{parentName:"span",className:"mclose"},")"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,r.kt)("span",{parentName:"span",className:"mrel"},"="),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"2.9535100000000005em",verticalAlign:"-1.302113em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mopen nulldelimiter"}),(0,r.kt)("span",{parentName:"span",className:"mfrac"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"1.32144em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.314em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"n"))),(0,r.kt)("span",{parentName:"span",style:{top:"-3.23em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"frac-line",style:{borderBottomWidth:"0.04em"}})),(0,r.kt)("span",{parentName:"span",style:{top:"-3.677em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},"1")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.686em"}},(0,r.kt)("span",{parentName:"span"}))))),(0,r.kt)("span",{parentName:"span",className:"mclose nulldelimiter"})),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.16666666666666666em"}}),(0,r.kt)("span",{parentName:"span",className:"mop op-limits"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"1.6513970000000002em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-1.8478869999999998em",marginLeft:"0em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3.05em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03148em"}},"k"),(0,r.kt)("span",{parentName:"span",className:"mrel mtight"},"="),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"1")))),(0,r.kt)("span",{parentName:"span",style:{top:"-3.0500049999999996em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3.05em"}}),(0,r.kt)("span",{parentName:"span"},(0,r.kt)("span",{parentName:"span",className:"mop op-symbol large-op"},"\u2211"))),(0,r.kt)("span",{parentName:"span",style:{top:"-4.300005em",marginLeft:"0em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3.05em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight"},"n")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"1.302113em"}},(0,r.kt)("span",{parentName:"span"}))))),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.16666666666666666em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"\u03f5"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.33610799999999996em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03148em"}},"k")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.15em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mopen"},"("),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.3361079999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03148em"}},"k"),(0,r.kt)("span",{parentName:"span",className:"mbin mtight"},"+"),(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.01968em"}},"l"))))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.208331em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.33610799999999996em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-2.5500000000000003em",marginLeft:"0em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03148em"}},"k")))),(0,r.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.15em"}},(0,r.kt)("span",{parentName:"span"})))))),(0,r.kt)("span",{parentName:"span",className:"mclose"},")")))))),(0,r.kt)("p",null,"As this is an empirical measure, we are also going to classify the size of the\ntrades into ",(0,r.kt)("strong",{parentName:"p"},"small"),", ",(0,r.kt)("strong",{parentName:"p"},"medium"),", and ",(0,r.kt)("strong",{parentName:"p"},"large")," using the quantiles of the\ntrade size. We will see how the price impact functions change based on trade\nsize. Ultimately, we expect larger trades to have a greater price impact and\nthis to reflect in the price impact function."),(0,r.kt)("p",null,"This all comes down to supply and demand; a larger trade disrupts the balance of\nsupply and demand more than the smaller trades and thus its effects will be felt\nfor longer. To calculate this price impact in Julia we first add a log price to\nthe trades dataframe:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},"trades = @transform(trades, logprice = log.(:price))\n")),(0,r.kt)("p",null,"We now calculate the boundaries for our trade size classification."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},'sizeF = cut(trades.size, quantile(unique(trades.size), 0:(1/3):1), extend = true, labels = ["Small", "Medium", "Large"])\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Small trades:")," < 0.0028 which is about ","$","95"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Medium trades:")," > 0.0028 but < 0.014"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Large trades:")," > 0.014, about ","$","480")),(0,r.kt)("p",null,"And now we can calculate the log returns between the trades at different lags.\nWe are going to look at a maximum of 2500 lags."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},"r_diffs = [-1 .* trades.side .* (lag(trades.logprice, k) - trades.logprice) for k in 1:2500]\nlagframe = DataFrame(hcat(r_diffs...), :auto)\nlagframe[!, :SizeGroup] = sizeF\ndropmissing!(lagframe);\n")),(0,r.kt)("p",null,"Before finally converting it from a wide format to a long format using ",(0,r.kt)("inlineCode",{parentName:"p"},"stack"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},"lagFrameTidy = stack(lagframe, 1:2500);\n\ngdata = groupby(lagFrameTidy, [:SizeGroup, :variable])\nsdata = combine(gdata, :value => mean, :value => std, :value => length)\nsdata[!, :lag] = parse.(Int64, chop.(sdata.variable, head = 1, tail = 0))\n")),(0,r.kt)("p",null,"We plot the log-return against the lag and again, we see a power law:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-julia"},'plot(sdata.lag, sdata.value_mean,\n     group = sdata.SizeGroup,\n     ribbon = 1.96 .* sdata.value_std ./ sqrt.(sdata.value_length),\n     xlabel = "Lag", ylabel = "Impact", legend=:bottomright)\n')),(0,r.kt)(p.Z,{alt:"Plotting log-return against lag to reveal a power-law.",height:591,src:"/img/blog/2021-11-22/impact.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"Importantly, we can see the confirmation of our hypothesis, larger trades have a\ngreater impact on future trades and likewise, smaller trades have the least\nimpact."),(0,r.kt)("p",null,"We've added the standard error on the calculation of the impact and glad to see\nit grow over time, as there is more variation at larger lags. If we zoom into 20\nlags we can see this price impact effect even clearer:"),(0,r.kt)(p.Z,{alt:"Plotting log-return against lag to reveal a power-law with a standard error.",height:591,src:"/img/blog/2021-11-22/impact_sub.png",width:650,mdxType:"Screenshot"}),(0,r.kt)("p",null,"The first price difference is similar for all three trade types, around\n",(0,r.kt)("span",{parentName:"p",className:"math math-inline"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mn",{parentName:"mrow"},"1"),(0,r.kt)("mo",{parentName:"mrow"},"\xd7"),(0,r.kt)("mn",{parentName:"mrow"},"1"),(0,r.kt)("msup",{parentName:"mrow"},(0,r.kt)("mn",{parentName:"msup"},"0"),(0,r.kt)("mrow",{parentName:"msup"},(0,r.kt)("mo",{parentName:"mrow"},"\u2212"),(0,r.kt)("mn",{parentName:"mrow"},"5")))),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"1 \\times 10^{-5}")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.72777em",verticalAlign:"-0.08333em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"1"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8141079999999999em",verticalAlign:"0em"}}),(0,r.kt)("span",{parentName:"span",className:"mord"},"1"),(0,r.kt)("span",{parentName:"span",className:"mord"},(0,r.kt)("span",{parentName:"span",className:"mord"},"0"),(0,r.kt)("span",{parentName:"span",className:"msupsub"},(0,r.kt)("span",{parentName:"span",className:"vlist-t"},(0,r.kt)("span",{parentName:"span",className:"vlist-r"},(0,r.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.8141079999999999em"}},(0,r.kt)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,r.kt)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,r.kt)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"\u2212"),(0,r.kt)("span",{parentName:"span",className:"mord mtight"},"5"))))))))))))),", but 5 trades later, the price difference is starkly\ndifferent, the large trade has had much more market impact. The large trades\nhave caused the price to move that much more."),(0,r.kt)("p",null,"This is all empirical evidence, we have taken the data presented to us and\nmanaged to prove that trading large amounts is more likely to move the price\nthan a smaller trade amount. Again, as this is high-frequency the average\ntimescales are small, the average time difference between trades is 500ms and\nthe median is 154ms but very relevant for anyone making lots of trades, knowing\nthat the larger ones will be pushing the price more."),(0,r.kt)("h2",{id:"what-we-learned-about-high-frequency-finance"},"What we learned about high-frequency finance"),(0,r.kt)("p",null,"That concludes our whistle-stop tour of different aspects of high-frequency\nfinance. Hopefully, I have convinced you why this type of data is different from\nyour typical daily data and how there are all sorts of interesting phenomena\nunderneath the surface."),(0,r.kt)("p",null,"I've highlighted the two prices, the ",(0,r.kt)("strong",{parentName:"p"},"bid")," and the ",(0,r.kt)("strong",{parentName:"p"},"ask"),", plus how we\ncombine them to form the ",(0,r.kt)("strong",{parentName:"p"},"mid-price"),". We've then seen how this mid-price is\nnot stationary and instead converted it to ",(0,r.kt)("strong",{parentName:"p"},"returns")," and then log-returns\nwhich is a stationary time series."),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"log-returns")," are distributed with a mean close to zero but an excess\nkurtosis of 16, which showed the distribution is very heavy-tailed. Extreme\nreturns, both positive and negative will happen much more frequently than\ntypically expected."),(0,r.kt)("p",null,"We took a look at the ",(0,r.kt)("strong",{parentName:"p"},"correlations")," in this log-returns time series to\nunderstand how the different changes integrate through the returns. We found a\npositive correlation at short lags that flipped to a negative correlation after\nroughly 5 seconds. The correlation was no longer statistically significant at\nlarger larges."),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"autocorrelation")," of the absolute returns show strong correlations at all\nlags and it decayed like a power law. This was another example of heavy tails in\nhigh-frequency finance with more consequences. The fact that the correlations\npersist in the absolute returns for a long time shows how the log-returns go\nthrough periods of regimes. These regimes are periods where large moves, both\npositive and negative, are common and likewise, other regimes where small\nreturns happen. Despite the log-returns appearing stationary, we now know that\nthe underlying volatility is not stationary."),(0,r.kt)("p",null,"We then turned our analysis to high-frequency trades. These are now irregularly\nspaced and represent the tangible exchange of Bitcoin for US dollars. Here we\nexamined the ",(0,r.kt)("strong",{parentName:"p"},"price impact")," of each trade by comparing the traded price to\nfuture trade prices, which gives an idea of how each trade affects the price of\nfuture trades. We created three categories of trades, small, medium, and large\nbased on the size of the trade and calculated the empirical impact function. We\nfound that large trades cause the most impact, as expected and that it is a\nsizeable difference to the other two categories."),(0,r.kt)("p",null,"Overall, there are many facets to high-frequency finance with different ways to\napproach analyzing the data. Open-source tools like QuestDB provide an easy way\nto store this information and help you focus on the analysis rather than\nworrying about data."),(0,r.kt)("hr",null),(0,r.kt)("p",null,"If you like this content, check out the\n",(0,r.kt)("a",{parentName:"p",href:"/blog/2021/09/17/high-frequency-finance-julia-lang"},"previous post on Julia and QuestDB"),"\nand ",(0,r.kt)("a",{parentName:"p",href:"https://dm13450.github.io/about/"},"Dean's personal blog"),". We'd love to know\nyour thoughts on this content, so feel free to share your feedback or simply\ncome and say hello in the ",(0,r.kt)("a",{parentName:"p",href:"https://"},"QuestDB Community Slack"),"."))}N.isMDXComponent=!0},86010:function(a,e,t){function n(a){var e,t,s="";if("string"==typeof a||"number"==typeof a)s+=a;else if("object"==typeof a)if(Array.isArray(a))for(e=0;e<a.length;e++)a[e]&&(t=n(a[e]))&&(s&&(s+=" "),s+=t);else for(e in a)a[e]&&(s&&(s+=" "),s+=e);return s}function s(){for(var a,e,t=0,s="";t<arguments.length;)(a=arguments[t++])&&(e=n(a))&&(s&&(s+=" "),s+=e);return s}t.d(e,{Z:function(){return s}})}}]);