"use strict";(self.webpackChunkquestdb_io=self.webpackChunkquestdb_io||[]).push([[5958],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return c}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=d(n),c=o,h=p["".concat(l,".").concat(c)]||p[c]||m[c]||r;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function c(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},48958:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},metadata:function(){return d},toc:function(){return u},default:function(){return p}});var a=n(83117),o=n(80102),r=(n(67294),n(3905)),i=n(46092),s=["components"],l={title:"My journey making QuestDB",author:"Vlad Ilyushchenko",author_title:"QuestDB Team",author_url:"https://github.com/bluestreak01",author_image_url:"https://avatars.githubusercontent.com/bluestreak01",description:"The detailed story of how the open source time series database QuestDB came to life.",keywords:["hackernews","story","startup","founder","cto","timeseries","database","ycombinator","open source"],image:"/img/blog/2020-08-06/banner.jpg",tags:["company","entrepreneurship","engineering","hackernews","startup"]},d={permalink:"/blog/2020/08/06/my-journey-writing-questdb",source:"@site/blog/2020-08-06-my-journey-writing-questdb.md",title:"My journey making QuestDB",description:"The detailed story of how the open source time series database QuestDB came to life.",date:"2020-08-06T00:00:00.000Z",formattedDate:"August 6, 2020",tags:[{label:"company",permalink:"/blog/tags/company"},{label:"entrepreneurship",permalink:"/blog/tags/entrepreneurship"},{label:"engineering",permalink:"/blog/tags/engineering"},{label:"hackernews",permalink:"/blog/tags/hackernews"},{label:"startup",permalink:"/blog/tags/startup"}],readingTime:5.51,truncated:!0,prevItem:{title:"Re-examining our approach to memory mapping",permalink:"/blog/2020/08/19/memory-mapping-deep-dive"},nextItem:{title:"QuestDB swag for our community members!",permalink:"/blog/2020/07/24/use-questdb-for-swag"}},u=[{value:"How I started building an open source time series database",id:"how-i-started-building-an-open-source-time-series-database",children:[]},{value:"Turning an open source idea into a full-time project",id:"turning-an-open-source-idea-into-a-full-time-project",children:[]},{value:"Learning important lessons from mistakes",id:"learning-important-lessons-from-mistakes",children:[]},{value:"Turning goals into a reality",id:"turning-goals-into-a-reality",children:[]}],m={toc:u};function p(e){var t=e.components,n=(0,o.Z)(e,s);return(0,r.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(i.Z,{alt:"A path going into the morning mist",height:393,src:"/img/blog/2020-08-06/banner.jpg",width:650,mdxType:"Banner"}," ","Photo by",(0,r.kt)("a",{href:"https://unsplash.com/photos/ptSJZoEjp3M"},"Wesley Tingey"),"on",(0,r.kt)("a",{href:"https://unsplash.com"},"Unsplash")," "),(0,r.kt)("p",null,"A few weeks ago, I posted\n",(0,r.kt)("a",{parentName:"p",href:"https://news.ycombinator.com/item?id=23975807"},"the story of how I started QuestDB on Hacker News"),".\nSeveral people found the story interesting, so I thought I would post it here\nand describe the passage from working at a large energy trading company,\ndiscovering memory-mapping approaches in Java, the beginnings of building the\nsystem as a side-project, and how we got to where we are today with companies\nrelying on production instances of our time-series database."),(0,r.kt)("h2",{id:"how-i-started-building-an-open-source-time-series-database"},"How I started building an open source time series database"),(0,r.kt)("p",null,"It started in 2012 when an energy trading company hired me to rebuild their\nreal-time vessel tracking system. Management wanted me to use a well-known XML\ndatabase that they had just bought a license for. This option would have\nrequired to take down production for about a week just to ingest the data. And a\nweek downtime was not an option. With no more money to spend on software, I\nturned to alternatives such as OpenTSDB but they were not a fit for our data\nmodel. There was no solution in sight to deliver the project."),(0,r.kt)("p",null,"Then, I stumbled upon\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/peter-lawrey/Java-Chronicle"},"Peter Lawrey\u2019s Java Chronicle library"),".\nIt loaded the same data in 2 minutes instead of a week using memory-mapped\nfiles. Besides the performance aspect, I found it fascinating that such a simple\nmethod was solving multiple issues simultaneously: fast write, read can happen\neven before data is committed to disk, code interacts with memory rather than IO\nfunctions, no buffers to copy. Incidentally, this was my first exposure to\nzero-GC Java."),(0,r.kt)("p",null,"But there were several issues. First, at the time It didn\u2019t look like the\nlibrary was going to be maintained. Second, it used Java NIO instead of using\nthe OS API directly. This adds overhead since it creates individual objects with\nsole purpose to hold a memory address for each memory page. Third, although the\nNIO allocation API was well documented, the release API was not. It was really\neasy to run out of memory and hard to manage memory page release. I decided to\nditch the XML DB and then started to write a custom storage engine in Java,\nsimilar to what Java Chronicle did. This engine used memory mapped files,\noff-heap memory and a custom query system for geospatial time series.\nImplementing this was a refreshing experience. I learned more in a few weeks\nthan in years on the job."),(0,r.kt)("p",null,"Throughout my career, I mostly worked at large companies where developers are\n\u201cmanaged\u201d via itemized tasks sent as tickets. There was no room for creativity\nor initiative. In fact, it was in one\u2019s best interest to follow the ticket's\nexact instructions, even if it was complete nonsense. I had just been promoted\nto a managerial role and regretted it after a week. After so much time hoping\nfor a promotion, I immediately wanted to go back to the technical side. I became\nobsessed with learning new stuff again, particularly in the high performance\nspace."),(0,r.kt)("h2",{id:"turning-an-open-source-idea-into-a-full-time-project"},"Turning an open source idea into a full-time project"),(0,r.kt)("p",null,"With some money aside, I left my job and started to work on QuestDB solo. I used\nJava and a small C layer to interact directly with the OS API without passing\nthrough a selector API. Although existing OS API wrappers would have been easier\nto get started with, the overhead increases complexity and hurts performance. I\nalso wanted the system to be completely GC-free. To do this, I had to build\noff-heap memory management myself and I could not use off-the-shelf libraries. I\nhad to rewrite many of the standard ones over the years to avoid producing any\ngarbage."),(0,r.kt)("p",null,"As I had my first kid, I had to take contracting gigs to make ends meet over the\nfollowing 6 years. All the stuff I had been learning boosted my confidence and I\nstarted performing well at interviews. This allowed me to get better paying\ncontracts, I could take fewer jobs and free up more time to work on QuestDB\nwhile looking after my family. I would do research during the day and implement\nthis into QuestDB at night. I was constantly looking for the next thing, which\nwould take performance closer to the limits of the hardware."),(0,r.kt)("h2",{id:"learning-important-lessons-from-mistakes"},"Learning important lessons from mistakes"),(0,r.kt)("p",null,"A year in, I realised that my initial design was actually flawed and that it had\nto be thrown away. It had no concept of separation between readers and writers\nand would thus allow dirty reads. Storage was not guaranteed to be contiguous,\nand pages could be of various non-64-bit-divisible sizes. It was also very much\ncache-unfriendly, forcing the use of slow row-based reads instead of fast\ncolumnar and vectorized ones. Commits were slow, and as individual column files\ncould be committed independently, they left the data open to corruption."),(0,r.kt)("p",null,"Although this was a setback, I got back to work. I wrote the new engine to allow\natomic and durable multi-column commits, provide repeatable read isolation, and\nfor commits to be instantaneous. To do this, I separated transaction files from\nthe data files. This made it possible to commit multiple columns simultaneously\nas a simple update of the last committed row id. I also made storage dense by\nremoving overlapping memory pages and writing data byte by byte over page edges."),(0,r.kt)("h2",{id:"turning-goals-into-a-reality"},"Turning goals into a reality"),(0,r.kt)("p",null,"This new approach improved query performance. It made it easy to split data\nacross worker threads and to optimise the CPU pipeline with prefetch. It\nunlocked column-based execution and additional virtual parallelism with\n",(0,r.kt)("a",{parentName:"p",href:"https://news.ycombinator.com/item?id=22803504"},"SIMD instruction sets")," thanks to\n",(0,r.kt)("a",{parentName:"p",href:"https://www.agner.org/optimize/vectorclass.pdf"},"Agner Fog\u2019s Vector Class Library"),".\nIt made it possible to implement more recent innovations like our\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/questdb/questdb/blob/master/core/src/main/c/share/rosti.h"},"own version of Google SwissTable"),".\nI published more details when we released a demo server a few weeks ago on\n",(0,r.kt)("a",{parentName:"p",href:"https://news.ycombinator.com/item?id=23616878"},"ShowHN"),". This\n",(0,r.kt)("a",{parentName:"p",href:"https://"},"demo")," is still available to try online with a pre-loaded dataset\nof 1.6 billion rows. Although it was hard and discouraging at first, this\nrewrite turned out to be the second best thing that happened to QuestDB."),(0,r.kt)("p",null,"The best thing was that people started to contribute to the project. I am really\nhumbled that Tanc and Nic left our previous employer to build QuestDB. A few\nmonths later, former colleagues of mine left their stable low-latency jobs at\nbanks to join us. I take this as a huge responsibility and I don\u2019t want to let\nthese guys down. The amount of work ahead gives me headaches and goosebumps at\nthe same time."))}p.isMDXComponent=!0},86010:function(e,t,n){function a(e){var t,n,o="";if("string"==typeof e||"number"==typeof e)o+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=a(e[t]))&&(o&&(o+=" "),o+=n);else for(t in e)e[t]&&(o&&(o+=" "),o+=t);return o}function o(){for(var e,t,n=0,o="";n<arguments.length;)(e=arguments[n++])&&(t=a(e))&&(o&&(o+=" "),o+=t);return o}n.d(t,{Z:function(){return o}})}}]);